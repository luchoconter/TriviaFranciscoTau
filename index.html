<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Trivia Francisco Tau - Mejorada</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    /* Global CSS Variables */
    :root {
      --color-primario-verde: #4CAF50;
      --color-primario-verde-claro: #66bb6a;
      --color-primario-verde-oscuro: #388E3C;
      --color-secundario-azul: #2196f3;
      --color-secundario-azul-claro: #42a5f5;
      --color-secundario-azul-oscuro: #1976D2;
      --color-error-rojo: #e53935;
      --color-error-rojo-claro: #ef5350;
      --color-texto-oscuro: #333;
      --color-texto-blanco: #fff;
      --color-fondo-overlay: rgba(255, 255, 255, 0.85); /* Slightly increased opacity for better contrast */

      --radio-borde-general: 8px;
      --radio-borde-modal: 12px;
      --radio-borde-modal-grande: 15px;

      --padding-boton: 12px 25px;
      --padding-modal: 30px;
      --padding-modal-grande: 35px 30px;

      --sombra-elemento: 0 4px 10px rgba(0, 0, 0, 0.15), 0 2px 5px rgba(0, 0, 0, 0.1);
      --sombra-elemento-hover: 0 6px 12px rgba(0, 0, 0, 0.2);
      --sombra-modal: 0 15px 40px rgba(0, 0, 0, 0.2), 0 6px 20px rgba(0, 0, 0, 0.15);
      --sombra-modal-hover: 0 8px 20px rgba(0,0,0,0.25);

      --fuente-principal: Arial, sans-serif;
      --tamano-fuente-normal: 16px;
      --tamano-fuente-boton: 17px;
      --tamano-fuente-titulo-modal: 1.8em; /* Adjusted for h2 in modals */
    }

    /* General styles for the page body */
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: var(--fuente-principal);
      font-size: var(--tamano-fuente-normal);
      background-image: url('imagenes/fondo.jpg'); /* Placeholder for background image */
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    #map {
      height: 100vh;
      width: 100%;
    }

    /* Base styles for all modal windows */
    .modal-base {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: var(--padding-modal);
      border-radius: var(--radio-borde-modal);
      z-index: 1000;
      width: 90vw;
      max-width: 450px;
      text-align: center;
      border: 1px solid rgba(0, 0, 0, 0.1); /* Subtle border */
      box-shadow: var(--sombra-modal);
      display: none; /* Hidden by default */
      animation: fadeIn 0.5s ease-out;

      /* Background with image and overlay for readability */
      background: linear-gradient(var(--color-fondo-overlay), var(--color-fondo-overlay)), url('imagenes/fondoventanas.jpg'); /* Placeholder for window background image */
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .modal-base.mostrar {
      display: block;
    }

    .modal-base h2 {
      font-size: var(--tamano-fuente-titulo-modal);
      color: var(--color-texto-oscuro);
      margin-bottom: 20px;
      font-weight: bold;
      text-shadow: 0 0 8px var(--color-texto-blanco);
    }

    .modal-base p {
      color: var(--color-texto-oscuro);
      text-shadow: 0 0 8px var(--color-texto-blanco);
      font-weight: bold; /* Maintained from original style */
      margin-bottom: 15px;
      line-height: 1.6;
    }

    /* Styles for general buttons */
    button, .button-style { /* .button-style for elements that are not buttons but should look like one */
      margin: 10px 5px; /* Margin adjustment */
      padding: var(--padding-boton);
      font-size: var(--tamano-fuente-boton);
      border-radius: var(--radio-borde-general);
      border: 1px solid rgba(0, 0, 0, 0.2); /* More subtle border */
      background: linear-gradient(135deg, var(--color-primario-verde-claro) 0%, var(--color-primario-verde) 100%);
      color: var(--color-texto-blanco);
      cursor: pointer;
      box-shadow: var(--sombra-elemento);
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease; /* Added border-color to transition */
      font-weight: 600;
      letter-spacing: 0.5px;
      text-decoration: none; /* For .button-style if it's an <a> */
      display: inline-block; /* For .button-style if it's an <a> */
      outline: none; /* Remove default outline */
    }

    button:hover, .button-style:hover {
      background: linear-gradient(135deg, var(--color-primario-verde) 0%, var(--color-primario-verde-oscuro) 100%);
      transform: translateY(-2px);
      box-shadow: var(--sombra-elemento-hover);
    }

    /* Styles for focus and active states (keyboard navigation/click feedback) */
    button:focus-visible,
    button:focus,
    button:active,
    .button-style:focus-visible,
    .button-style:focus,
    .button-style:active {
      transform: translateY(0);
      border: 3px solid var(--color-secundario-azul-claro); /* Thicker blue border */
      box-shadow: 0 0 0 2px var(--color-secundario-azul-claro), /* Blue outline effect (slightly smaller to complement border) */
                  0 3px 8px rgba(0, 0, 0, 0.25); /* Original shadow */
    }

    /* Style for buttons that should always have the blue border */
    .age-selection-button { /* New class for age selection buttons */
      border: 3px solid var(--color-secundario-azul-claro) !important; /* Force blue border */
      box-shadow: 0 0 0 2px var(--color-secundario-azul-claro), /* Blue outline effect */
                  var(--sombra-elemento) !important; /* Keep original shadow */
    }

    /* Fixed buttons */
    #botones-fijos {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 9999; /* Over the map but below highest priority modals */
      display: flex; /* Use flexbox for layout */
      flex-direction: column; /* Stack vertically */
      gap: 5px; /* Space between buttons */
    }
    #botones-fijos button {
      display: flex; /* Align icon and text */
      align-items: center;
      justify-content: center;
      padding: 10px 15px; /* Adjust padding for icons */
    }
    #botones-fijos button svg {
      width: 20px; /* Icon size */
      height: 20px;
      margin-right: 8px; /* Space between icon and text */
      fill: var(--color-texto-blanco); /* Icon color */
    }
    #botones-fijos button span {
      display: none; /* Hide text by default on small screens */
    }

    /* Progress panel */
    #panel-progreso {
      position: absolute;
      bottom: 10px;
      left: 10px;
      width: 300px;
      background: var(--color-fondo-overlay);
      border: 1px solid rgba(0,0,0,0.2);
      border-radius: var(--radio-borde-general);
      padding: 10px;
      z-index: 9999;
      box-shadow: var(--sombra-elemento);
      font-size: 14px;
      color: var(--color-texto-oscuro);
    }
    #barra-progreso {
      width: 100%;
      height: 20px;
      background-color: #e0e0e0;
      border-radius: var(--radio-borde-general);
      overflow: hidden;
      margin-bottom: 5px;
    }
    #progreso-porcentaje {
      height: 100%;
      width: 0%;
      background-color: var(--color-primario-verde);
      transition: width 0.5s ease;
    }

    /* Specific Final Window */
    #ventana-final { /* Inherits from .modal-base but with adjustments */
      max-width: 480px;
      padding: var(--padding-modal-grande);
      border-radius: var(--radio-borde-modal-grande);
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); /* Specific soft green */
      z-index: 10001; /* Above other modals */
    }
    #ventana-final h2 {
      color: var(--color-primario-verde-oscuro); /* Specific color for final title */
    }
    #ventana-final button { /* Specific close final button */
      background: linear-gradient(135deg, var(--color-secundario-azul-claro) 0%, var(--color-secundario-azul) 100%);
    }
    #ventana-final button:hover {
      background: linear-gradient(135deg, var(--color-secundario-azul) 0%, var(--color-secundario-azul-oscuro) 100%);
    }

    /* Styles for the custom modal created by JS */
    .custom-js-modal {
        position: fixed; /* Use fixed so it's always visible in viewport */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--color-texto-blanco); /* Solid white background */
        padding: var(--padding-modal);
        border-radius: var(--radio-borde-modal);
        box-shadow: var(--sombra-modal);
        z-index: 10005; /* High priority */
        text-align: center;
        max-width: 380px; /* Adjusted width */
        width: 85vw;
        color: var(--color-texto-oscuro);
    }
    .custom-js-modal h3 { /* Title for JS modal */
        font-size: 1.5em;
        color: var(--color-texto-oscuro);
        margin-bottom: 15px;
        font-weight: bold;
    }
    .custom-js-modal p { /* Message for JS modal */
        font-size: 1.1em;
        margin-bottom: 25px;
        line-height: 1.5;
        text-shadow: none; /* No shadow for better readability on white background */
        font-weight: normal; /* Normal weight for paragraph */
    }
    .custom-js-modal .modal-botones button {
        margin: 8px;
        padding: 10px 20px; /* Specific padding */
    }
    /* Specific confirmation/error buttons for JS modal */
    .custom-js-modal .boton-confirmacion {
        background: linear-gradient(135deg, var(--color-primario-verde-claro) 0%, var(--color-primario-verde) 100%);
    }
    .custom-js-modal .boton-confirmacion:hover {
        background: linear-gradient(135deg, var(--color-primario-verde) 0%, var(--color-primario-verde-oscuro) 100%);
    }
    .custom-js-modal .boton-negacion {
        background: linear-gradient(135deg, var(--color-error-rojo-claro) 0%, var(--color-error-rojo) 100%);
    }
    .custom-js-modal .boton-negacion:hover {
        background: linear-gradient(135deg, var(--color-error-rojo) 0%, #d32f2f 100%); /* Darker red */
    }

    /* Style for the explanation text after answering a question */
    #explicacion-respuesta {
      margin-top: 20px;
      padding: 15px;
      background-color: rgba(240, 240, 240, 0.9);
      border-radius: var(--radio-borde-general);
      text-align: left;
      font-size: 0.95em;
      color: var(--color-texto-oscuro);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      display: none; /* Hidden by default */
    }
    #explicacion-respuesta.mostrar {
      display: block;
      animation: fadeIn 0.5s ease-out;
    }

    /* Styles for the correct answer celebration modal */
    #ventana-felicitacion {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); /* Soft green background */
        padding: var(--padding-modal-grande);
        border-radius: var(--radio-borde-modal-grande);
        box-shadow: var(--sombra-modal);
        z-index: 10006; /* Higher than other modals */
        text-align: center;
        max-width: 500px; /* Wider to accommodate image */
        width: 90vw;
        color: var(--color-texto-oscuro);
        display: none;
        animation: fadeIn 0.5s ease-out;
    }
    #ventana-felicitacion.mostrar {
        display: block;
    }
    #ventana-felicitacion h3 {
        font-size: 2em;
        color: var(--color-primario-verde-oscuro);
        margin-bottom: 20px;
    }
    #ventana-felicitacion img {
        max-width: 100%;
        height: auto;
        border-radius: var(--radio-borde-general);
        margin-bottom: 20px;
        box-shadow: var(--sombra-elemento);
    }
    #ventana-felicitacion p {
        font-size: 1.1em;
        line-height: 1.6;
        margin-bottom: 20px;
        text-shadow: none; /* No text shadow on light background */
        font-weight: normal;
    }
    #ventana-felicitacion audio {
        width: 100%;
        margin-bottom: 20px;
    }
    #ventana-felicitacion button {
        background: linear-gradient(135deg, var(--color-secundario-azul-claro) 0%, var(--color-secundario-azul) 100%);
    }
    #ventana-felicitacion button:hover {
        background: linear-gradient(135deg, var(--color-secundario-azul) 0%, var(--color-secundario-azul-oscuro) 100%);
    }


    /* Animaciones */
    @keyframes fadeIn {
      0% { opacity: 0; transform: translate(-50%, -55%); }
      100% { opacity: 1; transform: translate(-50%, -50%); }
    }
    @keyframes aparecerVentana { /* Maintained in case it's used specifically */
      0% { opacity: 0; transform: translate(-50%, -60%); }
      100% { opacity: 1; transform: translate(-50%, -50%); }
    }

    /* Media queries for responsive design */
    @media (max-width: 600px) {
      .modal-base, #ventana-final, .custom-js-modal, #ventana-felicitacion {
        width: 95vw; /* Wider modals on small screens */
        max-width: 95vw;
      }
      .modal-base h2 { font-size: 1.5em; }
      .custom-js-modal h3 { font-size: 1.3em; }
      .custom-js-modal p { font-size: 1em; }
      #ventana-felicitacion h3 { font-size: 1.5em; } /* Smaller title for felicitacion */

      #panel-progreso {
        width: calc(100% - 20px); /* Occupy almost full width */
        left: 10px;
        transform: translateX(0); /* No centering, as it's full width */
        bottom: 10px;
        font-size: 13px;
      }
      #botones-fijos {
        top: 10px;
        right: 10px;
        display: flex;
        flex-direction: column; /* Stacked vertically */
        gap: 6px; /* Space between buttons */
        align-items: flex-end; /* Align to the right */
      }
      #botones-fijos button {
        margin-bottom: 0; /* Remove bottom margin if there's a gap */
        padding: 8px 12px;
        font-size: 14px;
      }
      #botones-fijos button span {
        display: inline; /* Show text on small screens */
      }
    }
    /* Media query for larger screens to show text next to icons */
    @media (min-width: 601px) {
      #botones-fijos button span {
        display: inline; /* Show text on larger screens */
      }
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="ventana-bienvenida" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="titulo-bienvenida">
  <h2 id="titulo-bienvenida">춰Bienvenido a la trivia del "Parque Natural Francisco Tau"!</h2>
  <p>쮼n qu칠 rango de edad te encontr치s?</p>
  <div id="botones-edad">
    <button data-edad="menor10" class="age-selection-button">Menor a 10 a침os</button>
    <button data-edad="10a15" class="age-selection-button">Entre 10 y 15 a침os</button>
    <button data-edad="mayor15" class="age-selection-button">Mayor a 15 a침os</button>
  </div>
</div>

<div id="ventana-instrucciones" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="titulo-instrucciones">
    <h2 id="titulo-instrucciones">춰Bienvenido a la trivia del Parque Natural Francisco Tau!</h2>
    <p>En esta trivia aprenderemos diferentes aspectos naturales, culturales y sociales de nuestro parque natural.</p>
    <p>Para poder realizar la experiencia de la forma m치s 칩ptima debemos realizar dos cosas:</p>
    <p>En primer lugar, activar la ubicaci칩n y en segundo, activar el sonido.</p>
    <p>춰Esperamos que disfrutes este viaje por el parque!</p>
    <button id="boton-comenzar-instrucciones">춰Comencemos!</button>
</div>

<div id="pregunta" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="texto-pregunta">
  <p id="texto-pregunta"></p>
  <div id="opciones"></div>
  <div id="explicacion-respuesta"></div> </div>

<div id="ventana-felicitacion" role="dialog" aria-modal="true" aria-labelledby="titulo-felicitacion">
    <h3 id="titulo-felicitacion">춰Respuesta Correcta!</h3>
    <img id="felicitacion-imagen" src="" alt="Imagen del lugar">
    <p id="felicitacion-explicacion"></p>
    <audio id="felicitacion-audio" controls preload="auto"></audio>
    <button id="boton-continuar-felicitacion">Continuar</button>
</div>

<div id="botones-fijos" style="display: none;">
  <button id="boton-reiniciar" aria-label="Reiniciar Trivia">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
    <span>Reiniciar</span>
  </button>
  <button id="boton-mostrar-ubicacion" aria-label="Mostrar mi ubicaci칩n">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
    <span>Mi ubicaci칩n</span>
  </button>
  <button id="boton-toggle-sonido" aria-label="Activar/Desactivar Sonido">
    <svg id="icon-sound-on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
    <svg id="icon-sound-off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display:none;"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .9-.23 1.74-.63 2.5L20.5 17c.92-1.23 1.5-2.77 1.5-4.5 0-4.01-2.99-7.11-7-8.77v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71zM4.27 3L3 4.27l9 9V19c0 1.38-1.12 2.5-2.5 2.5S6 20.38 6 19v-1H2v1c0 2.21 1.79 4 4 4s4-1.79 4-4V7.27L1.27 0 0 1.27l3 3zm7.53 10.73L7.27 9H3v6h3.73l4.5 4.5c.66.33 1.41.5 2.22.5 2.05 0 3.8-.96 4.99-2.4l-2.72-2.72z"/></svg>
    <span>Sonido</span>
  </button>
</div>

<div id="panel-progreso" style="display: none;">
  <div id="barra-progreso">
    <div id="progreso-porcentaje"></div>
  </div>
  <div id="progreso-texto">0 / 0 preguntas respondidas - Puntaje: 0 / 0</div>
</div>

<div id="ventana-final" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="titulo-final">
  <h2 id="titulo-final">游꿀 춰Felicitaciones!</h2>
  <p>Has finalizado la trivia del <strong>Parque Natural Francisco Tau</strong>.</p>
  <p id="mensaje-final"></p>
  <p>Tu puntaje final es: <span id="puntaje-final"></span></p>
  <button id="boton-cerrar-final">Cerrar</button>
</div>

<audio id="sonido-correcto" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
<audio id="sonido-incorrecto" src="https://actions.google.com/sounds/v1/cartoon/boing.ogg" preload="auto"></audio>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // --- Global Variables and Configuration ---
  // Questions data loaded from a simulated JSON structure
  const preguntasData = {
    "menor10": [
      { "coords": [-34.72316, -58.39786], "texto": "쯈u칠 치rbol muy viejo puedes tocar en el parque? (F치cil)", "opciones": ["Algarrobo", "Pino", "Eucalipto"], "correcta": 0, "explicacion": "El Algarrobo es un 치rbol emblem치tico del parque, conocido por su longevidad y su importancia ecol칩gica en la regi칩n.", "fotoUrl": "https://placehold.co/400x250/FFA500/FFFFFF?text=Algarrobo", "audioUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" }, // Reemplaza con tus URLs
      { "coords": [-34.70273, -58.29226], "texto": "쯈u칠 representa la estatua que est치 en el parque? (F치cil)", "opciones": ["Un gaucho", "Un soldado", "Un indio"], "correcta": 0, "explicacion": "La estatua rinde homenaje al gaucho argentino, figura central de la cultura y la historia rural de nuestro pa칤s.", "fotoUrl": "https://placehold.co/400x250/2196f3/FFFFFF?text=Estatua+Gaucho", "audioUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" },
      { "coords": [-34.70198,-58.29264], "texto": "쯈u칠 animales puedes ver en la zona de aves? (F치cil)", "opciones": ["Aves", "Leones", "Elefantes"], "correcta": 0, "explicacion": "La zona de avistaje est치 dedicada a la observaci칩n de diversas especies de aves aut칩ctonas que habitan el parque.", "fotoUrl": "https://placehold.co/400x250/4CAF50/FFFFFF?text=Aves", "audioUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" },
      { "coords": [-34.70172, -58.29371], "texto": "쯈u칠 se est치 plantando en el 치rea de reforestaci칩n? (F치cil)", "opciones": ["츼rboles aut칩ctonos", "Palmeras", "Pinos"], "correcta": 0, "explicacion": "En el 치rea de reforestaci칩n se plantan 치rboles aut칩ctonos para restaurar el ecosistema original del parque.", "fotoUrl": "https://placehold.co/400x250/8BC34A/FFFFFF?text=Reforestacion", "audioUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3" },
      { "coords": [-34.70141, -58.29481], "texto": "쯈u칠 puedes aprender en el Centro de Interpretaci칩n Ambiental? (F치cil)", "opciones": ["Sobre plantas y animales", "Sobre deportes", "Sobre m칰sica"], "correcta": 0, "explicacion": "El Centro de Interpretaci칩n Ambiental ofrece informaci칩n y actividades educativas sobre la flora y fauna local, y la importancia de su conservaci칩n.", "fotoUrl": "https://placehold.co/400x250/FFC107/FFFFFF?text=Centro+Interpretacion", "audioUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3" }
    ],
    "10a15": [
      { "coords": [-34.72316, -58.39786], "texto": "쯈u칠 tipo de 치rbol centenario destaca en el parque? (Intermedio)", "opciones": ["Algarrobo", "Pino", "Eucalipto"], "correcta": 0, "explicacion": "El Algarrobo es un 치rbol centenario caracter칤stico del Espinal, una ecorregi칩n importante de Argentina.", "fotoUrl": "https://placehold.co/400x250/FFA500/FFFFFF?text=Algarrobo", "audioUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3" },
      { "coords": [-34.70273, -58.29226], "texto": "쮸 qui칠n rinde homenaje la estatua ubicada en el parque? (Intermedio)", "opciones": ["Al gaucho argentino", "A un soldado", "A un m칰sico"], "correcta": 0, "explicacion": "La escultura es un tributo al gaucho, figura ic칩nica de la identidad cultural y la historia de las llanuras argentinas.", "fotoUrl": "https://placehold.co/400x250/2196f3/FFFFFF?text=Estatua+Gaucho", "audioUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3" },
      { "coords": [-34.70198,-58.29264], "texto": "쯈u칠 tipo de fauna puedes observar en la zona de avistaje del parque? (Intermedio)", "opciones": ["Aves aut칩ctonas", "Felinos grandes", "Mam칤feros marinos"], "correcta": 0, "explicacion": "En esta zona se pueden observar diversas especies de aves aut칩ctonas, vitales para el equilibrio del ecosistema local.", "fotoUrl": "https://placehold.co/400x250/4CAF50/FFFFFF?text=Aves", "audioUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" },
      { "coords": [-34.70172, -58.29371], "texto": "쮺u치l es el objetivo del 치rea de reforestaci칩n? (Intermedio)", "opciones": ["Restaurar especies aut칩ctonas", "Crear jardines ex칩ticos", "Construir senderos"], "correcta": 0, "explicacion": "El objetivo principal es la restauraci칩n del ecosistema nativo mediante la reforestaci칩n con especies de 치rboles y arbustos propios de la regi칩n.", "fotoUrl": "https://placehold.co/400x250/8BC34A/FFFFFF?text=Reforestacion", "audioUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-9.mp3" },
      { "coords": [-34.70141, -58.29481], "texto": "쯈u칠 actividades realiza el Centro de Interpretaci칩n Ambiental? (Intermedio)", "opciones": ["Educaci칩n ambiental e investigaci칩n", "Competencias deportivas", "Conciertos musicales"], "correcta": 0, "explicacion": "El Centro se dedica a la educaci칩n ambiental, promoviendo la conciencia sobre la biodiversidad y la investigaci칩n para la conservaci칩n del parque.", "fotoUrl": "https://placehold.co/400x250/FFC107/FFFFFF?text=Centro+Interpretacion", "audioUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3" }
    ],
    "mayor15": [
      { "coords": [-34.72316, -58.39786], "texto": "En t칠rminos de bot치nica hist칩rica, 쯤u칠 ejemplar arb칩reo centenario predomina en el parque? (Dif칤cil)", "opciones": ["Algarrobo", "Pino", "Eucalipto"], "correcta": 0, "explicacion": "El Algarrobo (Prosopis alba/nigra) es un 치rbol nativo de gran valor hist칩rico y ecol칩gico en la regi칩n del Espinal, conocido por su resistencia y longevidad.", "fotoUrl": "https://placehold.co/400x250/FFA500/FFFFFF?text=Algarrobo", "audioUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-11.mp3" },
      { "coords": [-34.70273, -58.29226], "texto": "쮺u치l es el significado cultural de la escultura ubicada en el parque? (Dif칤cil)", "opciones": ["Homenaje al gaucho argentino", "Representaci칩n de un soldado", "Tributo a un m칰sico"], "correcta": 0, "explicacion": "La escultura es un monumento al gaucho, s칤mbolo de la identidad nacional y la cultura rural argentina, representando la conexi칩n del hombre con la tierra.", "fotoUrl": "https://placehold.co/400x250/2196f3/FFFFFF?text=Estatua+Gaucho", "audioUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-12.mp3" },
      { "coords": [-34.70198,-58.29264], "texto": "쮻esde un punto de vista ecol칩gico, 쯤u칠 tipo de fauna destaca en el avistaje ubicado en el parque? (Dif칤cil)", "opciones": ["Aves aut칩ctonas del Espinal", "Felinos ex칩ticos", "Mam칤feros marinos"], "correcta": 0, "explicacion": "La zona de avistaje est치 dise침ada para observar la avifauna aut칩ctona del bioma del Espinal, que incluye especies end칠micas y migratorias esenciales para la salud del ecosistema.", "fotoUrl": "https://placehold.co/400x250/4CAF50/FFFFFF?text=Aves", "audioUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-13.mp3" },
      { "coords": [-34.70172, -58.29371], "texto": "쮺u치l es la importancia ecol칩gica del 치rea de reforestaci칩n en el parque? (Dif칤cil)", "opciones": ["Restaurar el ecosistema original con especies aut칩ctonas", "Crear jardines ornamentales", "Construcci칩n de 치reas recreativas"], "correcta": 0, "explicacion": "El 치rea de reforestaci칩n es crucial para la restauraci칩n ecol칩gica, promoviendo la biodiversidad y la resiliencia del ecosistema al reintroducir especies nativas que han sido desplazadas.", "fotoUrl": "https://placehold.co/400x250/8BC34A/FFFFFF?text=Reforestacion", "audioUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3" },
      { "coords": [-34.70141, -58.29481], "texto": "Analizando la funci칩n del Centro de Interpretaci칩n Ambiental, 쯤u칠 rol cumple en la conservaci칩n del parque? (Dif칤cil)", "opciones": ["Fomenta la educaci칩n ambiental y la investigaci칩n cient칤fica", "Organiza eventos deportivos", "Promueve festivales culturales"], "correcta": 0, "explicacion": "El Centro de Interpretaci칩n Ambiental act칰a como un pilar en la conservaci칩n, facilitando la investigaci칩n cient칤fica, la educaci칩n p칰blica y la sensibilizaci칩n sobre la importancia de proteger el patrimonio natural del parque.", "fotoUrl": "https://placehold.co/400x250/FFC107/FFFFFF?text=Centro+Interpretacion", "audioUrl": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3" }
    ]
  };

  let edadSeleccionada = null;
  let progreso = { actual: 0, puntaje: 0, intentos: {} }; // `intentos` ahora tambi칠n se usa para marcar si una pregunta ha sido activada
  let mapa;
  let marcadorUbicacion;
  let ubicacionWatchId = null;
  const ACTIVATION_RADIUS = 30; // Meters
  const preguntaMarkers = [];
  let currentQuestionRadiusCircle = null;
  let sonidoActivado = true; // New variable for sound control

  // DOM Elements (cache)
  const ventanaBienvenida = document.getElementById("ventana-bienvenida");
  const ventanaInstrucciones = document.getElementById("ventana-instrucciones");
  const ventanaPregunta = document.getElementById("pregunta");
  const ventanaFinal = document.getElementById("ventana-final");
  const ventanaFelicitacion = document.getElementById("ventana-felicitacion"); // Nueva ventana de felicitaci칩n
  const panelProgreso = document.getElementById("panel-progreso");
  const botonesFijos = document.getElementById("botones-fijos");
  const sonidoCorrecto = document.getElementById("sonido-correcto");
  const sonidoIncorrecto = document.getElementById("sonido-incorrecto");
  const botonToggleSonido = document.getElementById("boton-toggle-sonido");
  const iconSoundOn = document.getElementById("icon-sound-on");
  const iconSoundOff = document.getElementById("icon-sound-off");
  // const explicacionRespuestaDiv = document.getElementById("explicacion-respuesta"); // Ya no se usa directamente para la explicaci칩n de correctas

  // --- Helper Functions ---

  /**
   * Plays a sound if sound is activated.
   * @param {HTMLAudioElement} audio A reference to the audio element.
   */
  function reproducirSonido(audio) {
    if (sonidoActivado) {
      audio.currentTime = 0; // Rewind to start
      audio.play();
    }
  }

  /**
   * Reproduce un texto dado usando la API de s칤ntesis de voz del navegador.
   * @param {string} text El texto a reproducir.
   */
  function reproducirTexto(text) {
    if ('speechSynthesis' in window && sonidoActivado) { // Agregada la condici칩n sonidoActivado
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'es-ES'; // Establece el idioma a espa침ol
        utterance.volume = 1; // Volumen (0 a 1)
        utterance.rate = 1;   // Velocidad (0.1 a 10)
        utterance.pitch = 1;  // Tono (0 a 2)

        // Detener cualquier reproducci칩n anterior para evitar solapamientos
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
    } else if (!('speechSynthesis' in window)) {
        console.warn("La API de s칤ntesis de voz no est치 soportada en este navegador.");
    }
    // No hace nada si sonidoActivado es falso.
  }

  /**
   * Creates and displays a custom modal.
   * @param {string} titulo The modal title.
   * @param {string} mensaje The main modal message.
   * @param {Array<Object>} botonesConfig Array of objects to configure buttons.
   * Ej: [{ texto: 'OK', clase: 'boton-confirmacion', callback: () => {} }]
   */
  function crearModalPersonalizado(titulo, mensaje, botonesConfig) {
    const modalExistente = document.querySelector('.custom-js-modal');
    if (modalExistente) {
        document.body.removeChild(modalExistente); // Remove previous modal if exists
    }

    const modal = document.createElement('div');
    modal.className = 'custom-js-modal';
    modal.setAttribute('role', 'alertdialog'); // More specific than 'dialog' for messages
    modal.setAttribute('aria-modal', 'true');

    const modalTitulo = document.createElement('h3');
    modalTitulo.textContent = titulo;
    modal.appendChild(modalTitulo);
    // Assign ID to title for aria-labelledby
    const tituloId = 'custom-modal-titulo-' + Date.now();
    modalTitulo.id = tituloId;
    modal.setAttribute('aria-labelledby', tituloId);


    const modalMensaje = document.createElement('p');
    modalMensaje.innerHTML = mensaje; // Use innerHTML if message can have simple HTML like <strong>
    modal.appendChild(modalMensaje);

    const botonesDiv = document.createElement('div');
    botonesDiv.className = 'modal-botones';

    botonesConfig.forEach(btnConfig => {
      const button = document.createElement('button');
      button.textContent = btnConfig.texto;
      if (btnConfig.clase) {
        button.classList.add(...btnConfig.clase.split(' ')); // Allows multiple classes
      }
      button.addEventListener('click', () => {
        if (btnConfig.callback) {
          btnConfig.callback();
        }
        document.body.removeChild(modal);
      });
      botonesDiv.appendChild(button);
    });

    modal.appendChild(botonesDiv);
    document.body.appendChild(modal);
    // Focus the first button of the modal for accessibility
    if (botonesDiv.firstChild && typeof botonesDiv.firstChild.focus === 'function') {
        botonesDiv.firstChild.focus();
    }
  }

  function obtenerPreguntas() {
    return preguntasData[edadSeleccionada] || [];
  }

  // --- Main Game Logic ---

  function seleccionarEdad(rango) {
    edadSeleccionada = rango;

    ventanaBienvenida.classList.remove("mostrar");
    iniciarMapa();
    ventanaInstrucciones.classList.add("mostrar");
    // Focus the start button in instructions
    document.getElementById("boton-comenzar-instrucciones").focus();

    // A침adir reproducci칩n de audio al mostrar la ventana de instrucciones
    const textoInstrucciones = document.getElementById("titulo-instrucciones").textContent + " " +
                               Array.from(document.querySelectorAll("#ventana-instrucciones p")).map(p => p.textContent).join(" ");
    reproducirTexto(textoInstrucciones);
  }

  function cerrarVentanaInstrucciones() {
    ventanaInstrucciones.classList.remove("mostrar");
    // Al cerrar las instrucciones, cancela cualquier audio de voz en curso.
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
    }
    if (!ubicacionWatchId) {
        iniciarSeguimientoUbicacion();
    }
  }

  function iniciarMapa() {
    const primerasPreguntas = obtenerPreguntas();
    if (primerasPreguntas.length === 0) {
        crearModalPersonalizado("Error", "No hay preguntas para el rango de edad seleccionado.", [{texto: "Cerrar"}]);
        return;
    }
    // Inicializa el mapa centrado en la primera pregunta
    mapa = L.map('map').setView(primerasPreguntas[0].coords, 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '춸 OpenStreetMap contributors'
    }).addTo(mapa);

    // Clear previous markers if map is restarted
    preguntaMarkers.forEach(marker => marker.remove());
    preguntaMarkers.length = 0; // Empty array

    primerasPreguntas.forEach((p, index) => {
      // Los marcadores de preguntas se a침aden inicialmente con opacidad baja y no interactivos
      // Se har치n visibles y se activar치n autom치ticamente al entrar en el radio
      const marker = L.marker(p.coords, { opacity: 0.5, interactive: false });
      p.marker = marker;
      preguntaMarkers.push(marker);
    });

    actualizarPanelProgreso();
    botonesFijos.style.display = "flex"; /* Use flex for fixed buttons */
    panelProgreso.style.display = "block";
  }

  function actualizarVisibilidadMarcadorActual() {
    if (progreso.actual < obtenerPreguntas().length) {
        const preguntaActual = obtenerPreguntas()[progreso.actual];
        // Asegura que el marcador de la pregunta actual sea visible y con opacidad completa
        if (preguntaActual.marker && !mapa.hasLayer(preguntaActual.marker)) {
            preguntaActual.marker.setOpacity(1).addTo(mapa);
        }
        // Actualiza o crea el c칤rculo de radio para la pregunta actual
        if (currentQuestionRadiusCircle) {
            mapa.removeLayer(currentQuestionRadiusCircle);
        }
        currentQuestionRadiusCircle = L.circle(L.latLng(preguntaActual.coords), {
            color: 'blue', fillColor: '#0000ff', fillOpacity: 0.2, radius: ACTIVATION_RADIUS
        }).addTo(mapa);
    } else if (currentQuestionRadiusCircle) { // Si no hay m치s preguntas, remueve el c칤rculo
        mapa.removeLayer(currentQuestionRadiusCircle);
        currentQuestionRadiusCircle = null;
    }
  }

  /**
   * Muestra la ventana de felicitaci칩n con la explicaci칩n de la respuesta correcta,
   * una imagen del lugar y un audio.
   * @param {Object} pregunta El objeto de la pregunta actual.
   */
  function mostrarFelicitacionCorrecta(pregunta) {
    document.getElementById("felicitacion-imagen").src = pregunta.fotoUrl;
    document.getElementById("felicitacion-imagen").alt = `Imagen del lugar de la pregunta: ${pregunta.texto}`;
    document.getElementById("felicitacion-explicacion").textContent = pregunta.explicacion;

    const audioExplicacion = document.getElementById("felicitacion-audio");
    audioExplicacion.src = pregunta.audioUrl;

    ventanaFelicitacion.classList.add("mostrar");

    // Reproducir el audio si el sonido est치 activado
    if (sonidoActivado) {
      sonidoCorrecto.currentTime = 0;
      sonidoCorrecto.play();
    }

    // Reproducir el texto de la explicaci칩n de la felicitaci칩n
    reproducirTexto(pregunta.explicacion);

    // Centrar el foco en el bot칩n de continuar para accesibilidad
    document.getElementById("boton-continuar-felicitacion").focus();

    // Listener para el bot칩n "Continuar" de la ventana de felicitaci칩n
    const botonContinuar = document.getElementById("boton-continuar-felicitacion");
    // Remover listener previo para evitar m칰ltiples ejecuciones
    const oldListener = botonContinuar._currentListener;
    if (oldListener) {
        botonContinuar.removeEventListener('click', oldListener);
    }

    const newListener = () => {
        audioExplicacion.pause(); // Detener el audio al cerrar la ventana
        if ('speechSynthesis' in window) { // Detener la s칤ntesis de voz al cerrar
            window.speechSynthesis.cancel();
        }
        ventanaFelicitacion.classList.remove("mostrar");

        // Continuar con la l칩gica del juego despu칠s de la felicitaci칩n
        pregunta.marker.setOpacity(0.4);
        pregunta.marker.options.interactive = false;

        if (currentQuestionRadiusCircle) {
            mapa.removeLayer(currentQuestionRadiusCircle);
            currentQuestionRadiusCircle = null;
        }

        progreso.actual++;
        actualizarPanelProgreso();
        actualizarVisibilidadMarcadorActual();

        if (progreso.actual >= obtenerPreguntas().length) {
            mostrarVentanaFinal();
        }
        ventanaPregunta.classList.remove("mostrar"); // Cierra la ventana de la pregunta
    };
    botonContinuar.addEventListener('click', newListener);
    botonContinuar._currentListener = newListener; // Guarda el listener para poder removerlo
  }

  function mostrarPregunta(index) {
    // console.log(`[mostrarPregunta] Intentando mostrar pregunta ${index}. Progreso actual: ${progreso.actual}. Ventana visible: ${ventanaPregunta.classList.contains('mostrar')}`);
    // Solo muestra la pregunta si es la actual y la ventana no est치 ya abierta
    if (index !== progreso.actual || ventanaPregunta.classList.contains('mostrar')) {
      // console.log(`[mostrarPregunta] Retornando: index !== progreso.actual (${index !== progreso.actual}) o ventana ya visible (${ventanaPregunta.classList.contains('mostrar')})`);
      return;
    }

    const p = obtenerPreguntas()[index];
    const preguntaId = `pregunta_${index}`;
    // Inicializa los intentos si la pregunta se activa por primera vez
    progreso.intentos[preguntaId] = progreso.intentos[preguntaId] || 0;

    document.getElementById("texto-pregunta").textContent = p.texto;
    const opcionesDiv = document.getElementById("opciones");
    opcionesDiv.innerHTML = "";
    // explicacionRespuestaDiv.innerHTML = ""; // Ya no es necesario aqu칤 para respuestas correctas
    // explicacionRespuestaDiv.classList.remove('mostrar'); // Ya no es necesario aqu칤 para respuestas correctas

    p.opciones.forEach((opcion, i) => {
      const btn = document.createElement("button");
      btn.textContent = opcion;
      btn.addEventListener('click', () => {
        if (i === p.correcta) {
          reproducirSonido(sonidoCorrecto);
          const puntosGanados = Math.max(0, 3 - progreso.intentos[preguntaId]);
          progreso.puntaje += puntosGanados;

          // MOSTRAR LA NUEVA VENTANA DE FELICITACI칍N
          mostrarFelicitacionCorrecta(p);

        } else {
          reproducirSonido(sonidoIncorrecto);
          progreso.intentos[preguntaId]++;
          // Para respuestas incorrectas, todav칤a se puede usar la explicaci칩n original si se desea.
          // Pero para el alcance de este pedido, se enfoca en la correcta.
          // Si quieres una explicaci칩n para incorrectas, puedes volver a habilitar el div.
          crearModalPersonalizado(
            "Respuesta Incorrecta",
            "춰Ups! Esa no es la respuesta. Intent치 de nuevo.",
            [{ texto: "Entendido", clase: "boton-negacion" }] // No es necesario callback para ocultar explicaci칩n aqu칤
          );
        }
      });
      opcionesDiv.appendChild(btn);
    });
    ventanaPregunta.classList.add("mostrar");
    // console.log(`[mostrarPregunta] Ventana de pregunta mostrada. Display style: ${window.getComputedStyle(ventanaPregunta).display}`);
    // Focus the first answer option for accessibility
    if (opcionesDiv.firstChild && typeof opcionesDiv.firstChild.focus === 'function') {
        opcionesDiv.firstChild.focus();
    }
  }

  function iniciarSeguimientoUbicacion() {
    // console.log("[iniciarSeguimientoUbicacion] Iniciando seguimiento de ubicaci칩n.");
    if (!navigator.geolocation) {
      crearModalPersonalizado("Error de Geolocalizaci칩n", "La geolocalizaci칩n no est치 soportada por tu navegador.", [{texto: "Cerrar"}]);
      console.error("[iniciarSeguimientoUbicacion] Geolocalizaci칩n no soportada.");
      return;
    }

    // Si ya estamos rastreando la ubicaci칩n, no iniciar otro seguimiento.
    if (ubicacionWatchId !== null) {
        // console.log("[iniciarSeguimientoUbicacion] Seguimiento ya activo. Centrando mapa si hay marcador.");
        if (marcadorUbicacion) mapa.setView(marcadorUbicacion.getLatLng(), 17);
        return;
    }

    ubicacionWatchId = navigator.geolocation.watchPosition(
      (pos) => {
        const userLocation = L.latLng(pos.coords.latitude, pos.coords.longitude);
        // console.log(`[iniciarSeguimientoUbicacion] Ubicaci칩n actual: Lat ${userLocation.lat}, Lng ${userLocation.lng}`);

        if (marcadorUbicacion) {
          marcadorUbicacion.setLatLng(userLocation);
        } else {
          marcadorUbicacion = L.marker(userLocation, {
            icon: L.divIcon({className: 'leaflet-div-icon', html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#E53935"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>', iconSize: [30,30], iconAnchor: [15,30]}) // Custom SVG for user location
          }).addTo(mapa).bindPopup("춰Est치s aqu칤!");
          mapa.setView(userLocation, 17); // Center on first detection
        }

        // L칩gica de activaci칩n de la pregunta
        if (progreso.actual < obtenerPreguntas().length) {
          const preguntaActual = obtenerPreguntas()[progreso.actual];
          const preguntaId = `pregunta_${progreso.actual}`; // ID 칰nico para la pregunta actual
          const preguntaLocation = L.latLng(preguntaActual.coords);
          const distance = userLocation.distanceTo(preguntaLocation);
          // console.log(`[iniciarSeguimientoUbicacion] Pregunta actual: ${progreso.actual}. Distancia a la pregunta: ${distance.toFixed(2)}m. Radio de activaci칩n: ${ACTIVATION_RADIUS}m.`);

          // Asegurar que el marcador de la pregunta actual sea visible
          if (preguntaActual.marker && !mapa.hasLayer(preguntaActual.marker)) {
              preguntaActual.marker.setOpacity(1).addTo(mapa);
              // console.log(`[iniciarSeguimientoUbicacion] Marcador de pregunta ${progreso.actual} a침adido/visible.`);
          }
          // Actualizar o crear el c칤rculo de radio para la pregunta actual
          actualizarVisibilidadMarcadorActual();

          // Verificar si la pregunta ya ha sido activada/respondida en este intento
          // Usamos `progreso.intentos[preguntaId] !== undefined` para saber si ya se ha "tocado" esta pregunta.
          const preguntaYaActivada = (progreso.intentos[preguntaId] !== undefined);
          // console.log(`[iniciarSeguimientoUbicacion] Pregunta ${preguntaId} ya activada (progreso.intentos): ${preguntaYaActivada}`);

          // Si la distancia es menor o igual al radio de activaci칩n
          // Y la ventana de la pregunta NO est치 visible actualmente (para evitar re-abrirla)
          // Y la pregunta a칰n NO ha sido activada autom치ticamente
          if (distance <= ACTIVATION_RADIUS && !ventanaPregunta.classList.contains('mostrar') && !preguntaYaActivada && !ventanaFelicitacion.classList.contains('mostrar')) { // A침adida condici칩n para la ventana de felicitaci칩n
            // console.log(`[iniciarSeguimientoUbicacion] Condici칩n de activaci칩n cumplida para pregunta ${progreso.actual}.`);

            // Marca la pregunta como "activada" para evitar activaciones m칰ltiples
            progreso.intentos[preguntaId] = 0; // Inicializa los intentos a 0 para esta pregunta
            // console.log(`[iniciarSeguimientoUbicacion] Marcando pregunta ${preguntaId} como activada.`);

            // Si el marcador estaba interactivo (por un clic manual previo, aunque ahora es autom치tico),
            // asegura que no lo sea m치s y cierra cualquier tooltip.
            if (preguntaActual.marker.options.interactive) {
                preguntaActual.marker.closeTooltip();
                preguntaActual.marker.options.interactive = false;
                // console.log(`[iniciarSeguimientoUbicacion] Desactivando interactividad del marcador.`);
            }

            // Centra el mapa en la pregunta activada (mejora la UX)
            mapa.setView(preguntaLocation, 17);
            // console.log(`[iniciarSeguimientoUbicacion] Mapa centrado en la pregunta.`);

            // Muestra la pregunta autom치ticamente
            mostrarPregunta(progreso.actual);

            // Notificar al usuario que una pregunta se ha activado autom치ticamente
            crearModalPersonalizado("춰Pregunta Activa!", "Est치s en el lugar de la pr칩xima pregunta. 춰Responde!", [{texto: "OK"}]);
            // console.log(`[iniciarSeguimientoUbicacion] Modal de 'Pregunta Activa' mostrado.`);

          } else if (distance > ACTIVATION_RADIUS) {
            // Si el usuario se aleja del radio, aseg칰rate de que el marcador no sea interactivo
            // y cierra el tooltip si estaba abierto.
            if (preguntaActual.marker.options.interactive) {
              preguntaActual.marker.options.interactive = false;
              preguntaActual.marker.closeTooltip();
              // console.log(`[iniciarSeguimientoUbicacion] Usuario fuera de radio, marcador deshabilitado.`);
            }
          }
        } else {
            // console.log("[iniciarSeguimientoUbicacion] No hay m치s preguntas o progreso.actual fuera de rango.");
        }
      },
      (err) => {
        console.error(`ERROR(${err.code}): ${err.message}`);
        crearModalPersonalizado(
            "Error de Geolocalizaci칩n",
            `No se pudo obtener tu ubicaci칩n: ${err.message}. Verifica los permisos.`,
            [{texto: "Cerrar"}]
        );
        if (ubicacionWatchId !== null) {
          navigator.geolocation.clearWatch(ubicacionWatchId);
          ubicacionWatchId = null;
        }
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
    // Una vez que se inicia el seguimiento, muestra el primer marcador y su c칤rculo de radio.
    actualizarVisibilidadMarcadorActual();
  }


  function actualizarPanelProgreso() {
    const totalPreguntas = obtenerPreguntas().length;
    const porcentaje = totalPreguntas > 0 ? Math.round((progreso.actual / totalPreguntas) * 100) : 0;
    document.getElementById("progreso-porcentaje").style.width = porcentaje + "%";
    document.getElementById("progreso-texto").textContent =
        `${progreso.actual} / ${totalPreguntas} preguntas respondidas - Puntaje: ${progreso.puntaje} / ${totalPreguntas * 3}`;
  }

  function reiniciarTrivia() {
    crearModalPersonalizado(
      "Reiniciar Trivia",
      "쮼st치s seguro que quer칠s reiniciar tu progreso? Se perder치 todo.",
      [
        { texto: "S칤, reiniciar", clase: "boton-negacion", callback: () => location.reload() },
        { texto: "No, continuar", clase: "boton-confirmacion" }
      ]
    );
  }

  function mostrarVentanaFinal() {
    const totalPreguntas = obtenerPreguntas().length;
    document.getElementById("puntaje-final").textContent = `${progreso.puntaje} / ${totalPreguntas * 3}`;
    const porcentajeScore = totalPreguntas > 0 ? progreso.puntaje / (totalPreguntas * 3) : 0;
    let mensaje = "";
    if (porcentajeScore < 0.4) mensaje = "Debes estudiar m치s de la fauna y flora de nuestro parque. 춰Vuelve a intentarlo!";
    else if (porcentajeScore <= 0.6) mensaje = "Tienes conocimientos b치sicos de nuestra flora y fauna. 춰Puedes esforzarte un poco m치s!";
    else if (porcentajeScore <= 0.89) mensaje = "Tienes muy buenos conocimientos del parque. 춰Un poco m치s de estudio y lo aprender치s todo!";
    else mensaje = "춰Eres un experto conocedor del Parque Francisco Tau!";

    document.getElementById("mensaje-final").textContent = mensaje;
    ventanaFinal.classList.add("mostrar");
    document.getElementById("boton-cerrar-final").focus(); // Focus close button

    // Detiene el seguimiento de ubicaci칩n y remueve el c칤rculo de radio al finalizar la trivia
    if (ubicacionWatchId !== null) {
      navigator.geolocation.clearWatch(ubicacionWatchId);
      ubicacionWatchId = null;
    }
    if (currentQuestionRadiusCircle) {
      mapa.removeLayer(currentQuestionRadiusCircle);
      currentQuestionRadiusCircle = null;
    }
    // Tambi칠n det칠n cualquier s칤ntesis de voz en curso al finalizar la trivia.
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
    }
  }

  function cerrarVentanaFinal() {
    ventanaFinal.classList.remove("mostrar");
    // Optional: Redirect or show welcome again for another round
    // ventanaBienvenida.classList.add("mostrar");
    // progreso = { actual: 0, puntaje: 0, intentos: {} }; // Reset progress if you want to play again without reloading
    // actualizarPanelProgreso();
  }

  function accionMostrarUbicacion() {
    if (marcadorUbicacion && mapa.hasLayer(marcadorUbicacion)) {
      mapa.setView(marcadorUbicacion.getLatLng(), 17); // Center on known location
      marcadorUbicacion.openPopup();
    } else if (!ubicacionWatchId) {
      // Si no se ha iniciado el seguimiento, lo inicia
      iniciarSeguimientoUbicacion();
       crearModalPersonalizado("Ubicaci칩n", "Iniciando seguimiento de ubicaci칩n para mostrarte en el mapa.", [{texto:"OK"}]);
    } else {
      // Si el seguimiento est치 activo pero no hay ubicaci칩n a칰n
      crearModalPersonalizado("Ubicaci칩n", "Esperando se침al de GPS para mostrar tu ubicaci칩n...", [{texto:"OK"}]);
    }
  }

  function toggleSonido() {
    sonidoActivado = !sonidoActivado;
    if (sonidoActivado) {
      iconSoundOn.style.display = 'inline-block';
      iconSoundOff.style.display = 'none';
    } else {
      iconSoundOn.style.display = 'none';
      iconSoundOff.style.display = 'inline-block';
      if ('speechSynthesis' in window) { // Si el sonido se desactiva, cancela cualquier voz en curso.
          window.speechSynthesis.cancel();
      }
    }
    crearModalPersonalizado("Sonido", `Sonido ${sonidoActivado ? 'activado' : 'desactivado'}.`, [{texto: "OK"}]);
  }

  // --- Initialization and Event Listeners ---
  document.addEventListener('DOMContentLoaded', () => {
    // console.log('DOM Content Loaded. Initializing app.');
    // Assign events to age buttons
    document.querySelectorAll('#botones-edad button').forEach(button => {
      button.addEventListener('click', function() {
        seleccionarEdad(this.dataset.edad);
      });
    });

    // Events for other main buttons
    document.getElementById('boton-comenzar-instrucciones').addEventListener('click', cerrarVentanaInstrucciones);
    document.getElementById('boton-reiniciar').addEventListener('click', reiniciarTrivia);
    document.getElementById('boton-mostrar-ubicacion').addEventListener('click', accionMostrarUbicacion);
    document.getElementById('boton-cerrar-final').addEventListener('click', cerrarVentanaFinal);
    botonToggleSonido.addEventListener('click', toggleSonido);

    // Show welcome window on load
    // console.log('Attempting to show welcome window.');
    if (ventanaBienvenida) {
        ventanaBienvenida.classList.add("mostrar");
        // A침adir reproducci칩n de audio al mostrar la ventana de bienvenida
        const tituloBienvenida = document.getElementById("titulo-bienvenida").textContent;
        const parrafoBienvenida = document.querySelector("#ventana-bienvenida p").textContent;
        reproducirTexto(tituloBienvenida + " " + parrafoBienvenida);
    } else {
        console.error('Error: Element with ID "ventana-bienvenida" not found.');
    }

    // Focus the first age button
    const primerBotonEdad = document.querySelector('#botones-edad button');
    if (primerBotonEdad) {
        primerBotonEdad.focus();
    }
  });

</script>

</body>
</html>