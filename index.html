<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Trivia Francisco Tau</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* Global CSS Variables */
        :root {
            --color-primario-verde: #4CAF50;
            --color-primario-verde-claro: #66bb6a;
            --color-primario-verde-oscuro: #388E3C;
            --color-secundario-azul: #2196f3;
            --color-secundario-azul-claro: #42a5f5;
            --color-secundario-azul-oscuro: #1976D2;
            --color-error-rojo: #e53935;
            --color-error-rojo-claro: #ef5350;
            --color-texto-oscuro: #333;
            --color-texto-blanco: #fff;
            --color-fondo-overlay: rgba(255, 255, 255, 0.85);
            /* Slightly increased opacity for better contrast */

            --radio-borde-general: 8px;
            --radio-borde-modal: 12px;
            --radio-borde-modal-grande: 15px;

            --padding-boton: 12px 25px;
            --padding-modal: 30px;
            --padding-modal-grande: 35px 30px;

            --sombra-elemento: 0 4px 10px rgba(0, 0, 0, 0.15), 0 2px 5px rgba(0, 0, 0, 0.1);
            --sombra-elemento-hover: 0 6px 12px rgba(0, 0, 0, 0.2);
            --sombra-modal: 0 15px 40px rgba(0, 0, 0, 0.2), 0 6px 20px rgba(0, 0, 0, 0.15);
            --sombra-modal-hover: 0 8px 20px rgba(0, 0, 0, 0.25);

            --fuente-principal: Arial, sans-serif;
            --tamano-fuente-normal: 16px;
            --tamano-fuente-boton: 17px;
            --tamano-fuente-titulo-modal: 1.8em;
            /* Adjusted for h2 in modals */
        }

        /* General styles for the page body */
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: var(--fuente-principal);
            font-size: var(--tamano-fuente-normal);
            background-image: url('fondo.jpg');
            /* Placeholder for background image - assuming it's in the root */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            /* Disable zoom on non-map elements */
            touch-action: pan-x pan-y;
            /* Allows scrolling but prevents pinch-zoom on the body */
            -webkit-user-select: none;
            /* Safari */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* IE 10+ */
            user-select: none;
            /* Standard */
        }

        #map {
            height: 100vh;
            width: 100%;
            /* Allow all touch actions including zoom on the map */
            touch-action: manipulation;
            -webkit-user-select: auto;
            /* Allow selection inside map if needed */
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }

        /* Base styles for all modal windows */
        .modal-base {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: var(--padding-modal);
            border-radius: var(--radio-borde-modal);
            z-index: 1000;
            width: 90vw;
            max-width: 450px;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.1);
            /* Subtle border */
            box-shadow: var(--sombra-modal);
            display: none;
            /* Hidden by default */
            animation: fadeIn 0.5s ease-out;

            /* Background with image and overlay for readability */
            background: linear-gradient(var(--color-fondo-overlay), var(--color-fondo-overlay)), url('fondoventanas.jpg');
            /* Placeholder for window background image - assuming it's in the root */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            /* Ensure modals also prevent zoom */
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .modal-base.mostrar {
            display: block;
        }

        .modal-base h2 {
            font-size: var(--tamano-fuente-titulo-modal);
            color: var(--color-texto-oscuro);
            margin-bottom: 20px;
            font-weight: bold;
            text-shadow: 0 0 8px var(--color-texto-blanco);
        }

        .modal-base p {
            color: var(--color-texto-oscuro);
            text-shadow: 0 0 8px var(--color-texto-blanco);
            font-weight: bold;
            /* Maintained from original style */
            margin-bottom: 15px;
            line-height: 1.6;
        }

        /* Styles for general buttons */
        button,
        .button-style {
            /* .button-style for elements that are not buttons but should look like one */
            margin: 10px 5px;
            /* Margin adjustment */
            padding: var(--padding-boton);
            font-size: var(--tamano-fuente-boton);
            border-radius: var(--radio-borde-general);
            border: 1px solid rgba(0, 0, 0, 0.2);
            /* More subtle border */
            background: linear-gradient(135deg, var(--color-primario-verde-claro) 0%, var(--color-primario-verde) 100%);
            color: var(--color-texto-blanco);
            cursor: pointer;
            box-shadow: var(--sombra-elemento);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, opacity 0.2s ease;
            /* Added opacity transition */
            font-weight: 600;
            letter-spacing: 0.5px;
            text-decoration: none;
            /* For .button-style if it's an <a> */
            display: inline-block;
            /* For .button-style if it's an <a> */
            outline: none;
            /* Remove default outline */
            min-height: 44px;
            /* Minimum touch target size */
            min-width: 44px;
            /* Minimum touch target size */
            box-sizing: border-box;
            /* Include padding and border in the element's total width and height */
            /* Prevent zoom on buttons */
            touch-action: manipulation;
            /* Allows tap, double-tap, pan, but not pinch-zoom */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        button:hover,
        .button-style:hover {
            background: linear-gradient(135deg, var(--color-primario-verde) 0%, var(--color-primario-verde-oscuro) 100%);
            transform: translateY(-2px);
            box-shadow: var(--sombra-elemento-hover);
        }

        /* Styles for focus and active states (keyboard navigation/click feedback) */
        button:focus-visible,
        button:focus,
        .button-style:focus-visible,
        .button-style:focus {
            transform: translateY(0);
            border: 3px solid var(--color-secundario-azul-claro);
            /* Thicker blue border */
            box-shadow: 0 0 0 2px var(--color-secundario-azul-claro),
                /* Blue outline effect (slightly smaller to complement border) */
                0 3px 8px rgba(0, 0, 0, 0.25);
            /* Original shadow */
        }

        button:active,
        .button-style:active {
            transform: scale(0.95);
            /* Slightly shrink on click */
            opacity: 0.8;
            /* Fade a bit */
            box-shadow: var(--sombra-elemento);
            /* Reset shadow to normal on active */
        }


        /* Style for buttons that should always have the blue border */
        .age-selection-button {
            /* New class for age selection buttons */
            border: 3px solid var(--color-secundario-azul-claro) !important;
            /* Force blue border */
            box-shadow: 0 0 0 2px var(--color-secundario-azul-claro),
                /* Blue outline effect */
                var(--sombra-elemento) !important;
            /* Keep original shadow */
        }

        /* Fixed buttons */
        #botones-fijos {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 999;
            /* Adjusted z-index to be behind modals */
            display: flex;
            /* Use flexbox for layout */
            flex-direction: column;
            /* Stack vertically */
            gap: 5px;
            /* Space between buttons */
            touch-action: pan-x pan-y;
            /* Prevent zoom on fixed buttons */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #botones-fijos button {
            display: flex;
            /* Align icon and text */
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            /* Adjust padding for icons */
        }

        #botones-fijos button svg {
            width: 20px;
            /* Icon size */
            height: 20px;
            margin-right: 8px;
            /* Space between icon and text */
            fill: var(--color-texto-blanco);
            /* Icon color */
        }

        #botones-fijos button span {
            display: none;
            /* Hide text by default on small screens */
        }

        /* Progress panel */
        #panel-progreso {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: calc(100% - 20px);
            /* Always occupy full width minus 10px padding on each side */
            max-width: 350px;
            /* Limit max width for larger screens */
            background: var(--color-fondo-overlay);
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: var(--radio-borde-general);
            padding: 10px;
            z-index: 999;
            /* Adjusted z-index to be behind modals */
            box-shadow: var(--sombra-elemento);
            font-size: 14px;
            color: var(--color-texto-oscuro);
            touch-action: pan-x pan-y;
            /* Prevent zoom on progress panel */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #barra-progreso {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: var(--radio-borde-general);
            overflow: hidden;
            margin-bottom: 5px;
        }

        #progreso-porcentaje {
            height: 100%;
            width: 0%;
            background-color: var(--color-primario-verde);
            transition: width 0.5s ease;
        }

        /* Specific Final Window */
        #ventana-final {
            /* Inherits from .modal-base but with adjustments */
            max-width: 480px;
            padding: var(--padding-modal-grande);
            border-radius: var(--radio-borde-modal-grande);
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            /* Specific soft green */
            z-index: 10001;
            /* Above other modals */
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #ventana-final h2 {
            color: var(--color-primario-verde-oscuro);
            /* Specific color for final title */
        }

        #ventana-final button {
            /* Specific close final button */
            background: linear-gradient(135deg, var(--color-secundario-azul-claro) 0%, var(--color-secundario-azul) 100%);
        }

        #ventana-final button:hover {
            background: linear-gradient(135deg, var(--color-secundario-azul) 0%, var(--color-secundario-azul-oscuro) 100%);
        }

        /* Styles for the custom modal created by JS */
        .custom-js-modal {
            position: fixed;
            /* Use fixed so it's always visible in viewport */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--color-texto-blanco);
            /* Solid white background */
            padding: var(--padding-modal);
            border-radius: var(--radio-borde-modal);
            box-shadow: var(--sombra-modal);
            z-index: 10005;
            /* High priority */
            text-align: center;
            max-width: 380px;
            /* Adjusted width */
            width: 85vw;
            color: var(--color-texto-oscuro);
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .custom-js-modal h3 {
            /* Title for JS modal */
            font-size: 1.5em;
            color: var(--color-texto-oscuro);
            margin-bottom: 15px;
            font-weight: bold;
        }

        .custom-js-modal p {
            /* Message for JS modal */
            font-size: 1.1em;
            margin-bottom: 25px;
            line-height: 1.5;
            text-shadow: none;
            /* No shadow for better readability on white background */
            font-weight: normal;
        }

        .custom-js-modal .modal-botones button {
            margin: 8px;
            padding: 10px 20px;
            /* Specific padding */
        }

        /* Specific confirmation/error buttons for JS modal */
        .custom-js-modal .boton-confirmacion {
            background: linear-gradient(135deg, var(--color-primario-verde-claro) 0%, var(--color-primario-verde) 100%);
        }

        .custom-js-modal .boton-confirmacion:hover {
            background: linear-gradient(135deg, var(--color-primario-verde) 0%, var(--color-primario-verde-oscuro) 100%);
        }

        .custom-js-modal .boton-negacion {
            background: linear-gradient(135deg, var(--color-error-rojo-claro) 0%, var(--color-error-rojo) 100%);
        }

        .custom-js-modal .boton-negacion:hover {
            background: linear-gradient(135deg, var(--color-error-rojo) 0%, #d32f2f 100%);
            /* Darker red */
        }

        /* Style for the explanation text after answering a question */
        #explicacion-respuesta {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(240, 240, 240, 0.9);
            border-radius: var(--radio-borde-general);
            text-align: left;
            font-size: 0.95em;
            color: var(--color-texto-oscuro);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            display: none;
            /* Hidden by default */
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #explicacion-respuesta.mostrar {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        /* Styles for the correct answer celebration modal */
        #ventana-felicitacion {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            /* Soft green background */
            padding: var(--padding-modal-grande);
            border-radius: var(--radio-borde-modal-grande);
            box-shadow: var(--sombra-modal);
            z-index: 10006;
            /* Higher than other modals */
            text-align: center;
            max-width: 500px;
            /* Wider to accommodate image */
            width: 90vw;
            color: var(--color-texto-oscuro);
            display: none;
            animation: fadeIn 0.5s ease-out;
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #ventana-felicitacion.mostrar {
            display: block;
        }

        #ventana-felicitacion h3 {
            font-size: 2em;
            color: var(--color-primario-verde-oscuro);
            margin-bottom: 20px;
        }

        #ventana-felicitacion img {
            max-width: 100%;
            height: auto;
            border-radius: var(--radio-borde-general);
            margin-bottom: 20px;
            box-shadow: var(--sombra-elemento);
        }

        #ventana-felicitacion p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 20px;
            text-shadow: none;
            /* No text shadow on light background */
            font-weight: normal;
        }

        /* ELIMINADO: #ventana-felicitacion audio { ... } */

        #ventana-felicitacion button {
            background: linear-gradient(135deg, var(--color-secundario-azul-claro) 0%, var(--color-secundario-azul) 100%);
        }

        #ventana-felicitacion button:hover {
            background: linear-gradient(135deg, var(--color-secundario-azul) 0%, var(--color-secundario-azul-oscuro) 100%);
        }

        #opciones {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            /* Responsive grid for options */
            gap: 10px;
            margin-top: 20px;
        }

        #opciones button {
            padding: 15px;
            font-size: 1.1em;
            cursor: pointer;
            border: none;
            border-radius: var(--radio-borde-general);
            background-color: var(--color-secundario-azul-claro);
            color: var(--color-texto-blanco);
            box-shadow: var(--sombra-elemento);
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.1s ease;
            font-weight: bold;
            text-align: center;
            white-space: normal;
            min-height: 44px;
            line-height: 1.4;
        }

        #opciones button:hover {
            background-color: var(--color-secundario-azul);
            box-shadow: var(--sombra-elemento-hover);
        }

        #opciones button:active {
            transform: scale(0.95);
            opacity: 0.8;
        }


        /* Animaciones */
        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: translate(-50%, -55%);
            }

            100% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        @keyframes aparecerVentana {
            /* Maintained in case it's used specifically */
            0% {
                opacity: 0;
                transform: translate(-50%, -60%);
            }

            100% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* Custom Leaflet DivIcon for user location */
        .leaflet-div-icon {
            background: none;
            /* Ensure no white square background */
            border: none;
            /* Remove any default border */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px !important;
            /* Override default size */
            height: 30px !important;
            /* Override default size */
            transform-origin: bottom center;
            /* For animations */
        }

        .leaflet-div-icon svg {
            width: 100%;
            height: 100%;
            display: block;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.4));
            /* Subtle shadow */
            animation: pulse 1.5s infinite ease-in-out;
            /* Pulsing animation */
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Media queries for responsive design */
        @media (max-width: 600px) {

            .modal-base,
            #ventana-final,
            .custom-js-modal,
            #ventana-felicitacion {
                width: 95vw;
                /* Wider modals on small screens */
                max-width: 95vw;
            }

            .modal-base h2 {
                font-size: 1.5em;
            }

            .custom-js-modal h3 {
                font-size: 1.3em;
            }

            .custom-js-modal p {
                font-size: 1em;
            }

            #ventana-felicitacion h3 {
                font-size: 1.5em;
                /* Smaller title for felicitacion */
            }

            #panel-progreso {
                /* width is already handled by calc(100% - 20px) */
                /* left is already handled by 10px */
                /* transform: translateX(0) is not needed if left is 10px and width is calc(100% - 20px) */
                font-size: 13px;
            }

            #botones-fijos {
                top: 10px;
                right: 10px;
                display: flex;
                flex-direction: column;
                /* Stacked vertically */
                gap: 6px;
                /* Space between buttons */
                align-items: flex-end;
                /* Align to the right */
            }

            #botones-fijos button {
                margin-bottom: 0;
                /* Remove bottom margin if there's a gap */
                padding: 8px 12px;
                font-size: 14px;
            }

            #botones-fijos button span {
                display: inline;
                /* Show text on small screens */
            }
        }

        /* Media query for larger screens to show text next to icons */
        @media (min-width: 601px) {
            #botones-fijos button span {
                display: inline;
            }
        }

        /* Styles for the Chatbot Interface (WhatsApp Style) */
        #chatbot-wrapper {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10002;
        }

        #chatbot-toggle-button {
            background: linear-gradient(135deg, #25D366 0%, #1DA851 100%); /* WhatsApp green gradient */
            color: var(--color-texto-blanco);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Stronger shadow for floating button */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: absolute;
            bottom: 0;
            right: 0;
            z-index: 10003;
            touch-action: manipulation;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #chatbot-toggle-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        #chatbot-toggle-button:active {
            transform: scale(0.95);
        }

        #chatbot-container {
            width: 320px;
            height: 400px;
            background-color: #f8f9fa; /* Light background for chat area */
            border-radius: 12px; /* Slightly more rounded */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); /* More subtle shadow */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: absolute;
            bottom: 75px; /* Adjusted to be above the toggle button */
            right: 0;
            transform-origin: bottom right;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: scale(0);
            opacity: 0;
            pointer-events: none;
        }

        #chatbot-container.mostrar {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        #chat-header {
            background-color: #075E54; /* WhatsApp header green */
            color: #fff;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        #chat-header-info {
            display: flex;
            align-items: center;
        }

        #chat-header-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #25D366; /* WhatsApp light green */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
            font-size: 1.1em;
            color: #fff;
        }

        #chat-header h3 {
            margin: 0;
            font-size: 1.1em;
            font-weight: 500;
        }

        #chat-close-button {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            transition: transform 0.2s ease;
            touch-action: manipulation;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #chat-close-button:hover {
            transform: rotate(90deg);
        }

        #chat-messages {
            flex-grow: 1;
            padding: 10px 15px;
            overflow-y: auto;
            background-color: #ECE5DD; /* WhatsApp chat background */
            background-image: url('https://user-images.githubusercontent.com/15075759/28719142-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); /* WhatsApp pattern */
            background-repeat: repeat;
            background-size: 50px;
            border-bottom: 1px solid #ddd;
        }

        .chat-message {
            display: flex;
            margin-bottom: 8px;
            align-items: flex-end;
        }

        .chat-message .bubble {
            padding: 8px 12px;
            border-radius: 18px; /* Default for most corners */
            max-width: 80%;
            word-wrap: break-word;
            font-size: 0.9em;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13); /* Subtle WhatsApp-like shadow */
            position: relative; /* For the potential triangle corner */
        }

        /* User Message Styles (like WhatsApp green) */
        .user-message {
            justify-content: flex-end; /* Push to right */
        }

        .user-message .bubble {
            background-color: #DCF8C6; /* WhatsApp message green */
            color: #333;
            border-bottom-right-radius: 2px; /* Pointed corner */
            margin-left: auto;
        }

        /* Chatbot Message Styles (like WhatsApp white/light blue) */
        .chatbot-message {
            justify-content: flex-start; /* Push to left */
        }

        .chatbot-message .bubble {
            background-color: #FFFFFF; /* WhatsApp message white */
            color: #333;
            border-bottom-left-radius: 2px; /* Pointed corner */
            margin-right: auto;
        }
        
        .chat-input-area {
            display: flex;
            padding: 8px 10px;
            background-color: #f0f2f5; /* Light gray background */
            align-items: flex-end; /* Align items to the bottom */
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05); /* Subtle shadow above input */
        }

        #chat-user-input {
            flex-grow: 1; /* Allow input to grow and take available space */
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 22px; /* Pill shape */
            margin-right: 8px; /* Space between input and send button */
            font-size: 0.9em;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: #fff;
            min-height: 40px; /* Ensure good height for touch */
            box-sizing: border-box; /* Include padding in height */
        }

        #chat-user-input:focus {
            border-color: #075E54;
            box-shadow: 0 0 0 2px rgba(7, 94, 84, 0.2);
        }

        /* Removed .chat-action-button styles as these buttons are being removed */

        /* Specific style for send button (WhatsApp style) */
        #chat-send-button {
            background-color: #075E54; /* WhatsApp green */
            color: white;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); /* Subtle shadow */
            touch-action: manipulation;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            flex-shrink: 0; /* Prevent shrinking on smaller screens */
            margin-left: 0; /* Remove left margin for cleaner look next to input */
        }

        #chat-send-button:hover {
            background-color: #044a42; /* Darker green on hover */
            transform: scale(1.05);
        }

        #chat-send-button:active {
            transform: scale(0.95);
        }

        /* Styles for images in chat */
        .chat-message img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px; /* Softer corners for images */
            margin-top: 5px;
            display: block;
        }

        /* Styles for audio in chat */
        .chat-message audio {
            width: 100%;
            margin-top: 5px;
        }


        /* Media queries for chatbot */
        @media (max-width: 600px) {
            #chatbot-wrapper {
                bottom: 10px;
                right: 10px;
            }
            #chatbot-container {
                position: fixed;
                bottom: 70px;
                left: 10px;
                right: 10px;
                width: auto;
                height: calc(85vh - 80px); /* Adjust height for fixed position and bottom button */
                transform: scale(0);
                transform-origin: bottom center;
            }
            #chatbot-toggle-button {
                width: 50px;
                height: 50px;
                font-size: 1.2em;
            }

            #chat-header {
                padding: 8px 12px;
            }

            #chat-header-avatar {
                width: 30px;
                height: 30px;
                font-size: 0.9em;
            }

            #chat-header h3 {
                font-size: 1em;
            }

            .chat-messages {
                padding: 8px 12px;
            }

            .chat-message .bubble {
                font-size: 0.85em;
                padding: 7px 10px;
            }

            .chat-input-area {
                padding: 6px 8px;
            }

            #chat-user-input {
                padding: 8px 12px;
                margin-right: 6px;
                min-height: 38px;
            }

            #chat-send-button {
                width: 40px;
                height: 40px;
                margin-left: 0; /* No margin on mobile either */
            }

            #chat-send-button svg {
                width: 22px;
                height: 22px;
            }
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <div id="ventana-bienvenida" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="titulo-bienvenida">
        <h2 id="titulo-bienvenida">¬°Bienvenido a la trivia del "Reserva Natural Francisco Tau"!</h2>
        <p>¬øEn qu√© rango de edad te encontr√°s?</p>
        <div id="botones-edad">
            <button data-edad="menor10" class="age-selection-button">Menor a 10 a√±os</button>
            <button data-edad="10a15" class="age-selection-button">Entre 10 y 15 a√±os</button>
            <button data-edad="mayor15" class="age-selection-button">Mayor a 15 a√±os</button>
        </div>
    </div>

    <div id="ventana-instrucciones" class="modal-base" role="dialog" aria-modal="true"
        aria-labelledby="titulo-instrucciones">
        <h2 id="titulo-instrucciones">¬°Bienvenido a la trivia del Reserva Natural Francisco Tau!</h2>
        <p>En esta trivia aprenderemos diferentes aspectos naturales, culturales y sociales de nuestra reserva natural.</p>
        <p>Para poder realizar la experiencia de la forma m√°s √≥ptima debemos realizar dos cosas:</p>
        <p>En primer lugar, activar la ubicaci√≥n y en segundo, activar el sonido.</p>
        <p>¬°Esperamos que disfrutes este viaje por la reserva!</p>
        <button id="boton-comenzar-instrucciones">¬°Comencemos!</button>
    </div>

    <div id="pregunta" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="texto-pregunta">
        <p id="texto-pregunta"></p>
        <div id="opciones"></div>
        <div id="explicacion-respuesta"></div>
    </div>

    <div id="ventana-felicitacion" role="dialog" aria-modal="true" aria-labelledby="titulo-felicitacion">
        <h3 id="titulo-felicitacion">¬°Respuesta Correcta!</h3>
        <img id="felicitacion-imagen" src="algarrobo.jpg" alt="Imagen del lugar">
        <p id="felicitacion-explicacion"></p>
        <button id="boton-continuar-felicitacion">Continuar</button>
    </div>

    <div id="botones-fijos" style="display: none;">
        <button id="boton-reiniciar" aria-label="Reiniciar Trivia">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M12 4V1l-4 4 4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z" />
            </svg>
            <span>Reiniciar</span>
        </button>
        <button id="boton-mostrar-ubicacion" aria-label="Mostrar mi ubicaci√≥n">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
            </svg>
            <span>Mi ubicaci√≥n</span>
        </button>
        <button id="boton-toggle-sonido" aria-label="Activar/Desactivar Sonido">
            <svg id="icon-sound-on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
            </svg>
            <svg id="icon-sound-off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display:none;">
                <path
                    d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .9-.23 1.74-.63 2.5L20.5 17c.92-1.23 1.5-2.77 1.5-4.5 0-4.01-2.99-7.11-7-8.77v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71zM4.27 3L3 4.27l9 9V19c0 1.38-1.12 2.5-2.5 2.5S6 20.38 6 19v-1H2v1c0 2.21 1.79 4 4 4s4-1.79 4-4V7.27L1.27 0 0 1.27l3 3zm7.53 10.73L7.27 9H3v6h3.73l4.5 4.5c.66.33 1.41.5 2.22.5 2.05 0 3.8-.96 4.99-2.4l-2.72-2.72z" />
            </svg>
            <span>Sonido</span>
        </button>
    </div>

    <div id="panel-progreso" style="display: none;">
        <div id="barra-progreso">
            <div id="progreso-porcentaje"></div>
        </div>
        <div id="progreso-texto">0 / 0 preguntas respondidas - Puntaje: 0 / 0</div>
    </div>

    <div id="ventana-final" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="titulo-final">
        <h2 id="titulo-final">üéâ ¬°Felicitaciones!</h2>
        <p>Has finalizado la trivia del <strong>Parque Natural Francisco Tau</strong>.</p>
        <p id="mensaje-final"></p>
        <p>Tu puntaje final es: <span id="puntaje-final"></span></p>
        <button id="boton-cerrar-final">Cerrar</button>
    </div>

    <audio id="sonido-correcto" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"
        preload="auto"></audio>
    <audio id="sonido-incorrecto" src="https://actions.google.com/sounds/v1/cartoon/boing.ogg"
        preload="auto"></audio>
    <audio id="alarmaSonido" preload="auto">
        <source src="alarma.mp3" type="audio/mpeg">
        Tu navegador no soporta el elemento de audio.
    </audio>

    <div id="chatbot-wrapper">
        <button id="chatbot-toggle-button" aria-label="Abrir/Cerrar Chatbot">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
            </svg>
        </button>
        <div id="chatbot-container">
            <div id="chat-header">
                <div id="chat-header-info">
                    <div id="chat-header-avatar">AI</div> <h3>Guarda parque Virtual</h3>
                </div>
                <button id="chat-close-button" aria-label="Cerrar Chatbot">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div id="chat-messages">
                </div>
            <div class="chat-input-area">
                <input type="text" id="chat-user-input" placeholder="Escribe tu mensaje...">
                <button id="chat-send-button" aria-label="Enviar Mensaje">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // --- Global Variables and Configuration ---
        // Questions data loaded from a simulated JSON structure
        const preguntasData = {
            "menor10": [
                {
                    "coords": [-34.61017, -58.36833], // Coordenadas de ejemplo, ajustar seg√∫n necesidad real
                    "texto": "‚Äú Tengo tronco fuerte y vainas dulces; doy mucha sombra en el parque. ¬øQui√©n soy?‚Äù",
                    "opciones": ["Eucalipto", "Pino", "Algarrobo blanco"],
                    "correcta": 2,
                    "explicacion": "¬°Este algarrobo vive en el Parque Tau desde hace m√°s de 400 a√±os! Es un ‚Äúabuelo‚Äù del bosque que da sombra fresca y alimento a muchos animalitos.",
                    "fotoUrl": "algarrobo.jpg"
                },
                {
                    "coords": [-34.61018, -58.36851], // Coordenadas de ejemplo
                    "texto": "‚ÄúToc-toc, pico el barro y hago mi casita redonda. ¬øQui√©n canta as√≠?‚Äù",
                    "opciones": ["Gorri√≥n", "Hornero", "Jilguero"],
                    "correcta": 1,
                    "explicacion": "El hornero es un pajarito constructor: amasa barro como plastilina y levanta un nido redondo que parece un hornito de pan.",
                    "fotoUrl": "hornero.jpg"
                },
                {
                    "coords": [-34.61026, -58.36866], // Coordenadas de ejemplo
                    "texto": "‚ÄúMe abrochas antes de subir al gom√≥n para que flotes seguro. ¬øQu√© soy?‚Äù",
                    "opciones": ["Casco", "Salvavidas", "Remo"],
                    "correcta": 1,
                    "explicacion": "La Fundaci√≥n tiene ¬°cien chalecos! Se cierran con clic-clic y te abrazan para que navegues protegido mientras disfrutas del r√≠o.",
                    "fotoUrl": "chaleco.jpg"
                },
                {
                    "coords": [-34.61042, -58.36870], // Coordenadas de ejemplo
                    "texto": "‚ÄúSerpenteo con agua fresca junto al bosque del parque. ¬øC√≥mo me llamo?‚Äù",
                    "opciones": ["R√≠o Ctalamochita", "R√≠o Suqu√≠a", "Lago San Roque"],
                    "correcta": 0,
                    "explicacion": "Su nombre ind√≠gena significa ‚Äúlugar de muchos √°rboles‚Äù. Con sus curvas suaves forma playitas donde peces, plantas y personas se refrescan.",
                    "fotoUrl": "rioct.jpg"
                },
                {
                    "coords": [-34.61063, -58.36858], // Coordenadas de ejemplo
                    "texto": "‚ÄúTomo sol quieto, tengo escamas y una lengua larga. ¬øQui√©n soy?‚Äù",
                    "opciones": ["Serpiente", "Tortuga", "Lagarto overo"],
                    "correcta": 2,
                    "explicacion": "Este lagarto moteado adora broncearse en los claros del parque. Ayuda a mantener el equilibrio porque se come insectos y peque√±os bichitos.",
                    "fotoUrl": "lagarto.jpg"
                },
                {
                    "coords": [-34.61082, -58.36855], // Coordenadas de ejemplo para las nuevas preguntas
                    "texto": "‚ÄúCuelgo de los √°rboles como una flor que vive del aire. ¬øC√≥mo me llaman?‚Äù",
                    "opciones": ["Orqu√≠dea", "Clavel del aire", "Rosa"],
                    "correcta": 1,
                    "explicacion": "No necesita tierra: bebe la humedad del viento y adorna las ramas con sus hojitas plateadas, ¬°un colgante natural del bosque!",
                    "fotoUrl": "clavel.jpg"
                },
                {
                    "coords": [-34.61100, -58.36843], // Coordenadas de ejemplo
                    "texto": "‚ÄúCuido plantas y animales y ayudo a los visitantes. ¬øQui√©n soy?‚Äù",
                    "opciones": ["Cient√≠fico", "Turista", "Guardaparque"],
                    "correcta": 2,
                    "explicacion": "La guardaparque del Tau es la super-hero√≠na verde: vigila senderos, da consejos y protege cada rinc√≥n del bosque todos los d√≠as.",
                    "fotoUrl": "guarda.png"
                },
                {
                    "coords": [-34.61097, -58.36814], // Coordenadas de ejemplo
                    "texto": "‚ÄúSi tiras basura aqu√≠, ensucias a peces y patos. ¬øQu√© lugar es?‚Äù",
                    "opciones": ["El r√≠o", "El lago", "La calle"],
                    "correcta": 0,
                    "explicacion": "Usar los tachos y llevarte tus residuos mantiene el agua clarita y feliz; as√≠ el r√≠o sigue sano para nadar y remar.",
                    "fotoUrl": "rio.jpg"
                },
                {
                    "coords": [-34.61095, -58.36787], // Coordenadas de ejemplo
                    "texto": "‚ÄúReciclando papel le salvamos la vida a este gran amigo verde. ¬øQui√©n es?‚Äù",
                    "opciones": ["Pasto", "Flor", "√Årbol"],
                    "correcta": 2,
                    "explicacion": "Los √°rboles dan sombra, aire puro y casita a los p√°jaros. En el parque crecen talas, cha√±ares y un hist√≥rico algarrobo blanco que son verdaderos tesoros.",
                    "fotoUrl": "arbol.jpg"
                },
                {
                    "coords": [-34.61091,-58.36750], // Coordenadas de ejemplo
                    "texto": "‚ÄúLlevo gorrita roja y pechito blanco; mi canto suena fuerte. ¬øQu√© p√°jaro soy?‚Äù",
                    "opciones": ["Colibr√≠", "Cardenal com√∫n", "Benteveo"],
                    "correcta": 1,
                    "explicacion": "Con su ‚Äúsombrerito‚Äù rojo brillante, el cardenal es una de las aves m√°s vistosas del parque y se deja ver entre las ramas cantando con energ√≠a.",
                    "fotoUrl": "cardenal.jpg"
                }
            ],
            "10a15": [
                {
                    "coords": [-32.62763, -62.70419],
                    "texto": "¬øCu√°l es la especie de √°rbol nativo m√°s antigua del Parque Francisco Tau, considerada un monumento natural viviente?",
                    "opciones": ["Algarrobo blanco", "Pino", "Eucalipto"],
                    "correcta": 0,
                    "explicacion": "Es un √°rbol nativo t√≠pico de la regi√≥n chaque√±a y pampeana, muy resistente a la sequ√≠a. En el Parque Francisco Tau, el algarrobo blanco aporta sombra y alimento a la fauna local con sus vainas dulces. Adem√°s, su madera es dura y se utiliza tradicionalmente para carpinter√≠a y artesan√≠a. Es una especie clave para mantener el equilibrio ecol√≥gico del √°rea.",
                    "fotoUrl": "algarrobo.jpg" // Ruta directa
                },
                {
                    "coords": [-32.62742, -62.70511],
                    "texto": "¬øQu√© r√≠o atraviesa el Parque Francisco Tau y forma parte importante de su paisaje natural?",
                    "opciones": ["R√≠o Segundo", "R√≠o Primero", "R√≠o Ctalamochita"],
                    "correcta": 2,
                    "explicacion": "El R√≠o Ctalamochita, tambi√©n llamado R√≠o Tercero, atraviesa el Parque Francisco Tau y es fundamental para su ecosistema. Sus aguas forman balnearios naturales como El Diquecito y Paso de la Arena, y brindan h√°bitat a aves acu√°ticas, peces y mam√≠feros como el coipo. Adem√°s de su valor natural y recreativo, funciona como un corredor biol√≥gico, conectando distintos ambientes y favoreciendo la biodiversidad del parque.",
                    "fotoUrl": "rio.jpg" // Ruta directa
                },
                {
                    "coords": [-32.62655, -62.70584],
                    "texto": "¬øA qu√© bioma pertenece el monte nativo que protege el Parque Francisco Tau?",
                    "opciones": ["Chaco H√∫medo", "Espinal", "Selva de Yungas"],
                    "correcta": 1,
                    "explicacion": "El Parque Francisco Tau conserva un relicto del bioma del Espinal, un tipo de bosque nativo de la llanura cordobesa. Se caracteriza por especies resistentes a la sequ√≠a como el algarrobo blanco, el tala, el cha√±ar y el espinillo. Este ecosistema, hoy muy reducido por la expansi√≥n agr√≠cola, es √∫nico en un centro urbano en C√≥rdoba. Su preservaci√≥n es fundamental para conservar la biodiversidad aut√≥ctona, estudiar el ambiente original de la regi√≥n y mantener un pulm√≥n verde para la ciudad.",
                    "fotoUrl": "espinal.jpg" // Ruta directa
                },
                {
                    "coords": [-32.62550, -62.70573],
                    "texto": "¬øCu√°ntas especies de aves, aproximadamente, han sido identificadas en el Parque Francisco Tau?",
                    "opciones": ["100", "135", "125"],
                    "correcta": 2,
                    "explicacion": "El Parque Francisco Tau alberga una gran diversidad de aves, con al menos 125 especies registradas, lo que lo convierte en un sitio ideal para la observaci√≥n de aves. Se encuentran 					especies comunes y vistosas como el hornero, el benteveo, el cardenal com√∫n y el chingolo, as√≠ como aves acu√°ticas como el bigu√°, la gallareta y el mart√≠n pescador chico. Tambi√©n se 					observan aves rapaces como el carancho y la lechucita de las vizcacheras.\n\t\t\t\t\tLa variedad de h√°bitats del parque (bosque, ribera, pastizal) favorece esta riqueza avifaun√≠stica, que es clave para el equilibrio ecol√≥gico y un gran recurso para la educaci√≥n 					ambiental.",
                    "fotoUrl": "ave.jpg" // Ruta directa
                },
                {
                    "coords": [-32.62451, -62.70495],
                    "texto": "¬øQu√© roedor semiacu√°tico, parecido a una nutria, habita en las orillas del R√≠o Ctalamochita dentro del parque?",
                    "opciones": ["Comadreja overa", "Coipo", "Cuis"],
                    "correcta": 1,
                    "explicacion": "El coipo, tambi√©n llamado nutria criolla, es un mam√≠fero roedor semiacu√°tico que vive en zonas cercanas al agua, como las orillas del R√≠o Ctalamochita, dentro del Parque Francisco Tau. 					Tiene un cuerpo robusto, pelaje denso e impermeable, y una cola larga y redondeada. Sus patas traseras palmeadas le permiten nadar con gran agilidad. Se alimenta principalmente de vegetaci√≥n 						acu√°tica y ra√≠ces, y suele construir madrigueras en barrancas o entre la vegetaci√≥n ribere√±a. Es una especie nativa de Am√©rica del Sur y cumple un rol ecol√≥gico importante en el ecosistema 						acu√°tico, ayudando a controlar el crecimiento de plantas en lagunas y r√≠os. Su presencia en el parque indica una buena calidad ambiental en los ambientes ribere√±os y la existencia de refugio 						adecuado para fauna nativa.",
                    "fotoUrl": "coipo.jpg" // Ruta directa
                }
            ],
            "mayor15": [
                {
                    "coords": [-32.62763, -62.70419],
                    "texto": "¬øQu√© especie arb√≥rea aut√≥ctona, propia del Espinal y con un ejemplar de m√°s de cuatro siglos en el parque, representa un testimonio ecol√≥gico e hist√≥rico de la regi√≥n?",
                    "opciones": ["Algarrobo blanco", "Pino", "Eucalipto"],
                    "correcta": 0,
                    "explicacion": "Es un √°rbol nativo t√≠pico de la regi√≥n chaque√±a y pampeana, muy resistente a la sequ√≠a. En el Parque Francisco Tau, el algarrobo blanco aporta sombra y alimento a la fauna local con sus vainas dulces. Adem√°s, su madera es dura y se utiliza tradicionalmente para carpinter√≠a y artesan√≠a. Es una especie clave para mantener el equilibrio ecol√≥gico del √°rea.",
                    "fotoUrl": "algarrobo.jpg" // Ruta directa
                },
                {
                    "coords": [-32.62742,-62.70511],
                    "texto": "¬øCu√°l es el curso fluvial que recorre el parque, funcionando como corredor biol√≥gico y aportando ambientes acu√°ticos y ribere√±os?",
                    "opciones": ["R√≠o Primero", "R√≠o Ctalamochita", "R√≠o Segundo"],
                    "correcta": 1,
                    "explicacion": "El R√≠o Ctalamochita, tambi√©n llamado R√≠o Tercero, atraviesa el Parque Francisco Tau y es fundamental para su ecosistema. Sus aguas forman balnearios naturales como El Diquecito y Paso de la Arena, y brindan h√°bitat a aves acu√°ticas, peces y mam√≠feros como el coipo. Adem√°s de su valor natural y recreativo, funciona como un corredor biol√≥gico, conectando distintos ambientes y favoreciendo la biodiversidad del parque.",
                    "fotoUrl": "rio.jpg" // Ruta directa
                },
                {
                    "coords": [-32.62655, -62.70584],
                    "texto": "¬øCu√°l es el nombre de la ecorregi√≥n fitogeogr√°fica representada por el relicto conservado en el Parque Francisco Tau?",
                    "opciones": ["Selva de Yungas", "Chaco H√∫medo", "Espinal"],
                    "correcta": 0,
                    "explicacion": "El Parque Francisco Tau conserva un relicto del bioma del Espinal, un tipo de bosque nativo de la llanura cordobesa. Se caracteriza por especies resistentes a la sequ√≠a como el algarrobo blanco, el tala, el cha√±ar y el espinillo. Este ecosistema, hoy muy reducido por la expansi√≥n agr√≠cola, es √∫nico en un centro urbano en C√≥rdoba. Su preservaci√≥n es fundamental para conservar la biodiversidad aut√≥ctona, estudiar el ambiente original de la regi√≥n y mantener un pulm√≥n verde para la ciudad.",
                    "fotoUrl": "espinal.jpg" // Ruta directa
                },
                {
                    "coords": [-32.62550, -62.70573],
                    "texto": "Seg√∫n relevamientos recientes, ¬øcu√°ntas especies avifaun√≠sticas habitan actualmente el Parque Francisco Tau?",
                    "opciones": ["125", "135", "115"],
                    "correcta": 0,
                    "explicacion": "El Parque Francisco Tau alberga una gran diversidad de aves, con al menos 125 especies registradas, lo que lo convierte en un sitio ideal para la observaci√≥n de aves. Se encuentran 					especies comunes y vistosas como el hornero, el benteveo, el cardenal com√∫n y el chingolo, as√≠ como aves acu√°ticas como el bigu√°, la gallareta y el mart√≠n pescador chico. Tambi√©n se 					observan aves rapaces como el carancho y la lechucita de las vizcacheras.\n\t\t\t\t\tLa variedad de h√°bitats del parque (bosque, ribera, pastizal) favorece esta riqueza avifaun√≠stica, que es clave para el equilibrio ecol√≥gico y un gran recurso para la educaci√≥n 					ambiental.",
                    "fotoUrl": "ave.jpg" // Ruta directa
                },
                {
                    "coords": [-32.62451, -62.70495],
                    "texto": "¬øCu√°l es el mam√≠fero nativo de h√°bitos ribere√±os, identificado como Myocastor coypus, registrado en el Parque Francisco Tau?",
                    "opciones": ["Comadreja overa", "Cuis", "Coipo"],
                    "correcta": 2,
                    "explicacion": "El coipo (Myocastor coypus) es un roedor semiacu√°tico nativo, clave en los ecosistemas ribere√±os del parque, contribuyendo al control de la vegetaci√≥n acu√°tica.",
                    "fotoUrl": "coipo.jpg" // Ruta directa
                }
            ]
        };

        let edadSeleccionada = null;
        let progreso = {
            actual: 0,
            puntaje: 0,
            intentos: {}
        }; // `intentos` ahora tambi√©n se usa para marcar si una pregunta ha sido activada
        let mapa;
        let marcadorUbicacion;
        let ubicacionWatchId = null;
        const ACTIVATION_RADIUS = 10; // Meters
        const preguntaMarkers = [];
        let currentQuestionRadiusCircle = null;
        let sonidoActivado = true; // New variable for sound control
        let supportsWebP = false; // Flag to check WebP support

        // Variables for Audio Recording (no longer used for direct buttons, but kept in case of future voice input)
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        // Get computed style for CSS variables
        const computedStyles = getComputedStyle(document.documentElement);
        const colorErrorRojo = computedStyles.getPropertyValue('--color-error-rojo').trim();

        // DOM Elements (cache)
        const ventanaBienvenida = document.getElementById("ventana-bienvenida");
        const ventanaInstrucciones = document.getElementById("ventana-instrucciones");
        const ventanaPregunta = document.getElementById("pregunta");
        const ventanaFinal = document.getElementById("ventana-final");
        const ventanaFelicitacion = document.getElementById("ventana-felicitacion"); // Nueva ventana de felicitaci√≥n
        const panelProgreso = document.getElementById("panel-progreso");
        const botonesFijos = document.getElementById("botones-fijos");
        const sonidoCorrecto = document.getElementById("sonido-correcto");
        const sonidoIncorrecto = document.getElementById("sonido-incorrecto");
        const botonToggleSonido = document.getElementById("boton-toggle-sonido");
        const iconSoundOn = document.getElementById("icon-sound-on");
        const iconSoundOff = document.getElementById("icon-sound-off");
        // Chatbot DOM Elements
        const chatbotWrapper = document.getElementById("chatbot-wrapper");
        const chatbotToggleButton = document.getElementById("chatbot-toggle-button");
        const chatbotContainer = document.getElementById("chatbot-container");
        const chatCloseButton = document.getElementById("chat-close-button");
        const chatMessages = document.getElementById("chat-messages");
        const chatUserInput = document.getElementById("chat-user-input");
        const chatSendButton = document.getElementById("chat-send-button");
        // Removed: chatImageInput, chatImageButton, chatAudioButton


        // --- Helper Functions ---

        /**
         * Checks if the browser supports WebP image format.
         * @returns {Promise<boolean>} A promise that resolves to true if WebP is supported, false otherwise.
         */
        function checkWebPSupport() {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function () {
                    resolve(img.width > 0 && img.height > 0);
                };
                img.onerror = function () {
                    resolve(false);
                };
                img.src = 'data:image/webp;base64,UklGRhoAAABXRUJQVlA4TA0AAAAvAAAAEAcQERGIiP4HAA==';
            });
        }

        /**
         * Loads an image directly without srcset or WebP conversion, as per user's request.
         * @param {HTMLImageElement} imgElement The <img> element to load.
         */
        function loadImage(imgElement) {
            // Simply set the src attribute. The fotoUrl from preguntasData will be directly assigned.
            // No data-src or data-srcset needed here as the src will be updated directly.
            // No WebP conversion as per user's direct image names.
        }


        /**
         * Plays a sound if sound is activated.
         * @param {HTMLAudioElement} audio A reference to the audio element.
         */
        function reproducirSonido(audio) {
            if (sonidoActivado) {
                audio.currentTime = 0; // Rewind to start
                audio.play();
            }
        }

        // Variable global para el elemento de audio de la alarma
        let alarmaAudio;

        // Funci√≥n para reproducir el sonido de alarma
        function reproducirAlarma() {
            if (!alarmaAudio) {
                alarmaAudio = document.getElementById('alarmaSonido');
                // Opcional: ajustar el volumen si es necesario
                // alarmaAudio.volume = 0.7; // Ejemplo: 70% del volumen
            }

            // Solo reproduce si el sonido est√° habilitado y el audio est√° cargado
            // readyState >= 2 significa que el audio est√° cargado lo suficiente para reproducirse
            if (sonidoActivado && alarmaAudio && alarmaAudio.readyState >= 2) {
                alarmaAudio.currentTime = 0; // Reinicia el sonido si ya se est√° reproduciendo
                alarmaAudio.play().catch(e => console.error("Error al reproducir la alarma:", e));
            } else {
                console.warn("Alarma no reproducida: sonido deshabilitado o audio no cargado.", { sonidoActivado, readyState: alarmaAudio ? alarmaAudio.readyState : 'N/A' });
            }
        }

        /**
         * Triggers haptic feedback (vibration) on supported devices.
         * @param {number|Array<number>} pattern The vibration pattern in milliseconds.
         */
        function feedbackHaptico(pattern = 50) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        /**
         * Reproduce un texto dado usando la API de s√≠ntesis de voz del navegador.
         * @param {string} text El texto a reproducir.
         */
        function reproducirTexto(text) {
            if ('speechSynthesis' in window && sonidoActivado) { // Agregada la condici√≥n sonidoActivado
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES'; // Establece el idioma a espa√±ol
                utterance.volume = 1; // Volumen (0 a 1)
                utterance.rate = 1; // Velocidad (0.1 a 10)
                utterance.pitch = 1; // Tono (0 a 2)

                // Detener cualquier reproducci√≥n anterior para evitar solapamientos
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utterance);
            } else if (!('speechSynthesis' in window)) {
                console.warn("La API de s√≠ntesis de voz no est√° soportada en este navegador.");
            }
            // No hace nada si sonidoActivado es falso.
        }

        /**
         * Creates and displays a custom modal.
         * @param {string} titulo The modal title.
         * @param {string} mensaje The main modal message.
         * @param {Array<Object>} botonesConfig Array of objects to configure buttons.
         * Ej: [{ texto: 'OK', clase: 'boton-confirmacion', callback: () => {} }]
         */
        function crearModalPersonalizado(titulo, mensaje, botonesConfig) {
            const modalExistente = document.querySelector('.custom-js-modal');
            if (modalExistente) {
                document.body.removeChild(modalExistente); // Remove previous modal if exists
            }

            const modal = document.createElement('div');
            modal.className = 'custom-js-modal';
            modal.setAttribute('role', 'alertdialog'); // More specific than 'dialog' for messages
            modal.setAttribute('aria-modal', 'true');

            const modalTitulo = document.createElement('h3');
            modalTitulo.textContent = titulo;
            modal.appendChild(modalTitulo);
            // Assign ID to title for aria-labelledby
            const tituloId = 'custom-modal-titulo-' + Date.now();
            modalTitulo.id = tituloId;
            modal.setAttribute('aria-labelledby', tituloId);


            const modalMensaje = document.createElement('p');
            modalMensaje.innerHTML = mensaje; // Use innerHTML if message can have simple HTML like <strong>
            modal.appendChild(modalMensaje);

            const botonesDiv = document.createElement('div');
            botonesDiv.className = 'modal-botones';

            botonesConfig.forEach(btnConfig => {
                const button = document.createElement("button");
                button.textContent = btnConfig.texto;
                if (btnConfig.clase) {
                    button.classList.add(...btnConfig.clase.split(' ')); // Allows multiple classes
                }
                button.addEventListener('click', () => {
                    if (btnConfig.callback) {
                        btnConfig.callback();
                    }
                    document.body.removeChild(modal);
                });
                botonesDiv.appendChild(button);
            });

            modal.appendChild(botonesDiv);
            document.body.appendChild(modal);
            // Focus the first button of the modal for accessibility
            if (botonesDiv.firstChild && typeof botonesDiv.firstChild.focus === 'function') {
                botonesDiv.firstChild.focus();
            }
        }

        function obtenerPreguntas() {
            return preguntasData[edadSeleccionada] || [];
        }

        // --- Main Game Logic ---

        function seleccionarEdad(rango) {
            edadSeleccionada = rango;

            ventanaBienvenida.classList.remove("mostrar");
            iniciarMapa();
            ventanaInstrucciones.classList.add("mostrar");
            // Focus the start button in instructions
            document.getElementById("boton-comenzar-instrucciones").focus();

            // A√±adir reproducci√≥n de audio al mostrar la ventana de bienvenida (se mueve aqu√≠ para requerir interacci√≥n del usuario)
            const tituloBienvenida = document.getElementById("titulo-bienvenida").textContent;
            const parrafoBienvenida = document.querySelector("#ventana-bienvenida p").textContent;
            reproducirTexto(tituloBienvenida + " " + parrafoBienvenida);

            // A√±adir reproducci√≥n de audio al mostrar la ventana de instrucciones
            const textoInstrucciones = document.getElementById("titulo-instrucciones").textContent + " " +
                Array.from(document.querySelectorAll("#ventana-instrucciones p")).map(p => p.textContent).join(" ");
            reproducirTexto(textoInstrucciones);
        }

        function cerrarVentanaInstrucciones() {
            ventanaInstrucciones.classList.remove("mostrar");
            // Al cerrar las instrucciones, cancela cualquier audio de voz en curso.
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
            if (!ubicacionWatchId) {
                iniciarSeguimientoUbicacion();
            }
        }

        function iniciarMapa() {
            const primerasPreguntas = obtenerPreguntas();
            if (primerasPreguntas.length === 0) {
                crearModalPersonalizado("Error", "No hay preguntas para el rango de edad seleccionado.", [{
                    texto: "Cerrar"
                }]);
                return;
            }
            // Inicializa el mapa centrado en la primera pregunta
            mapa = L.map('map').setView(primerasPreguntas[0].coords, 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(mapa);

            // Clear previous markers if map is restarted
            preguntaMarkers.forEach(marker => marker.remove());
            preguntaMarkers.length = 0; // Empty array

            primerasPreguntas.forEach((p, index) => {
                // Los marcadores de preguntas se a√±aden inicialmente con opacidad baja y no interactivos
                // Se har√°n visibles y se activar√°n autom√°ticamente al entrar en el radio
                const marker = L.marker(p.coords, {
                    opacity: 0.5,
                    interactive: false
                });
                p.marker = marker;
                preguntaMarkers.push(marker);
            });

            actualizarPanelProgreso();
            botonesFijos.style.display = "flex"; /* Use flex for fixed buttons */
            panelProgreso.style.display = "block";
        }

        function actualizarVisibilidadMarcadorActual() {
            if (progreso.actual < obtenerPreguntas().length) {
                const preguntaActual = obtenerPreguntas()[progreso.actual];
                // Asegura que el marcador de la pregunta actual sea visible y con opacidad completa
                if (preguntaActual.marker && !mapa.hasLayer(preguntaActual.marker)) {
                    preguntaActual.marker.setOpacity(1).addTo(mapa);
                }
                // Actualiza o crea el c√≠rculo de radio para la pregunta actual
                if (currentQuestionRadiusCircle) {
                    mapa.removeLayer(currentQuestionRadiusCircle);
                }
                currentQuestionRadiusCircle = L.circle(L.latLng(preguntaActual.coords), {
                    color: 'blue',
                    fillColor: '#0000ff',
                    fillOpacity: 0.2,
                    radius: ACTIVATION_RADIUS
                }).addTo(mapa);
            } else if (currentQuestionRadiusCircle) { // Si no hay m√°s preguntas, remueve el c√≠rculo
                mapa.removeLayer(currentQuestionRadiusCircle);
                currentQuestionRadiusCircle = null;
            }
        }

        /**
         * Muestra la ventana de felicitaci√≥n con la explicaci√≥n de la respuesta correcta,
         * una imagen del lugar y un audio.
         * @param {Object} pregunta El objeto de la pregunta actual.
         */
        function mostrarFelicitacionCorrecta(pregunta) {
            const felicitacionImagen = document.getElementById("felicitacion-imagen");
            // Se asigna directamente la fotoUrl de la pregunta al src de la imagen
            felicitacionImagen.src = pregunta.fotoUrl;
            // Se limpian los atributos data-src y data-srcset ya que no se usar√°n m√°s
            felicitacionImagen.removeAttribute('data-src');
            felicitacionImagen.removeAttribute('data-srcset');
            felicitacionImagen.removeAttribute('sizes'); // Tambi√©n remover sizes si no se usa srcset
            felicitacionImagen.alt = `Imagen relacionada con la pregunta: ${pregunta.texto}`; // Mejorar el alt

            document.getElementById("felicitacion-explicacion").textContent = pregunta.explicacion;

            ventanaFelicitacion.classList.add("mostrar");

            // Reproducir el audio si el sonido est√° activado
            if (sonidoActivado) {
                sonidoCorrecto.currentTime = 0;
                sonidoCorrecto.play();
            }
            feedbackHaptico(100); // Short vibration for correct answer

            // Reproducir el texto de la explicaci√≥n de la felicitaci√≥n
            reproducirTexto(pregunta.explicacion);

            // Centrar el foco en el bot√≥n de continuar para accesibilidad
            document.getElementById("boton-continuar-felicitacion").focus();

            // Listener para el bot√≥n "Continuar" de la ventana de felicitaci√≥n
            const botonContinuar = document.getElementById("boton-continuar-felicitacion");
            // Remover listener previo para evitar m√∫ltiples ejecuciones
            const oldListener = botonContinuar._currentListener;
            if (oldListener) {
                botonContinuar.removeEventListener('click', oldListener);
            }

            const newListener = () => {
                if ('speechSynthesis' in window) { // Detener la s√≠ntesis de voz al cerrar
                    window.speechSynthesis.cancel();
                }
                ventanaFelicitacion.classList.remove("mostrar");

                // Continuar con la l√≥gica del juego despu√©s de la felicitaci√≥n
                pregunta.marker.setOpacity(0.4);
                pregunta.marker.options.interactive = false;

                if (currentQuestionRadiusCircle) {
                    mapa.removeLayer(currentQuestionRadiusCircle);
                    currentQuestionRadiusCircle = null;
                }

                progreso.actual++;
                actualizarPanelProgreso();
                actualizarVisibilidadMarcadorActual();

                if (progreso.actual >= obtenerPreguntas().length) {
                    mostrarVentanaFinal();
                }
                ventanaPregunta.classList.remove("mostrar"); // Cierra la ventana de la pregunta
            };
            botonContinuar.addEventListener('click', newListener);
            botonContinuar._currentListener = newListener; // Guarda el listener para poder removerlo
        }

        function mostrarPregunta(index) {
            // console.log(`[mostrarPregunta] Intentando mostrar pregunta ${index}. Progreso actual: ${progreso.actual}. Ventana visible: ${ventanaPregunta.classList.contains('mostrar')}`);
            // Solo muestra la pregunta si es la actual y la ventana no est√° ya abierta
            if (index !== progreso.actual || ventanaPregunta.classList.contains('mostrar')) {
                // console.log(`[mostrarPregunta] Retornando: index !== progreso.actual (${index !== progreso.actual}) o ventana ya visible (${ventanaPregunta.classList.contains('mostrar')})`);
                return;
            }

            const p = obtenerPreguntas()[index];
            const preguntaId = `pregunta_${index}`;
            // Inicializa los intentos si la pregunta se activa por primera vez
            progreso.intentos[preguntaId] = progreso.intentos[preguntaId] || 0;

            document.getElementById("texto-pregunta").textContent = p.texto;
            const opcionesDiv = document.getElementById("opciones");
            opcionesDiv.innerHTML = "";
            // explicacionRespuestaDiv.innerHTML = ""; // Ya no es necesario aqu√≠ para respuestas correctas
            // explicacionRespuestaDiv.classList.remove('mostrar'); // Ya no es necesario aqu√≠ para respuestas correctas

            // Use DocumentFragment for efficient DOM manipulation
            const fragment = document.createDocumentFragment();

            p.opciones.forEach((opcion, i) => {
                const btn = document.createElement("button");
                btn.textContent = opcion;
                btn.addEventListener('click', () => {
                    if (i === p.correcta) {
                        reproducirSonido(sonidoCorrecto);
                        feedbackHaptico(100); // Short vibration for correct answer
                        const puntosGanados = Math.max(0, 3 - progreso.intentos[preguntaId]);
                        progreso.puntaje += puntosGanados;

                        // MOSTRAR LA NUEVA VENTANA DE FELICITACI√ìN
                        mostrarFelicitacionCorrecta(p);

                    } else {
                        reproducirSonido(sonidoIncorrecto);
                        feedbackHaptico([200, 100, 200]); // Pattern vibration for incorrect answer
                        progreso.intentos[preguntaId]++;
                        // Para respuestas incorrectas, todav√≠a se puede usar la explicaci√≥n original si se desea.
                        // Pero para el alcance de este pedido, se enfoca en la correcta.
                        // Si quieres una explicaci√≥n para incorrectas, puedes volver a habilitar el div.
                        crearModalPersonalizado(
                            "Respuesta Incorrecta",
                            "¬°Ups! Esa no es la respuesta. Intent√° de nuevo.",
                            [{
                                texto: "Entendido",
                                clase: "boton-negacion"
                            }] // No es necesario callback para ocultar explicaci√≥n aqu√≠
                        );
                    }
                });
                fragment.appendChild(btn);
            });
            opcionesDiv.appendChild(fragment); // Append all buttons at once
            ventanaPregunta.classList.add("mostrar");
            // console.log(`[mostrarPregunta] Ventana de pregunta mostrada. Display style: ${window.getComputedStyle(ventanaPregunta).display}`);
            // Focus the first answer option for accessibility
            if (opcionesDiv.firstChild && typeof opcionesDiv.firstChild.focus === 'function') {
                opcionesDiv.firstChild.focus();
            }
        }

        function iniciarSeguimientoUbicacion() {
            // console.log("[iniciarSeguimientoUbicacion] Iniciando seguimiento de ubicaci√≥n.");
            if (!navigator.geolocation) {
                crearModalPersonalizado("Error de Geolocalizaci√≥n", "La geolocalizaci√≥n no est√° soportada por tu navegador.", [{
                    texto: "Cerrar"
                }]);
                console.error("[iniciarSeguimientoUbicacion] Geolocalizaci√≥n no soportada.");
                return;
            }

            // Si ya estamos rastreando la ubicaci√≥n, no iniciar otro seguimiento.
            if (ubicacionWatchId !== null) {
                // console.log("[iniciarSeguimientoUbicacion] Seguimiento ya activo. Centrando mapa si hay marcador.");
                if (marcadorUbicacion) mapa.setView(marcadorUbicacion.getLatLng(), 17);
                return;
            }

            ubicacionWatchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const userLocation = L.latLng(pos.coords.latitude, pos.coords.longitude);
                    // console.log(`[iniciarSeguimientoUbicacion] Ubicaci√≥n actual: Lat ${userLocation.lat}, Lng ${userLocation.lng}`);

                    if (marcadorUbicacion) {
                        marcadorUbicacion.setLatLng(userLocation);
                    } else {
                        marcadorUbicacion = L.marker(userLocation, {
                            icon: L.divIcon({
                                className: 'leaflet-div-icon',
                                html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#E53935"><path d="M12 2c-4.418 0-8 3.582-8 8 0 7 8 12 8 12s8-5 8-12c0-4.418-3.582-8-8-8zm0 11c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3z"/></svg>',
                                iconSize: [30, 30],
                                iconAnchor: [15, 30]
                            }) // Custom SVG for user location
                        }).addTo(mapa).bindPopup("¬°Est√°s aqu√≠!");
                        mapa.setView(userLocation, 17); // Center on first detection
                    }

                    // L√≥gica de activaci√≥n de la pregunta
                    if (progreso.actual < obtenerPreguntas().length) {
                        const preguntaActual = obtenerPreguntas()[progreso.actual];
                        const preguntaId = `pregunta_${progreso.actual}`; // ID √∫nico para la pregunta actual
                        const preguntaLocation = L.latLng(preguntaActual.coords);
                        const distance = userLocation.distanceTo(preguntaLocation);
                        // console.log(`[iniciarSeguimientoUbicacion] Pregunta actual: ${progreso.actual}. Distancia a la pregunta: ${distance.toFixed(2)}m. Radio de activaci√≥n: ${ACTIVATION_RADIUS}m.`);

                        // Asegurar que el marcador de la pregunta actual sea visible
                        if (preguntaActual.marker && !mapa.hasLayer(preguntaActual.marker)) {
                            preguntaActual.marker.setOpacity(1).addTo(mapa);
                            // console.log(`[iniciarSeguimientoUbicacion] Marcador de pregunta ${progreso.actual} a√±adido/visible.`);
                        }
                        // Actualizar o crear el c√≠rculo de radio para la pregunta actual
                        actualizarVisibilidadMarcadorActual();

                        // Verificar si la pregunta ya ha sido activada/respondida en este intento
                        // Usamos `progreso.intentos[preguntaId] !== undefined` para saber si ya se ha "tocado" esta pregunta.
                        const preguntaYaActivada = (progreso.intentos[preguntaId] !== undefined);
                        // console.log(`[iniciarSeguimientoUbicacion] Pregunta ${preguntaId} ya activada (progreso.intentos): ${preguntaYaActivada}`);

                        // Si la distancia es menor o igual al radio de activaci√≥n
                        // Y la ventana de la pregunta NO est√° visible actualmente (para evitar re-abrirla)
                        // Y la pregunta a√∫n NO ha sido activada autom√°ticamente
                        if (distance <= ACTIVATION_RADIUS && !ventanaPregunta.classList.contains('mostrar') && !preguntaYaActivada && !ventanaFelicitacion.classList.contains('mostrar')) { // A√±adida condici√≥n para la ventana de felicitaci√≥n
                            // console.log(`[iniciarSeguimientoUbicacion] Condici√≥n de activaci√≥n cumplida para pregunta ${progreso.actual}.`);

                            // Reproducir sonido de alarma al entrar en el radio
                            reproducirAlarma();

                            // Marca la pregunta como "activada" para evitar activaciones m√∫ltiples
                            progreso.intentos[preguntaId] = 0; // Inicializa los intentos a 0 para esta pregunta
                            // console.log(`[iniciarSeguimientoUbicacion] Marcando pregunta ${preguntaId} como activada.`);

                            // Si el marcador estaba interactivo (por un clic manual previo, aunque ahora es autom√°tico),
                            // asegura que no lo sea m√°s y cierra cualquier tooltip.
                            if (preguntaActual.marker.options.interactive) {
                                preguntaActual.marker.closeTooltip();
                                preguntaActual.marker.options.interactive = false;
                                // console.log(`[iniciarSeguimientoUbicacion] Desactivando interactividad del marcador.`);
                            }

                            // Centra el mapa en la pregunta activada (mejora la UX)
                            mapa.setView(preguntaLocation, 17);
                            // console.log(`[iniciarSeguimientoUbicacion] Mapa centrado en la pregunta.`);

                            // Muestra la pregunta autom√°ticamente
                            mostrarPregunta(progreso.actual);

                            // Notificar al usuario que una pregunta se ha activado autom√°ticamente
                            crearModalPersonalizado("¬°Pregunta Activa!", "Est√°s en el lugar de la pr√≥xima pregunta. ¬°Responde!", [{
                                texto: "OK"
                            }]);
                            // console.log(`[iniciarSeguimientoUbicacion] Modal de 'Pregunta Activa' mostrado.`);

                        } else if (distance > ACTIVATION_RADIUS) {
                            // Si el usuario se aleja del radio, aseg√∫rate de que el marcador no sea interactivo
                            // y cierra el tooltip si estaba abierto.
                            if (preguntaActual.marker.options.interactive) {
                                preguntaActual.marker.options.interactive = false;
                                preguntaActual.marker.closeTooltip();
                                // console.log(`[iniciarSeguimientoUbicacion] Usuario fuera de radio, marcador deshabilitado.`);
                            }
                        }
                    } else {
                        // console.log("[iniciarSeguimientoUbicacion] No hay m√°s preguntas o progreso.actual fuera de rango.");
                    }
                },
                (err) => {
                    console.error(`ERROR(${err.code}): ${err.message}`);
                    crearModalPersonalizado(
                        "Error de Geolocalizaci√≥n",
                        `No se pudo obtener tu ubicaci√≥n: ${err.message}. Verifica los permisos.`,
                        [{
                            texto: "Cerrar"
                        }]
                    );
                    if (ubicacionWatchId !== null) {
                        navigator.geolocation.clearWatch(ubicacionWatchId);
                        ubicacionWatchId = null;
                    }
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
            // Una vez que se inicia el seguimiento, muestra el primer marcador y su c√≠rculo de radio.
            actualizarVisibilidadMarcadorActual();
        }


        function actualizarPanelProgreso() {
            const totalPreguntas = obtenerPreguntas().length;
            const porcentaje = totalPreguntas > 0 ? Math.round((progreso.actual / totalPreguntas) * 100) : 0;
            document.getElementById("progreso-porcentaje").style.width = porcentaje + "%";
            document.getElementById("progreso-texto").textContent =
                `${progreso.actual} / ${totalPreguntas} preguntas respondidas - Puntaje: ${progreso.puntaje} / ${totalPreguntas * 3}`;
        }

        function reiniciarTrivia() {
            crearModalPersonalizado(
                "Reiniciar Trivia",
                "¬øEst√°s seguro que quer√©s reiniciar tu progreso? Se perder√° todo.",
                [{
                    texto: "S√≠, reiniciar",
                    clase: "boton-negacion",
                    callback: () => location.reload()
                },
                {
                    texto: "No, continuar",
                    clase: "boton-confirmacion"
                }
                ]
            );
        }

        function mostrarVentanaFinal() {
            const totalPreguntas = obtenerPreguntas().length;
            document.getElementById("puntaje-final").textContent = `${progreso.puntaje} / ${totalPreguntas * 3}`;
            const porcentajeScore = totalPreguntas > 0 ? progreso.puntaje / (totalPreguntas * 3) : 0;
            let mensaje = "";
            if (porcentajeScore < 0.4) mensaje = "Debes estudiar m√°s de la fauna y flora de nuestro parque. ¬°Vuelve a intentarlo!";
            else if (porcentajeScore <= 0.6) mensaje = "Tienes conocimientos b√°sicos de nuestra flora y fauna. ¬°Puedes esforzarte un poco m√°s!";
            else if (porcentajeScore <= 0.89) mensaje = "Tienes muy buenos conocimientos del parque. ¬°Un poco m√°s de estudio y lo aprender√°s todo!";
            else mensaje = "¬°Eres un experto conocedor del Parque Francisco Tau!";

            document.getElementById("mensaje-final").textContent = mensaje;
            ventanaFinal.classList.add("mostrar");
            document.getElementById("boton-cerrar-final").focus(); // Focus close button

            // Detiene el seguimiento de ubicaci√≥n y remueve el c√≠rculo de radio al finalizar la trivia
            if (ubicacionWatchId !== null) {
                navigator.geolocation.clearWatch(ubicacionWatchId);
                ubicacionWatchId = null;
            }
            if (currentQuestionRadiusCircle) {
                mapa.removeLayer(currentQuestionRadiusCircle);
                currentQuestionRadiusCircle = null;
            }
            // Tambi√©n det√©n cualquier s√≠ntesis de voz en curso al finalizar la trivia.
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
        }

        function cerrarVentanaFinal() {
            ventanaFinal.classList.remove("mostrar");
            // Optional: Redirect or show welcome again for another round
            // ventanaBienvenida.classList.add("mostrar");
            // progreso = { actual: 0, puntaje: 0, intentos: {} }; // Reset progress if you want to play again without reloading
            // actualizarPanelProgreso();
        }

        function accionMostrarUbicacion() {
            if (marcadorUbicacion && mapa.hasLayer(marcadorUbicacion)) {
                mapa.setView(marcadorUbicacion.getLatLng(), 17); // Center on known location
                marcadorUbicacion.openPopup();
            } else if (!ubicacionWatchId) {
                // Si no se ha iniciado el seguimiento, lo inicia
                iniciarSeguimientoUbicacion();
                crearModalPersonalizado("Ubicaci√≥n", "Iniciando seguimiento de ubicaci√≥n para mostrarte en el mapa.", [{
                    texto: "OK"
                }]);
            } else {
                // Si el seguimiento est√° activo pero no hay ubicaci√≥n a√∫n
                crearModalPersonalizado("Ubicaci√≥n", "Esperando se√±al de GPS para mostrar tu ubicaci√≥n...", [{
                    texto: "OK"
                }]);
            }
        }

        function toggleSonido() {
            sonidoActivado = !sonidoActivado;
            if (sonidoActivado) {
                iconSoundOn.style.display = 'inline-block';
                iconSoundOff.style.display = 'none';
            } else {
                iconSoundOn.style.display = 'none';
                iconSoundOff.style.display = 'inline-block';
                if ('speechSynthesis' in window) { // Si el sonido se desactiva, cancela cualquier voz en curso.
                    window.speechSynthesis.cancel();
                }
            }
            crearModalPersonalizado("Sonido", `Sonido ${sonidoActivado ? 'activado' : 'desactivado'}.`, [{
                texto: "OK"
            }]);
        }

        // --- Chatbot Logic ---

        /**
         * Toggles the visibility of the chatbot container.
         */
        function toggleChatbotVisibility() {
            chatbotContainer.classList.toggle('mostrar');
            // Log for debugging visibility
            console.log('Chatbot container toggled. Has "mostrar" class:', chatbotContainer.classList.contains('mostrar'));
            if (chatbotContainer.classList.contains('mostrar')) {
                chatUserInput.focus(); // Focus input when chat opens
                chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
            }
        }

        /**
         * Adds a message to the chat display.
         * @param {string} sender 'user' or 'chatbot'.
         * @param {string} text The text message to display (optional).
         * @param {string} imageUrl URL of the image to display (optional).
         * @param {string} audioUrl URL of the audio to display (optional).
         */
        function addChatMessage(sender, text = null, imageUrl = null, audioUrl = null) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('chat-message', `${sender}-message`);

            const bubble = document.createElement('div');
            bubble.classList.add('bubble');

            if (text) {
                bubble.textContent = text;
            }
            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = `Imagen de ${sender}`;
                bubble.appendChild(img);
            }
            if (audioUrl) {
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = audioUrl;
                bubble.appendChild(audio);
            }

            messageWrapper.appendChild(bubble);
            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
        }

        /**
         * Simulates sending a message (text, audio, or image) to the chatbot backend
         * and receiving a response.
         * In a real application, this would be a fetch call to your backend server.
         * @param {Object} payload Object containing message data.
         * @param {string} payload.text The text message (optional).
         * @param {string} payload.audioData Base64 encoded audio data (optional).
         * @param {string} payload.imageData Base64 encoded image data (optional).
         */
        async function simulateChatbotResponse(payload) {
            const { text, audioData, imageData } = payload;

            // Display user's input (text, image, or audio)
            if (text) {
                addChatMessage('user', text);
            } else if (imageData) {
                addChatMessage('user', null, imageData);
            } else if (audioData) {
                addChatMessage('user', null, null, audioData);
            }
            chatUserInput.value = ''; // Clear text input

            // Simulate typing/processing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.classList.add('chat-message', 'chatbot-message');
            typingIndicator.innerHTML = '<div class="bubble">Escribiendo...</div>'; // Simple typing indicator
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                // --- ESTA ES LA PARTE DONDE SE LLAMAR√çA A TU API DE BACKEND ---
                // Se har√° una llamada al LLM utilizando el Gemini API.
                // Aseg√∫rate de que el 'prompt' sea lo suficientemente descriptivo para el LLM.
                let chatHistory = [];
                // Se podr√≠a construir el historial de chat para el LLM si se quiere un contexto conversacional m√°s largo.
                // Por ahora, solo se env√≠a el mensaje actual del usuario como prompt.
                let prompt = text || "Necesito una respuesta general ya que el mensaje fue de tipo no-texto.";

                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payloadLLM = { contents: chatHistory };
                const apiKey = ""; // La API key ser√° provista por el entorno de Canvas.
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payloadLLM)
                });
                const result = await response.json(); // Esperar la resoluci√≥n de la promesa JSON

                let chatbotReply = 'Lo siento, no pude generar una respuesta en este momento.';
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    chatbotReply = result.candidates[0].content.parts[0].text;
                } else {
                    console.error('Estructura de respuesta inesperada del LLM:', result);
                }
                
                // Remove typing indicator
                if (typingIndicator.parentNode) {
                    typingIndicator.parentNode.removeChild(typingIndicator);
                }

                addChatMessage('chatbot', chatbotReply); // Mostrar la respuesta del LLM

            } catch (error) {
                console.error('Error al simular la respuesta del chatbot:', error);
                if (typingIndicator.parentNode) { // Ensure typing indicator is removed on error
                    typingIndicator.parentNode.removeChild(typingIndicator);
                }
                addChatMessage('chatbot', 'Lo siento, hubo un error al comunicarme contigo. Por favor, intenta de nuevo m√°s tarde.');
            }
        }

        // --- Audio Recording Functions (kept for potential future use, though buttons are removed) ---
        // These functions will not be called unless a new way to trigger them is added.
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64Audio = reader.result; // Base64 string
                        simulateChatbotResponse({ audioData: base64Audio });
                    };
                    reader.readAsDataURL(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };
                mediaRecorder.start();
                isRecording = true;
                // Removed: chatAudioButton.classList.add('recording');
                // Removed: chatAudioButton.innerHTML = ...
                crearModalPersonalizado("Grabando Audio", "Habla ahora. Toca el micr√≥fono para terminar.", [{ texto: "OK", clase: "boton-confirmacion" }]);
            } catch (err) {
                console.error('Error al acceder al micr√≥fono:', err);
                crearModalPersonalizado("Error de Micr√≥fono", "No se pudo acceder al micr√≥fono. Por favor, aseg√∫rate de haber dado permiso.", [{ texto: "Entendido", clase: "boton-negacion" }]);
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                // Removed: chatAudioButton.classList.remove('recording');
                // Removed: chatAudioButton.innerHTML = ...
            }
        }


        // --- Initialization and Event Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Check for WebP support once on load
            supportsWebP = await checkWebPSupport();

            // Assign events to age buttons
            document.querySelectorAll('#botones-edad button').forEach(button => {
                button.addEventListener('click', function () {
                    seleccionarEdad(this.dataset.edad);
                });
            });

            // Events for other main buttons
            document.getElementById('boton-comenzar-instrucciones').addEventListener('click', cerrarVentanaInstrucciones);
            document.getElementById('boton-reiniciar').addEventListener('click', reiniciarTrivia);
            document.getElementById('boton-mostrar-ubicacion').addEventListener('click', accionMostrarUbicacion);
            document.getElementById('boton-cerrar-final').addEventListener('click', cerrarVentanaFinal);
            botonToggleSonido.addEventListener('click', toggleSonido);

            // Chatbot event listeners
            chatbotToggleButton.addEventListener('click', toggleChatbotVisibility);
            chatCloseButton.addEventListener('click', toggleChatbotVisibility);

            // Handle text message sending
            chatSendButton.addEventListener('click', () => {
                const message = chatUserInput.value.trim();
                if (message) {
                    simulateChatbotResponse({ text: message });
                }
            });
            chatUserInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    const message = chatUserInput.value.trim();
                    if (message) {
                        simulateChatbotResponse({ text: message });
                    }
                }
            });

            // Removed: Image upload event listeners
            // Removed: Audio recording event listeners


            // Show welcome window on load (no audio playback here directly)
            if (ventanaBienvenida) {
                ventanaBienvenida.classList.add("mostrar");
                // The audio for this welcome message will now be triggered by selecting an age.
            } else {
                console.error('Error: Element with ID "ventana-bienvenida" not found.');
            }

            // Focus the first age button
            const primerBotonEdad = document.querySelector('#botones-edad button');
            if (primerBotonEdad) {
                primerBotonEdad.focus();
            }

            // Initial chatbot message
            addChatMessage('chatbot', '¬°Hola! Soy tu Guarda parque Virtual. Escribe tu mensaje en la barra de abajo.');
        });
    </script>

</body>

</html>







