<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Trivia Francisco Tau</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="manifest" href="manifest.json">
    
    <!-- Enlace al CSS del chatbot de n8n -->
    <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />

    <style>
        /* ==================================================================== */
        /* VARIABLES CSS GLOBALES                      */
        /* ==================================================================== */
        :root {
            --color-primario-verde: #4CAF50;
            --color-primario-verde-claro: #66bb6a;
            --color-primario-verde-oscuro: #388E3C;
            --color-secundario-azul: #2196f3;
            --color-secundario-azul-claro: #42a5f5;
            --color-secundario-azul-oscuro: #1976D2;
            --color-error-rojo: #e53935;
            --color-error-rojo-claro: #ef5350;
            --color-texto-oscuro: #333;
            --color-texto-blanco: #fff;
            --color-fondo-overlay: rgba(255, 255, 255, 0.85);

            --radio-borde-general: 8px;
            --radio-borde-modal: 12px;
            --radio-borde-modal-grande: 15px;

            --padding-boton: 12px 25px;
            --padding-modal: 30px;
            --padding-modal-grande: 35px 30px;

            --sombra-elemento: 0 4px 10px rgba(0, 0, 0, 0.15), 0 2px 5px rgba(0, 0, 0, 0.1);
            --sombra-elemento-hover: 0 6px 12px rgba(0, 0, 0, 0.2);
            --sombra-modal: 0 15px 40px rgba(0, 0, 0, 0.2), 0 6px 20px rgba(0, 0, 0, 0.15);
            --sombra-modal-hover: 0 8px 20px rgba(0, 0, 0, 0.25);

            --fuente-principal: Arial, sans-serif;
            --tamano-fuente-normal: 16px;
            --tamano-fuente-boton: 17px;
            --tamano-fuente-titulo-modal: 1.8em;
        }

        /* ==================================================================== */
        /* ESTILOS GENERALES                         */
        /* ==================================================================== */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: var(--fuente-principal);
            font-size: var(--tamano-fuente-normal);
            background-image: url('fondo.jpg'); /* Aseg√∫rate de que 'fondo.jpg' exista en la misma carpeta */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            /* Previene el zoom accidental y mejora la interacci√≥n t√°ctil */
            touch-action: pan-x pan-y; 
            /* Deshabilita la selecci√≥n de texto en la interfaz */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #map {
            height: 100vh;
            width: 100%;
            touch-action: manipulation; /* Permite interacciones de mapa como el zoom y arrastre */
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }

        /* ==================================================================== */
        /* ESTILOS DE MODALES                      */
        /* ==================================================================== */
        .modal-base {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: var(--padding-modal);
            border-radius: var(--radio-borde-modal);
            z-index: 1000;
            width: 90vw;
            max-width: 450px;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: var(--sombra-modal);
            display: none; /* Oculto por defecto */
            animation: fadeIn 0.5s ease-out; /* Animaci√≥n de aparici√≥n */

            /* Fondo con imagen y overlay para legibilidad */
            background: linear-gradient(var(--color-fondo-overlay), var(--color-fondo-overlay)), url('fondoventanas.jpg'); /* Aseg√∫rate de que 'fondoventanas.jpg' exista */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .modal-base.mostrar {
            display: block; /* Muestra el modal */
        }

        .modal-base h2 {
            font-size: var(--tamano-fuente-titulo-modal);
            color: var(--color-texto-oscuro);
            margin-bottom: 20px;
            font-weight: bold;
            text-shadow: 0 0 8px var(--color-texto-blanco);
        }

        .modal-base p {
            color: var(--color-texto-oscuro);
            text-shadow: 0 0 8px var(--color-texto-blanco);
            font-weight: bold;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        /* Estilos espec√≠ficos para la ventana final */
        #ventana-final {
            max-width: 480px;
            padding: var(--padding-modal-grande);
            border-radius: var(--radio-borde-modal-grande);
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            z-index: 10001;
        }

        #ventana-final h2 {
            color: var(--color-primario-verde-oscuro);
        }

        #ventana-final button {
            background: linear-gradient(135deg, var(--color-secundario-azul-claro) 0%, var(--color-secundario-azul) 100%);
        }

        #ventana-final button:hover {
            background: linear-gradient(135deg, var(--color-secundario-azul) 0%, var(--color-secundario-azul-oscuro) 100%);
        }

        /* Estilos para el overlay global que bloquea la interacci√≥n de fondo */
        #global-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Fondo oscuro semi-transparente */
            z-index: 999; /* Debajo de los modales, por encima del mapa */
            display: none; /* Oculto por defecto */
        }

        /* ==================================================================== */
        /* ESTILOS DE BOTONES                      */
        /* ==================================================================== */
        button, .button-style {
            margin: 10px 5px;
            padding: var(--padding-boton);
            font-size: var(--tamano-fuente-boton);
            border-radius: var(--radio-borde-general);
            border: 1px solid rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, var(--color-primario-verde-claro) 0%, var(--color-primario-verde) 100%);
            color: var(--color-texto-blanco);
            cursor: pointer;
            box-shadow: var(--sombra-elemento);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, opacity 0.2s ease;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-decoration: none;
            display: inline-block;
            outline: none;
            min-height: 44px; /* Tama√±o m√≠nimo para una f√°cil interacci√≥n t√°ctil */
            min-width: 44px;  /* Tama√±o m√≠nimo para una f√°cil interacci√≥n t√°ctil */
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        button:hover, .button-style:hover {
            background: linear-gradient(135deg, var(--color-primario-verde) 0%, var(--color-primario-verde-oscuro) 100%);
            transform: translateY(-2px);
            box-shadow: var(--sombra-elemento-hover);
        }

        /* Estilos para estados de foco y activo (navegaci√≥n por teclado/feedback de click) */
        button:focus-visible, button:focus, .button-style:focus-visible, .button-style:focus {
            transform: translateY(0);
            border: 3px solid var(--color-secundario-azul-claro);
            box-shadow: 0 0 0 2px var(--color-secundario-azul-claro),
                        0 3px 8px rgba(0, 0, 0, 0.25);
        }

        button:active, .button-style:active {
            transform: scale(0.95);
            opacity: 0.8;
            box-shadow: var(--sombra-elemento);
        }

        /* Estilo para los botones de selecci√≥n de edad */
        .age-selection-button {
            background: linear-gradient(135deg, var(--color-secundario-azul-claro) 0%, var(--color-secundario-azul) 100%) !important;
            border: 3px solid var(--color-secundario-azul-claro) !important;
            box-shadow: var(--sombra-elemento) !important;
        }

        .age-selection-button.seleccionado {
            border-color: var(--color-primario-verde-oscuro) !important;
            box-shadow: 0 0 0 4px var(--color-primario-verde-claro), var(--sombra-elemento-hover) !important;
            transform: scale(1.02);
            background: linear-gradient(135deg, var(--color-primario-verde) 0%, var(--color-primario-verde-oscuro) 100%) !important;
        }

        /* Estilo para botones deshabilitados */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #ccc !important;
            box-shadow: none !important;
            transform: none !important;
            border-color: #aaa !important;
        }

        /* Botones fijos en la esquina superior derecha */
        #botones-fijos {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 5px;
            display: none; /* Oculto por defecto, se muestra con JS */
        }

        #botones-fijos button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
        }

        #botones-fijos button svg {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            fill: var(--color-texto-blanco);
        }

        /* Texto de los botones fijos oculto en pantallas peque√±as, visible en grandes */
        #botones-fijos button span {
            display: none;
        }

        /* Contenedor de opciones de pregunta (botones de respuesta) */
        #opciones {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        #opciones button {
            padding: 15px;
            font-size: 1.1em;
            cursor: pointer;
            border: none;
            border-radius: var(--radio-borde-general);
            background-color: var(--color-secundario-azul-claro);
            color: var(--color-texto-blanco);
            box-shadow: var(--sombra-elemento);
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.1s ease;
            font-weight: bold;
            text-align: center;
            white-space: normal; /* Permite que el texto se ajuste en varias l√≠neas */
            min-height: 44px;
            line-height: 1.4;
        }

        #opciones button:hover {
            background-color: var(--color-secundario-azul);
            box-shadow: var(--sombra-elemento-hover);
        }

        #opciones button:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        /* Botones de confirmaci√≥n/negaci√≥n en modales personalizados */
        .custom-js-modal .boton-confirmacion {
            background: linear-gradient(135deg, var(--color-primario-verde-claro) 0%, var(--color-primario-verde) 100%);
        }

        .custom-js-modal .boton-confirmacion:hover {
            background: linear-gradient(135deg, var(--color-primario-verde) 0%, var(--color-primario-verde-oscuro) 100%);
        }

        .custom-js-modal .boton-negacion {
            background: linear-gradient(135deg, var(--color-error-rojo-claro) 0%, var(--color-error-rojo) 100%);
        }

        .custom-js-modal .boton-negacion:hover {
            background: linear-gradient(135deg, var(--color-error-rojo) 0%, #d32f2f 100%);
        }

        /* ==================================================================== */
        /* PANEL DE PROGRESO                          */
        /* ==================================================================== */
        #panel-progreso {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: calc(100% - 20px);
            max-width: 350px;
            background: var(--color-fondo-overlay);
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: var(--radio-borde-general);
            padding: 10px;
            z-index: 999;
            box-shadow: var(--sombra-elemento);
            font-size: 14px;
            color: var(--color-texto-oscuro);
            display: none; /* Oculto por defecto, se muestra con JS */
        }

        #barra-progreso {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: var(--radio-borde-general);
            overflow: hidden;
            margin-bottom: 5px;
        }

        #progreso-porcentaje {
            height: 100%;
            width: 0%;
            background-color: var(--color-primario-verde);
            transition: width 0.5s ease;
        }

        /* ==================================================================== */
        /* MODAL DE FELICITACI√ìN                      */
        /* ==================================================================== */
        #ventana-felicitacion {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: var(--padding-modal-grande);
            border-radius: var(--radio-borde-modal-grande);
            box-shadow: var(--sombra-modal);
            z-index: 10006;
            text-align: center;
            max-width: 500px;
            width: 90vw;
            color: var(--color-texto-oscuro);
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        #ventana-felicitacion.mostrar {
            display: block;
        }

        #ventana-felicitacion h3 {
            font-size: 2em;
            color: var(--color-primario-verde-oscuro);
            margin-bottom: 20px;
        }

        #ventana-felicitacion img {
            max-width: 100%;
            height: auto;
            border-radius: var(--radio-borde-general);
            margin-bottom: 20px;
            box-shadow: var(--sombra-elemento);
        }

        #ventana-felicitacion p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 20px;
            text-shadow: none;
            font-weight: normal;
        }

        #ventana-felicitacion button {
            background: linear-gradient(135deg, var(--color-secundario-azul-claro) 0%, var(--color-secundario-azul) 100%);
        }

        #ventana-felicitacion button:hover {
            background: linear-gradient(135deg, var(--color-secundario-azul) 0%, var(--color-secundario-azul-oscuro) 100%);
        }

        /* ==================================================================== */
        /* EXPLICACI√ìN DE RESPUESTA                   */
        /* ==================================================================== */
        #explicacion-respuesta {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(240, 240, 240, 0.9);
            border-radius: var(--radio-borde-general);
            text-align: left;
            font-size: 0.95em;
            color: var(--color-texto-oscuro);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        #explicacion-respuesta.mostrar {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        /* ==================================================================== */
        /* MODAL CUSTOM JS                          */
        /* ==================================================================== */
        .custom-js-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--color-texto-blanco);
            padding: var(--padding-modal);
            border-radius: var(--radio-borde-modal);
            box-shadow: var(--sombra-modal);
            z-index: 10005;
            text-align: center;
            max-width: 380px;
            width: 85vw;
            color: var(--color-texto-oscuro);
        }

        .custom-js-modal h3 {
            font-size: 1.5em;
            color: var(--color-texto-oscuro);
            margin-bottom: 15px;
            font-weight: bold;
        }

        .custom-js-modal p {
            font-size: 1.1em;
            margin-bottom: 25px;
            line-height: 1.5;
            text-shadow: none;
            font-weight: normal;
        }

        .custom-js-modal .modal-botones button {
            margin: 8px;
            padding: 10px 20px;
        }

        /* ==================================================================== */
        /* ANIMACIONES                            */
        /* ==================================================================== */
        @keyframes fadeIn {
            0% { opacity: 0; transform: translate(-50%, -55%); }
            100% { opacity: 1; transform: translate(-50%, -50%); }
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ==================================================================== */
        /* ICONO DE UBICACI√ìN LEAFLET                 */
        /* ==================================================================== */
        .leaflet-div-icon {
            background: none;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px !important;
            height: 30px !important;
            transform-origin: bottom center;
        }

        .leaflet-div-icon svg {
            width: 100%;
            height: 100%;
            display: block;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.4));
            animation: pulse 1.5s infinite ease-in-out;
        }

        /* ==================================================================== */
        /* MEDIA QUERIES (RESPONSIVE)                */
        /* ==================================================================== */
        @media (max-width: 600px) {
            .modal-base, #ventana-final, .custom-js-modal, #ventana-felicitacion {
                width: 95vw;
                max-width: 95vw;
            }

            .modal-base h2 { font-size: 1.5em; }
            .custom-js-modal h3 { font-size: 1.3em; }
            .custom-js-modal p { font-size: 1em; }
            #ventana-felicitacion h3 { font-size: 1.5em; }
            #panel-progreso { font-size: 13px; }

            #botones-fijos {
                top: 10px;
                right: 10px;
                flex-direction: column;
                gap: 6px;
                align-items: flex-end;
            }

            #botones-fijos button {
                margin-bottom: 0;
                padding: 8px 12px;
                font-size: 14px;
            }

            #botones-fijos button span {
                display: inline; /* Muestra el texto en pantallas peque√±as */
            }
        }

        /* Media query para pantallas m√°s grandes para mostrar texto junto a los iconos */
        @media (min-width: 601px) {
            #botones-fijos button span {
                display: inline;
            }
        }

        /* ==================================================================== */
        /* ESTILOS CHATBOT N8N                       */
        /* ==================================================================== */
        #n8n-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10007;
            width: 60px;
            height: 60px;
        }

        /* Estilos para el bot√≥n flotante real que crea n8n (clases comunes) */
        #n8n-chat .n8n-chat-bubble,
        #n8n-chat .n8n-chat-launcher {
            background-color: #25D366 !important; /* Color de WhatsApp */
            color: white !important;
            border-radius: 50% !important;
            width: 60px !important;
            height: 60px !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            transition: transform 0.2s ease, box-shadow 0.2s ease !important;
            padding: 0 !important;
        }

        #n8n-chat .n8n-chat-bubble:hover,
        #n8n-chat .n8n-chat-launcher:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3) !important;
        }

        #n8n-chat .n8n-chat-bubble:active,
        #n8n-chat .n8n-chat-launcher:active {
            transform: scale(0.95) !important;
        }
    </style>
</head>

<body>

    <div id="map"></div>
    <div id="global-overlay"></div> <!-- Overlay para bloquear interacci√≥n de fondo -->

    <!-- Ventana de bienvenida y selecci√≥n de edad -->
    <div id="ventana-bienvenida" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="titulo-bienvenida">
        <h2 id="titulo-bienvenida">¬°Bienvenido a la trivia de la "Reserva Natural Francisco Tau"!</h2>
        <p>¬øEn qu√© rango de edad te encontr√°s?</p>
        <div id="botones-edad">
            <button data-edad="menor6" class="age-selection-button">Menor a 6 a√±os</button>
            <button data-edad="6a12" class="age-selection-button">Entre 6 y 12 a√±os</button>
            <button data-edad="mayor12" class="age-selection-button">Mayor a 12 a√±os</button>
        </div>
    </div>

    <!-- Ventana de instrucciones -->
    <div id="ventana-instrucciones" class="modal-base" role="dialog" aria-modal="true"
        aria-labelledby="titulo-instrucciones">
        <h2 id="titulo-instrucciones">¬°Bienvenido a la trivia de la "Reserva Natural Francisco Tau"!</h2>
        <p>En esta trivia aprenderemos diferentes aspectos naturales, culturales y sociales de nuestra reserva natural.</p>
        <p>Para poder realizar la experiencia de la forma m√°s √≥ptima debemos realizar dos cosas:</p>
        <p>En primer lugar, activar la ubicaci√≥n y en segundo, activar el sonido.</p>
        <p>¬°Esperamos que disfrutes este viaje por la reserva!</p>
        <button id="boton-comenzar-instrucciones">¬°Comencemos!</button>
    </div>

    <!-- Ventana de pregunta -->
    <div id="pregunta" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="texto-pregunta">
        <p id="texto-pregunta"></p>
        <div id="opciones"></div>
        <div id="explicacion-respuesta"></div>
    </div>

    <!-- Ventana de felicitaci√≥n por respuesta correcta -->
    <div id="ventana-felicitacion" role="dialog" aria-modal="true" aria-labelledby="titulo-felicitacion">
        <h3 id="titulo-felicitacion">¬°Respuesta Correcta!</h3>
        <img id="felicitacion-imagen" src="algarrobo.jpg" alt="Imagen del lugar"> <!-- Placeholder, se carga din√°micamente -->
        <p id="felicitacion-explicacion"></p>
        <button id="boton-continuar-felicitacion">Continuar</button>
    </div>

    <!-- Botones fijos en la interfaz principal del mapa -->
    <div id="botones-fijos">
        <button id="boton-reiniciar" aria-label="Reiniciar Trivia">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M12 4V1l-4 4 4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z" />
            </svg>
            <span>Reiniciar</span>
        </button>
        <button id="boton-mostrar-ubicacion" aria-label="Mostrar mi ubicaci√≥n">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
            </svg>
            <span>Mi ubicaci√≥n</span>
        </button>
        <button id="boton-toggle-sonido" aria-label="Activar/Desactivar Sonido">
            <svg id="icon-sound-on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
            </svg>
            <svg id="icon-sound-off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display:none;">
                <path
                    d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .9-.23 1.74-.63 2.5L20.5 17c.92-1.23 1.5-2.77 1.5-4.5 0-4.01-2.99-7.11-7-8.77v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71zM4.27 3L3 4.27l9 9V19c0 1.38-1.12 2.5-2.5 2.5S6 20.38 6 19v-1H2v1c0 2.21 1.79 4 4 4s4-1.79 4-4V7.27L1.27 0 0 1.27l3 3zm7.53 10.73L7.27 9H3v6h3.73l4.5 4.5c.66.33 1.41.5 2.22.5 2.05 0 3.8-.96 4.99-2.4l-2.72-2.72z" />
            </svg>
            <span>Sonido</span>
        </button>
    </div>

    <!-- Panel de progreso de la trivia -->
    <div id="panel-progreso">
        <div id="barra-progreso">
            <div id="progreso-porcentaje"></div>
        </div>
        <div id="progreso-texto">0 / 0 preguntas respondidas - Puntaje: 0 / 0</div>
    </div>

    <!-- Ventana final de resultados de la trivia -->
    <div id="ventana-final" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="titulo-final">
        <h2 id="titulo-final">üéâ ¬°Felicitaciones!</h2>
        <p>Has finalizado la trivia del <strong>Parque Natural Francisco Tau</strong>.</p>
        <p id="mensaje-final"></p>
        <p>Tu puntaje final es: <span id="puntaje-final"></span></p>
        <button id="boton-cerrar-final">Cerrar</button>
    </div>

    <!-- Elementos de audio -->
    <audio id="sonido-correcto" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"
        preload="auto"></audio>
    <audio id="sonido-incorrecto" src="https://actions.google.com/sounds/v1/cartoon/boing.ogg"
        preload="auto"></audio>
    <audio id="alarmaSonido" preload="auto">
        <source src="alarma.mp3" type="audio/mpeg"> <!-- Aseg√∫rate de que 'alarma.mp3' exista en la misma carpeta -->
        Tu navegador no soporta el elemento de audio.
    </audio>

    <!-- Contenedor para el chatbot de n8n -->
    <div id="n8n-chat"></div>

    <!-- Scripts externos -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script type="module">
        import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

        // ==================================================================== */
        //                         VARIABLES GLOBALES Y DATOS                   */
        /* ==================================================================== */
        const preguntasData = {
            "menor6": [
                {
                    "coords": [-34.61017, -58.36833],
                    "texto": "‚Äú Tengo tronco fuerte y vainas dulces; doy mucha sombra en el parque. ¬øQui√©n soy?‚Äù",
                    "opciones": ["Eucalipto", "Pino", "Algarrobo blanco"],
                    "correcta": 2,
                    "explicacion": "¬°Este algarrobo vive en el Parque Tau desde hace m√°s de 400 a√±os! Es un ‚Äúabuelo‚Äù del bosque que da sombra fresca y alimento a muchos animalitos.",
                    "fotoUrl": "algarrobo.jpg"
                },
                {
                    "coords": [-34.61018, -58.36851],
                    "texto": "‚ÄúToc-toc, pico el barro y hago mi casita redonda. ¬øQui√©n canta as√≠?‚Äù",
                    "opciones": ["Gorri√≥n", "Hornero", "Jilguero"],
                    "correcta": 1,
                    "explicacion": "El hornero es un pajarito constructor: amasa barro como plastilina y levanta un nido redondo que parece un hornito de pan.",
                    "fotoUrl": "hornero.jpg"
                },
                {
                    "coords": [-34.61026, -58.36866],
                    "texto": "‚ÄúMe abrochas antes de subir al gom√≥n para que flotes seguro. ¬øQu√© soy?‚Äù",
                    "opciones": ["Casco", "Salvavidas", "Remo"],
                    "correcta": 1,
                    "explicacion": "La Fundaci√≥n tiene ¬°cien chalecos! Se cierran con clic-clic y te abrazan para que navegues protegido mientras disfrutas del r√≠o.",
                    "fotoUrl": "chaleco.jpg"
                },
                {
                    "coords": [-34.61042, -58.36870],
                    "texto": "‚ÄúSerpenteo con agua fresca junto al bosque del parque. ¬øC√≥mo me llamo?‚Äù",
                    "opciones": ["R√≠o Segundo", "R√≠o Primero", "R√≠o Ctalamochita"],
                    "correcta": 2,
                    "explicacion": "Su nombre ind√≠gena significa ‚Äúlugar de muchos √°rboles‚Äù. Con sus curvas suaves forma playitas donde peces, plantas y personas se refrescan.",
                    "fotoUrl": "rioct.jpg"
                },
                {
                    "coords": [-34.61063, -58.36858],
                    "texto": "‚ÄúTomo sol quieto, tengo escamas y una lengua larga. ¬øQui√©n soy?‚Äù",
                    "opciones": ["Serpiente", "Tortuga", "Lagarto overo"],
                    "correcta": 2,
                    "explicacion": "Este lagarto moteado adora broncearse en los claros del parque. Ayuda a mantener el equilibrio porque se come insectos y peque√±os bichitos.",
                    "fotoUrl": "lagarto.jpg"
                },
                {
                    "coords": [-34.61082, -58.36855],
                    "texto": "‚ÄúCuelgo de los √°rboles como una flor que vive del aire. ¬øC√≥mo me llaman?‚Äù",
                    "opciones": ["Orqu√≠dea", "Clavel del aire", "Rosa"],
                    "correcta": 1,
                    "explicacion": "No necesita tierra: bebe la humedad del viento y adorna las ramas con sus hojitas plateadas, ¬°un colgante natural del bosque!",
                    "fotoUrl": "clavel.jpg"
                },
                {
                    "coords": [-34.61100, -58.36843],
                    "texto": "‚ÄúCuido plantas y animales y ayudo a los visitantes. ¬øQui√©n soy?‚Äù",
                    "opciones": ["Cient√≠fico", "Rurista", "Guardaparque"],
                    "correcta": 2,
                    "explicacion": "La guardaparque del Tau es la super-hero√≠na verde: vigila senderos, da consejos y protege cada rinc√≥n del bosque todos los d√≠as.",
                    "fotoUrl": "guarda.png"
                },
                {
                    "coords": [-34.61097, -58.36814],
                    "texto": "‚ÄúSi tiras basura aqu√≠, ensucias a peces y patos. ¬øQu√© lugar es?‚Äù",
                    "opciones": ["El r√≠o", "El lago", "La calle"],
                    "correcta": 0,
                    "explicacion": "Usar los tachos y llevarte tus residuos mantiene el agua clarita y feliz; as√≠ el r√≠o sigue sano para nadar y remar.",
                    "fotoUrl": "rio.jpg"
                },
                {
                    "coords": [-34.61095, -58.36787],
                    "texto": "‚ÄúReciclando papel le salvamos la vida a este gran amigo verde. ¬øQui√©n es?‚Äù",
                    "opciones": ["Pasto", "Flor", "√Årbol"],
                    "correcta": 2,
                    "explicacion": "Los √°rboles dan sombra, aire puro y casita a los p√°jaros. En el parque crecen talas, cha√±ares y un hist√≥rico algarrobo blanco que son verdaderos tesoros.",
                    "fotoUrl": "arbol.jpg"
                },
                {
                    "coords": [-34.61091,-58.36750],
                    "texto": "‚ÄúLlevo gorrita roja y pechito blanco; mi canto suena fuerte. ¬øQu√© p√°jaro soy?‚Äù",
                    "opciones": ["Colibr√≠", "Cardenal com√∫n", "Benteveo"],
                    "correcta": 1,
                    "explicacion": "Con su ‚Äúsombrerito‚Äù rojo brillante, el cardenal es una de las aves m√°s vistosas del parque y se deja ver entre las ramas cantando con energ√≠a.",
                    "fotoUrl": "cardenal.jpg"
                }
            ],
            "6a12": [
                {
                    "coords": [-32.62763, -62.70419],
                    "texto": "¬øCu√°l es la especie de √°rbol nativo m√°s antigua del Parque Francisco Tau, considerada un monumento natural viviente?",
                    "opciones": ["Algarrobo blanco", "Pino", "Eucalipto"],
                    "correcta": 0,
                    "explicacion": "Es un √°rbol nativo t√≠pico de la regi√≥n chaque√±a y pampeana, muy resistente a la sequ√≠a. En el Parque Francisco Tau, el algarrobo blanco aporta sombra y alimento a la fauna local con sus vainas dulces. Adem√°s, su madera es dura y se utiliza tradicionalmente para carpinter√≠a y artesan√≠a. Es una especie clave para mantener el equilibrio ecol√≥gico del √°rea.",
                    "fotoUrl": "algarrobo.jpg"
                },
                {
                    "coords": [-32.62742, -62.70511],
                    "texto": "¬øQu√© r√≠o atraviesa el Parque Francisco Tau y forma parte importante de su paisaje natural?",
                    "opciones": ["R√≠o Segundo", "R√≠o Primero", "R√≠o Ctalamochita"],
                    "correcta": 2,
                    "explicacion": "El R√≠o Ctalamochita, tambi√©n llamado R√≠o Tercero, atraviesa el Parque Francisco Tau y es fundamental para su ecosistema. Sus aguas forman balnearios naturales como El Diquecito y Paso de la Arena, y brindan h√°bitat a aves acu√°ticas, peces y mam√≠feros como el coipo. Adem√°s de su valor natural y recreativo, funciona como un corredor biol√≥gico, conectando distintos ambientes y favoreciendo la biodiversidad del parque.",
                    "fotoUrl": "rio.jpg"
                },
                {
                    "coords": [-32.62655, -62.70584],
                    "texto": "¬øA qu√© bioma pertenece el monte nativo que protege el Parque Francisco Tau?",
                    "opciones": ["Chaco H√∫medo", "Espinal", "Selva de Yungas"],
                    "correcta": 1,
                    "explicacion": "El Parque Francisco Tau conserva un relicto del bioma del Espinal, un tipo de bosque nativo de la llanura cordobesa. Se caracteriza por especies resistentes a la sequ√≠a como el algarrobo blanco, el tala, el cha√±ar y el espinillo. Este ecosistema, hoy muy reducido por la expansi√≥n agr√≠cola, es √∫nico en un centro urbano en C√≥rdoba. Su preservaci√≥n es fundamental para conservar la biodiversidad aut√≥ctona, estudiar el ambiente original de la regi√≥n y mantener un pulm√≥n verde para la ciudad.",
                    "fotoUrl": "espinal.jpg"
                },
                {
                    "coords": [-32.62550, -62.70573],
                    "texto": "¬øCu√°ntas especies de aves, aproximadamente, han sido identificadas en el Parque Francisco Tau?",
                    "opciones": ["100", "135", "125"],
                    "correcta": 2,
                    "explicacion": "El Parque Francisco Tau alberga una gran diversidad de aves, con al menos 125 especies registradas, lo que lo convierte en un sitio ideal para la observaci√≥n de aves. Se encuentran especies comunes y vistosas como el hornero, el benteveo, el cardenal com√∫n y el chingolo, as√≠ como aves acu√°ticas como el bigu√°, la gallareta y el mart√≠n pescador chico. Tambi√©n se observan aves rapaces como el carancho y la lechucita de las vizcacheras.\n\t\t\t\t\tLa variedad de h√°bitats del parque (bosque, ribera, pastizal) favorece esta riqueza avifaun√≠stica, que es clave para el equilibrio ecol√≥gico y un gran recurso para la educaci√≥n ambiental.",
                    "fotoUrl": "ave.jpg"
                },
                {
                    "coords": [-32.62451, -62.70495],
                    "texto": "¬øQu√© roedor semiacu√°tico, parecido a una nutria, habita en las orillas del R√≠o Ctalamochita dentro del parque?",
                    "opciones": ["Comadreja overa", "Coipo", "Cuis"],
                    "correcta": 1,
                    "explicacion": "El coipo, tambi√©n llamado nutria criolla, es un mam√≠fero roedor semiacu√°tico que vive en zonas cercanas al agua, como las orillas del R√≠o Ctalamochita, dentro del Parque Francisco Tau. Tiene un cuerpo robusto, pelaje denso e impermeable, y una cola larga y redondeada. Sus patas trasmeras palmeadas le permiten nadar con gran agilidad. Se alimenta principalmente de vegetaci√≥n acu√°tica y ra√≠ces, y suele construir madrigueras en barrancas o entre la vegetaci√≥n ribere√±a. Es una especie nativa de Am√©rica del Sur y cumple un rol ecol√≥gico importante en el ecosistema acu√°tico, ayudando a controlar el crecimiento de plantas en lagunas y r√≠os. Su presencia en el parque indica una buena calidad ambiental en los ambientes ribere√±os y la existencia de refugio adecuado para fauna nativa.",
                    "fotoUrl": "coipo.jpg"
                }
            ],
            "mayor12": [
                {
                    "coords": [-32.62763, -62.70419],
                    "texto": "¬øQu√© especie arb√≥rea aut√≥ctona, propia del Espinal y con un ejemplar de m√°s de cuatro siglos en el parque, representa un testimonio ecol√≥gico e hist√≥rico de la regi√≥n?",
                    "opciones": ["Algarrobo blanco", "Pino", "Eucalipto"],
                    "correcta": 0,
                    "explicacion": "Es un √°rbol nativo t√≠pico de la regi√≥n chaque√±a y pampeana, muy resistente a la sequ√≠a. En el Parque Francisco Tau, el algarrobo blanco aporta sombra y alimento a la fauna local con sus vainas dulces. Adem√°s, su madera es dura y se utiliza tradicionalmente para carpinter√≠a y artesan√≠a. Es una especie clave para mantener el equilibrio ecol√≥gico del √°rea.",
                    "fotoUrl": "algarrobo.jpg"
                },
                {
                    "coords": [-32.62742,-62.70511],
                    "texto": "¬øCu√°l es el curso fluvial que recorre el parque, funcionando como corredor biol√≥gico y aportando ambientes acu√°ticos y ribere√±os?",
                    "opciones": ["R√≠o Primero", "R√≠o Ctalamochita", "R√≠o Segundo"],
                    "correcta": 1,
                    "explicacion": "El R√≠o Ctalamochita, tambi√©n llamado R√≠o Tercero, atraviesa el Parque Francisco Tau y es fundamental para su ecosistema. Sus aguas forman balnearios naturales como El Diquecito y Paso de la Arena, y brindan h√°bitat a aves acu√°ticas, peces y mam√≠feros como el coipo. Adem√°s de su valor natural y recreativo, funciona como un corredor biol√≥gico, conectando distintos ambientes y favoreciendo la biodiversidad del parque.",
                    "fotoUrl": "rio.jpg"
                },
                {
                    "coords": [-32.62655, -62.70584],
                    "texto": "¬øCu√°l es el nombre de la ecorregi√≥n fitogeogr√°fica representada por el relicto conservado en el Parque Francisco Tau?",
                    "opciones": ["Selva de Yungas", "Chaco H√∫medo", "Espinal"],
                    "correcta": 0,
                    "explicacion": "El Parque Francisco Tau conserva un relicto del bioma del Espinal, un tipo de bosque nativo de la llanura cordobesa. Se caracteriza por especies resistentes a la sequ√≠a como el algarrobo blanco, el tala, el cha√±ar y el espinillo. Este ecosistema, hoy muy reducido por la expansi√≥n agr√≠cola, es √∫nico en un centro urbano en C√≥rdoba. Su preservaci√≥n es fundamental para conservar la biodiversidad aut√≥ctona, estudiar el ambiente original de la regi√≥n y mantener un pulm√≥n verde para la ciudad.",
                    "fotoUrl": "espinal.jpg"
                },
                {
                    "coords": [-32.62550, -62.70573],
                    "texto": "Seg√∫n relevamientos recientes, ¬øcu√°ntas especies avifaun√≠sticas habitan actualmente el Parque Francisco Tau?",
                    "opciones": ["125", "135", "115"],
                    "correcta": 0,
                    "explicacion": "El Parque Francisco Tau alberga una gran diversidad de aves, con al menos 125 especies registradas, lo que lo convierte en un sitio ideal para la observaci√≥n de aves. Se encuentran especies comunes y vistosas como el hornero, el benteveo, el cardenal com√∫n y el chingolo, as√≠ como aves acu√°ticas como el bigu√°, la gallareta y el mart√≠n pescador chico. Tambi√©n se observan aves rapaces como el carancho y la lechucita de las vizcacheras.\n\t\t\t\t\tLa variedad de h√°bitats del parque (bosque, ribera, pastizal) favorece esta riqueza avifaun√≠stica, que es clave para el equilibrio ecol√≥gico y un gran recurso para la educaci√≥n ambiental.",
                    "fotoUrl": "ave.jpg"
                },
                {
                    "coords": [-32.62451, -62.70495],
                    "texto": "¬øCu√°l es el mam√≠fero nativo de h√°bitos ribere√±os, identificado como Myocastor coypus, registrado en el Parque Francisco Tau?",
                    "opciones": ["Comadreja overa", "Cuis", "Coipo"],
                    "correcta": 2,
                    "explicacion": "El coipo (Myocastor coypus) es un roedor semiacu√°tico nativo, clave en los ecosistemas ribere√±os del parque, contribuyendo al control de la vegetaci√≥n acu√°tica.",
                    "fotoUrl": "coipo.jpg"
                }
            ]
        };

        // Variables de estado de la aplicaci√≥n
        let edadSeleccionada = null;
        let progreso = {
            actual: 0,
            puntaje: 0,
            intentos: {} // Guarda el n√∫mero de intentos por pregunta
        };
        let mapa;
        let marcadorUbicacion;
        let ubicacionWatchId = null;
        const ACTIVATION_RADIUS = 10; // Radio en metros para activar una pregunta
        const preguntaMarkers = []; // Almacena los marcadores de preguntas en el mapa
        let currentQuestionRadiusCircle = null; // C√≠rculo que muestra el radio de activaci√≥n de la pregunta actual
        let sonidoActivado = true;
        let botonEdadSeleccionado = null; // Referencia al bot√≥n de edad actualmente seleccionado
        let bienvenidaLeida = false; // Bandera para controlar si la bienvenida de voz ya se reprodujo

        // Referencias a elementos del DOM
        const ventanaBienvenida = document.getElementById("ventana-bienvenida");
        const ventanaInstrucciones = document.getElementById("ventana-instrucciones");
        const ventanaPregunta = document.getElementById("pregunta");
        const ventanaFinal = document.getElementById("ventana-final");
        const ventanaFelicitacion = document.getElementById("ventana-felicitacion");
        const panelProgreso = document.getElementById("panel-progreso");
        const botonesFijos = document.getElementById("botones-fijos");
        const sonidoCorrecto = document.getElementById("sonido-correcto");
        const sonidoIncorrecto = document.getElementById("sonido-incorrecto");
        const botonToggleSonido = document.getElementById("boton-toggle-sonido");
        const iconSoundOn = document.getElementById("icon-sound-on");
        const iconSoundOff = document.getElementById("icon-sound-off");
        const globalOverlay = document.getElementById("global-overlay");

        // Audio para la alarma (inicializado de forma perezosa)
        let alarmaAudio;

        // ==================================================================== */
        //                             FUNCIONES DE UTILIDAD                    */
        /* ==================================================================== */

        /**
         * Reproduce un elemento de audio si el sonido est√° activado.
         * @param {HTMLAudioElement} audio - El elemento de audio a reproducir.
         */
        function reproducirSonido(audio) {
            if (sonidoActivado) {
                audio.currentTime = 0; // Reinicia el audio al principio
                audio.play().catch(e => console.error(`Error al reproducir ${audio.id}:`, e));
                console.log(`Reproduciendo sonido: ${audio.id}`); // Debugging
            } else {
                console.log(`Sonido ${audio.id} no reproducido: Sonido desactivado.`); // Debugging
            }
        }

        /**
         * Reproduce el sonido de alarma. Se inicializa el elemento de audio si a√∫n no lo est√°.
         */
        function reproducirAlarma() {
            if (!alarmaAudio) {
                alarmaAudio = document.getElementById('alarmaSonido');
            }
            if (sonidoActivado && alarmaAudio && alarmaAudio.readyState >= 2) { // readyState >=2 significa que los datos est√°n disponibles
                alarmaAudio.currentTime = 0;
                alarmaAudio.play().catch(e => console.error("Error al reproducir la alarma:", e));
                console.log("Intentando reproducir alarma.mp3"); // Debugging
            } else {
                console.warn("Alarma no reproducida: sonido deshabilitado o audio no cargado.", { sonidoActivado, readyState: alarmaAudio ? alarmaAudio.readyState : 'N/A' }); // Debugging
            }
        }

        /**
         * Genera un feedback h√°ptico (vibraci√≥n) si el dispositivo lo soporta.
         * @param {number|number[]} pattern - Patr√≥n de vibraci√≥n en milisegundos.
         */
        function feedbackHaptico(pattern = 50) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        /**
         * Reproduce un texto usando la API de s√≠ntesis de voz del navegador.
         * @param {string} text - El texto a reproducir.
         */
        function reproducirTexto(text) {
            if ('speechSynthesis' in window && sonidoActivado) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES'; // Configura el idioma a espa√±ol
                utterance.volume = 1;
                utterance.rate = 1;
                utterance.pitch = 1;
                window.speechSynthesis.cancel(); // Cancela cualquier habla en curso
                window.speechSynthesis.speak(utterance);
                console.log(`Reproduciendo texto: "${text.substring(0, Math.min(text.length, 50))}..."`); // Debugging
            } else if (!('speechSynthesis' in window)) {
                console.warn("La API de s√≠ntesis de voz no est√° soportada en este navegador.");
            } else if (!sonidoActivado) {
                console.log("Texto no reproducido: Sonido desactivado."); // Debugging
            }
        }

        /**
         * Crea y muestra un modal personalizado con t√≠tulo, mensaje y botones.
         * @param {string} titulo - T√≠tulo del modal.
         * @param {string} mensaje - Contenido HTML del mensaje.
         * @param {Array<Object>} botonesConfig - Array de objetos {texto: string, clase: string, callback: function}.
         */
        function crearModalPersonalizado(titulo, mensaje, botonesConfig) {
            // Elimina cualquier modal personalizado existente para evitar duplicados
            const modalExistente = document.querySelector('.custom-js-modal');
            if (modalExistente) {
                document.body.removeChild(modalExistente);
            }

            const modal = document.createElement('div');
            modal.className = 'custom-js-modal';
            modal.setAttribute('role', 'alertdialog');
            modal.setAttribute('aria-modal', 'true');

            const modalTitulo = document.createElement('h3');
            modalTitulo.textContent = titulo;
            modal.appendChild(modalTitulo);
            // Asegura un ID √∫nico para el aria-labelledby
            const tituloId = 'custom-modal-titulo-' + Date.now();
            modalTitulo.id = tituloId;
            modal.setAttribute('aria-labelledby', tituloId);

            const modalMensaje = document.createElement('p');
            modalMensaje.innerHTML = mensaje;
            modal.appendChild(modalMensaje);

            const botonesDiv = document.createElement('div');
            botonesDiv.className = 'modal-botones';

            botonesConfig.forEach(btnConfig => {
                const button = document.createElement("button");
                button.textContent = btnConfig.texto;
                if (btnConfig.clase) {
                    button.classList.add(...btnConfig.clase.split(' '));
                }
                button.addEventListener('click', () => {
                    if (btnConfig.callback) {
                        btnConfig.callback();
                    }
                    document.body.removeChild(modal); // Cierra el modal al hacer click
                });
                botonesDiv.appendChild(button);
            });

            modal.appendChild(botonesDiv);
            document.body.appendChild(modal);
            // Enfoca el primer bot√≥n para accesibilidad
            if (botonesDiv.firstChild && typeof botonesDiv.firstChild.focus === 'function') {
                botonesDiv.firstChild.focus();
            }
        }

        /**
         * Obtiene el array de preguntas para la edad seleccionada.
         * @returns {Array} Array de objetos de preguntas.
         */
        function obtenerPreguntas() {
            return preguntasData[edadSeleccionada] || [];
        }

        // ==================================================================== */
        //                       FUNCIONES DE L√ìGICA DE LA TRIVIA               */
        /* ==================================================================== */

        /**
         * Maneja la selecci√≥n de un rango de edad.
         * @param {string} rango - El rango de edad seleccionado ('menor6', '6a12', 'mayor12').
         * @param {HTMLElement} botonElement - El bot√≥n HTML que fue clickeado.
         */
        function seleccionarEdad(rango, botonElement) {
            // Quita la clase 'seleccionado' del bot√≥n previamente activo
            if (botonEdadSeleccionado) {
                botonEdadSeleccionado.classList.remove('seleccionado');
            }
            
            // A√±ade la clase 'seleccionado' al bot√≥n clickeado y guarda su referencia
            botonElement.classList.add('seleccionado');
            botonEdadSeleccionado = botonElement;

            edadSeleccionada = rango;
            
            // Inicia la aplicaci√≥n una vez que se ha seleccionado la edad
            iniciarAplicacionPorEdad();
        }

        /**
         * Inicia el flujo principal de la aplicaci√≥n despu√©s de la selecci√≥n de edad.
         * Oculta la ventana de bienvenida, reproduce alarma y texto de instrucciones.
         */
        function iniciarAplicacionPorEdad() {
            if (edadSeleccionada) {
                ventanaBienvenida.classList.remove("mostrar");
                globalOverlay.style.display = "none"; // Oculta el overlay de la bienvenida
                reproducirAlarma(); // Reproduce la alarma al iniciar la aplicaci√≥n

                iniciarMapa(); // Inicializa el mapa

                ventanaInstrucciones.classList.add("mostrar"); // Muestra la ventana de instrucciones
                globalOverlay.style.display = "block"; // Muestra el overlay para las instrucciones

                // Reproduce el texto de las instrucciones
                const tituloInstrucciones = document.getElementById("titulo-instrucciones").textContent;
                const parrafosInstrucciones = Array.from(document.querySelectorAll("#ventana-instrucciones p")).map(p => p.textContent).join(" ");
                reproducirTexto(tituloInstrucciones + " " + parrafosInstrucciones);

                // Enfoca el bot√≥n de comenzar para accesibilidad
                document.getElementById("boton-comenzar-instrucciones").focus();

            } else {
                crearModalPersonalizado(
                    "Error de Ingreso",
                    "Por favor, selecciona un rango de edad para comenzar.",
                    [{ texto: "Entendido", clase: "boton-negacion" }]
                );
            }
        }

        /**
         * Cierra la ventana de instrucciones y comienza el seguimiento de la ubicaci√≥n.
         */
        function cerrarVentanaInstrucciones() {
            ventanaInstrucciones.classList.remove("mostrar");
            globalOverlay.style.display = "none"; // Oculta el overlay
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // Cancela cualquier habla en curso (ej. si el usuario hace clic r√°pido)
            }
            // Inicia el seguimiento de la ubicaci√≥n si a√∫n no est√° activo
            if (!ubicacionWatchId) {
                iniciarSeguimientoUbicacion();
            }
        }

        /**
         * Inicializa el mapa Leaflet y a√±ade los marcadores de preguntas.
         */
        function iniciarMapa() {
            const preguntas = obtenerPreguntas();
            if (preguntas.length === 0) {
                crearModalPersonalizado("Error", "No hay preguntas para el rango de edad seleccionado.", [{
                    texto: "Cerrar"
                }]);
                return;
            }
            // Inicializa el mapa centrado en la primera pregunta
            mapa = L.map('map').setView(preguntas[0].coords, 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(mapa);

            // Elimina marcadores anteriores y limpia el array
            preguntaMarkers.forEach(marker => marker.remove());
            preguntaMarkers.length = 0;

            // Crea un marcador para cada pregunta y lo guarda en el array
            preguntas.forEach((p, index) => {
                const marker = L.marker(p.coords, {
                    opacity: 0.5, // Marcadores iniciales semitransparentes
                    interactive: false // No interactivos hasta que se activen
                });
                p.marker = marker; // Asocia el marcador al objeto de pregunta
                preguntaMarkers.push(marker);
            });

            actualizarPanelProgreso(); // Actualiza el progreso inicial
            botonesFijos.style.display = "flex"; // Muestra los botones fijos
            panelProgreso.style.display = "block"; // Muestra el panel de progreso
        }

        /**
         * Actualiza la visibilidad del marcador de la pregunta actual y su c√≠rculo de radio.
         */
        function actualizarVisibilidadMarcadorActual() {
            if (progreso.actual < obtenerPreguntas().length) {
                const preguntaActual = obtenerPreguntas()[progreso.actual];
                // Si el marcador de la pregunta actual no est√° en el mapa, lo a√±ade y le da opacidad total
                if (preguntaActual.marker && !mapa.hasLayer(preguntaActual.marker)) {
                    preguntaActual.marker.setOpacity(1).addTo(mapa);
                }
                // Remueve el c√≠rculo de radio anterior si existe
                if (currentQuestionRadiusCircle) {
                    mapa.removeLayer(currentQuestionRadiusCircle);
                }
                // Dibuja un nuevo c√≠rculo de radio alrededor de la pregunta actual
                currentQuestionRadiusCircle = L.circle(L.latLng(preguntaActual.coords), {
                    color: 'blue',
                    fillColor: '#0000ff',
                    fillOpacity: 0.2,
                    radius: ACTIVATION_RADIUS
                }).addTo(mapa);
            } else if (currentQuestionRadiusCircle) {
                // Si no hay m√°s preguntas, remueve el c√≠rculo
                mapa.removeLayer(currentQuestionRadiusCircle);
                currentQuestionRadiusCircle = null;
            }
        }

        /**
         * Muestra la ventana de felicitaci√≥n despu√©s de una respuesta correcta.
         * @param {Object} pregunta - Objeto de la pregunta respondida correctamente.
         */
        function mostrarFelicitacionCorrecta(pregunta) {
            const felicitacionImagen = document.getElementById("felicitacion-imagen");
            felicitacionImagen.src = pregunta.fotoUrl; // Carga la imagen de la pregunta
            felicitacionImagen.alt = `Imagen relacionada con la pregunta: ${pregunta.texto}`; // Texto alternativo

            document.getElementById("felicitacion-explicacion").textContent = pregunta.explicacion;

            ventanaFelicitacion.classList.add("mostrar"); // Muestra la ventana de felicitaci√≥n
            globalOverlay.style.display = "block"; // Muestra el overlay

            reproducirSonido(sonidoCorrecto); // Sonido de respuesta correcta
            feedbackHaptico(100); // Vibraci√≥n
            reproducirTexto(pregunta.explicacion); // Lee la explicaci√≥n

            document.getElementById("boton-continuar-felicitacion").focus(); // Enfoca el bot√≥n de continuar

            // Maneja el listener del bot√≥n "Continuar" para evitar m√∫ltiples bindings
            const botonContinuar = document.getElementById("boton-continuar-felicitacion");
            const oldListener = botonContinuar._currentListener;
            if (oldListener) {
                botonContinuar.removeEventListener('click', oldListener);
            }

            const newListener = () => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel(); // Cancela habla si sigue reproduciendo
                }
                ventanaFelicitacion.classList.remove("mostrar");
                globalOverlay.style.display = "none"; // Oculta ventana y overlay

                pregunta.marker.setOpacity(0.4); // Baja la opacidad del marcador de la pregunta respondida
                pregunta.marker.options.interactive = false;

                if (currentQuestionRadiusCircle) {
                    mapa.removeLayer(currentQuestionRadiusCircle); // Remueve el c√≠rculo de radio
                    currentQuestionRadiusCircle = null;
                }

                progreso.actual++; // Avanza a la siguiente pregunta
                actualizarPanelProgreso();
                actualizarVisibilidadMarcadorActual();

                if (progreso.actual >= obtenerPreguntas().length) {
                    mostrarVentanaFinal(); // Si no hay m√°s preguntas, muestra la ventana final
                }
                ventanaPregunta.classList.remove("mostrar"); // Oculta la ventana de pregunta
            };
            botonContinuar.addEventListener('click', newListener);
            botonContinuar._currentListener = newListener; // Guarda la referencia al listener actual
        }

        /**
         * Muestra una pregunta espec√≠fica en el modal de pregunta.
         * @param {number} index - √çndice de la pregunta a mostrar.
         */
        function mostrarPregunta(index) {
            // Evita mostrar la misma pregunta si ya est√° activa o si no es la pregunta actual
            if (index !== progreso.actual || ventanaPregunta.classList.contains('mostrar')) {
                return;
            }

            const p = obtenerPreguntas()[index];
            const preguntaId = `pregunta_${index}`;
            progreso.intentos[preguntaId] = progreso.intentos[preguntaId] || 0; // Inicializa intentos si es la primera vez

            document.getElementById("texto-pregunta").textContent = p.texto;
            const opcionesDiv = document.getElementById("opciones");
            opcionesDiv.innerHTML = ""; // Limpia opciones anteriores

            const fragment = document.createDocumentFragment(); // Usa un fragmento para mejor rendimiento

            // Crea los botones de opci√≥n para la pregunta
            p.opciones.forEach((opcion, i) => {
                const btn = document.createElement("button");
                btn.textContent = opcion;
                btn.addEventListener('click', () => {
                    if (i === p.correcta) {
                        // Respuesta correcta
                        reproducirSonido(sonidoCorrecto);
                        feedbackHaptico(100);
                        const puntosGanados = Math.max(0, 3 - progreso.intentos[preguntaId]); // M√°s puntos por menos intentos
                        progreso.puntaje += puntosGanados;
                        mostrarFelicitacionCorrecta(p); // Muestra felicitaci√≥n y avanza
                    } else {
                        // Respuesta incorrecta
                        reproducirSonido(sonidoIncorrecto);
                        feedbackHaptico([200, 100, 200]);
                        progreso.intentos[preguntaId]++; // Incrementa intentos
                        crearModalPersonalizado(
                            "Respuesta Incorrecta",
                            "¬°Ups! Esa no es la respuesta. Intent√° de nuevo.",
                            [{ texto: "Entendido", clase: "boton-negacion" }]
                        );
                    }
                });
                fragment.appendChild(btn);
            });
            opcionesDiv.appendChild(fragment);
            ventanaPregunta.classList.add("mostrar"); // Muestra la ventana de pregunta
            globalOverlay.style.display = "block"; // Muestra el overlay
            if (opcionesDiv.firstChild && typeof opcionesDiv.firstChild.focus === 'function') {
                opcionesDiv.firstChild.focus(); // Enfoca la primera opci√≥n para accesibilidad
            }
        }

        /**
         * Inicia el seguimiento continuo de la ubicaci√≥n del usuario y verifica la proximidad a las preguntas.
         */
        function iniciarSeguimientoUbicacion() {
            if (!navigator.geolocation) {
                crearModalPersonalizado("Error de Geolocalizaci√≥n", "La geolocalizaci√≥n no est√° soportada por tu navegador.", [{
                    texto: "Cerrar"
                }]);
                return;
            }

            // Si ya hay un seguimiento, simplemente centra el mapa si hay un marcador
            if (ubicacionWatchId !== null) {
                if (marcadorUbicacion) mapa.setView(marcadorUbicacion.getLatLng(), 17);
                return;
            }

            ubicacionWatchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const userLocation = L.latLng(pos.coords.latitude, pos.coords.longitude);
                    // Actualiza o crea el marcador de la ubicaci√≥n del usuario
                    if (marcadorUbicacion) {
                        marcadorUbicacion.setLatLng(userLocation);
                    } else {
                        marcadorUbicacion = L.marker(userLocation, {
                            icon: L.divIcon({
                                className: 'leaflet-div-icon',
                                html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#E53935"><path d="M12 2c-4.418 0-8 3.582-8 8 0 7 8 12 8 12s8-5 8-12c0-3.87-3.13-7-7-7zm0 11c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3z"/></svg>',
                                iconSize: [30, 30],
                                iconAnchor: [15, 30]
                            })
                        }).addTo(mapa).bindPopup("¬°Est√°s aqu√≠!");
                        mapa.setView(userLocation, 17); // Centra el mapa en la ubicaci√≥n inicial
                    }

                    // Verifica la proximidad a la pregunta actual
                    if (progreso.actual < obtenerPreguntas().length) {
                        const preguntaActual = obtenerPreguntas()[progreso.actual];
                        const preguntaId = `pregunta_${progreso.actual}`;
                        const preguntaLocation = L.latLng(preguntaActual.coords);
                        const distance = userLocation.distanceTo(preguntaLocation);

                        // Asegura que el marcador de la pregunta actual est√© visible
                        if (preguntaActual.marker && !mapa.hasLayer(preguntaActual.marker)) {
                            preguntaActual.marker.setOpacity(1).addTo(mapa);
                        }
                        actualizarVisibilidadMarcadorActual();

                        const preguntaYaActivada = (progreso.intentos[preguntaId] !== undefined);

                        // Si el usuario est√° dentro del radio de activaci√≥n y la pregunta no est√° activa ni la ventana de felicitaci√≥n, muestra la pregunta
                        if (distance <= ACTIVATION_RADIUS && !ventanaPregunta.classList.contains('mostrar') && !preguntaYaActivada && !ventanaFelicitacion.classList.contains('mostrar')) {
                            reproducirAlarma(); // Alarma al activar la pregunta
                            progreso.intentos[preguntaId] = 0; // Reinicia o establece intentos para esta pregunta
                            // Deshabilita la interactividad del marcador de pregunta para evitar m√∫ltiples activaciones
                            if (preguntaActual.marker.options.interactive) {
                                preguntaActual.marker.closeTooltip();
                                preguntaActual.marker.options.interactive = false;
                            }
                            mapa.setView(preguntaLocation, 17); // Centra el mapa en la pregunta
                            mostrarPregunta(progreso.actual); // Muestra el modal de la pregunta
                        } else if (distance > ACTIVATION_RADIUS) {
                            // Si el usuario se aleja, asegura que el marcador no sea interactivo
                            if (preguntaActual.marker.options.interactive) {
                                preguntaActual.marker.options.interactive = false;
                                preguntaActual.marker.closeTooltip();
                            }
                        }
                    }
                },
                (err) => {
                    console.error(`ERROR(${err.code}): ${err.message}`);
                    crearModalPersonalizado(
                        "Error de Geolocalizaci√≥n",
                        `No se pudo obtener tu ubicaci√≥n: ${err.message}. Verifica los permisos.`,
                        [{ texto: "Cerrar" }]
                    );
                    // Detiene el seguimiento si hay un error persistente
                    if (ubicacionWatchId !== null) {
                        navigator.geolocation.clearWatch(ubicacionWatchId);
                        ubicacionWatchId = null;
                    }
                }, {
                    enableHighAccuracy: true, // Solicita la m√°xima precisi√≥n
                    timeout: 10000,          // Tiempo m√°ximo para obtener la ubicaci√≥n (10 segundos)
                    maximumAge: 0            // No usa cach√©, siempre intenta obtener una ubicaci√≥n nueva
                }
            );
            actualizarVisibilidadMarcadorActual(); // Asegura la visibilidad del marcador al inicio del seguimiento
        }

        /**
         * Actualiza el panel de progreso en la interfaz.
         */
        function actualizarPanelProgreso() {
            const totalPreguntas = obtenerPreguntas().length;
            const porcentaje = totalPreguntas > 0 ? Math.round((progreso.actual / totalPreguntas) * 100) : 0;
            document.getElementById("progreso-porcentaje").style.width = porcentaje + "%";
            document.getElementById("progreso-texto").textContent =
                `${progreso.actual} / ${totalPreguntas} preguntas respondidas - Puntaje: ${progreso.puntaje} / ${totalPreguntas * 3}`;
        }

        /**
         * Reinicia la trivia, recargando la p√°gina.
         * Pide confirmaci√≥n al usuario antes de reiniciar.
         */
        function reiniciarTrivia() {
            crearModalPersonalizado(
                "Reiniciar Trivia",
                "¬øEst√°s seguro que quer√©s reiniciar tu progreso? Se perder√° todo.",
                [
                    { texto: "S√≠, reiniciar", clase: "boton-negacion", callback: () => location.reload() },
                    { texto: "No, continuar", clase: "boton-confirmacion" }
                ]
            );
        }

        /**
         * Muestra la ventana final de resultados al completar la trivia.
         */
        function mostrarVentanaFinal() {
            const totalPreguntas = obtenerPreguntas().length;
            document.getElementById("puntaje-final").textContent = `${progreso.puntaje} / ${totalPreguntas * 3}`;
            const porcentajeScore = totalPreguntas > 0 ? progreso.puntaje / (totalPreguntas * 3) : 0;
            let mensaje = "";
            if (porcentajeScore < 0.4) mensaje = "Debes estudiar m√°s de la fauna y flora de nuestro parque. ¬°Vuelve a intentarlo!";
            else if (porcentajeScore <= 0.6) mensaje = "Tienes conocimientos b√°sicos de nuestra flora y fauna. ¬°Puedes esforzarte un poco m√°s!";
            else if (porcentajeScore <= 0.89) mensaje = "Tienes muy buenos conocimientos del parque. ¬°Un poco m√°s de estudio y lo aprender√°s todo!";
            else mensaje = "¬°Eres un experto conocedor del Parque Francisco Tau!";

            document.getElementById("mensaje-final").textContent = mensaje;
            ventanaFinal.classList.add("mostrar");
            globalOverlay.style.display = "block"; // Muestra el overlay
            document.getElementById("boton-cerrar-final").focus();

            // Detiene el seguimiento de ubicaci√≥n y limpia el c√≠rculo de radio al finalizar
            if (ubicacionWatchId !== null) {
                navigator.geolocation.clearWatch(ubicacionWatchId);
                ubicacionWatchId = null;
            }
            if (currentQuestionRadiusCircle) {
                mapa.removeLayer(currentQuestionRadiusCircle);
                currentQuestionRadiusCircle = null;
            }
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // Cancela cualquier habla en curso
            }

            // Pide confirmaci√≥n para enviar resultados
            crearModalPersonalizado(
                "Resultados de la Trivia",
                "¬øDeseas enviar tus resultados y finalizar la aplicaci√≥n?",
                [
                    {
                        texto: "S√≠, enviar y salir",
                        clase: "boton-confirmacion",
                        callback: () => {
                            const score = progreso.puntaje;
                            const reserveName = "ReservaNaturalFranciscoTau";
                            const params = new URLSearchParams({
                                score: score,
                                reserve: reserveName
                            }).toString();
                            // ¬°IMPORTANTE! Reemplaza esta URL con la real de tu repositorio/p√°gina de GitHub
                            const targetUrl = `https://TU_USUARIO_GITHUB.github.io/TU_REPOSITORIO/resultados.html?${params}`;
                            window.location.href = targetUrl;
                        }
                    },
                    {
                        texto: "No, solo cerrar",
                        clase: "boton-negacion",
                        callback: () => {
                            cerrarVentanaFinal();
                        }
                    }
                ]
            );
        }

        /**
         * Cierra la ventana final de resultados.
         */
        function cerrarVentanaFinal() {
            ventanaFinal.classList.remove("mostrar");
            globalOverlay.style.display = "none"; // Oculta el overlay
        }

        /**
         * Muestra la ubicaci√≥n actual del usuario en el mapa o informa sobre el estado del GPS.
         */
        function accionMostrarUbicacion() {
            if (marcadorUbicacion && mapa.hasLayer(marcadorUbicacion)) {
                mapa.setView(marcadorUbicacion.getLatLng(), 17); // Centra el mapa en la ubicaci√≥n del usuario
                marcadorUbicacion.openPopup(); // Abre el popup del marcador
            } else if (!ubicacionWatchId) {
                iniciarSeguimientoUbicacion(); // Inicia el seguimiento si no est√° activo
                crearModalPersonalizado("Ubicaci√≥n", "Iniciando seguimiento de ubicaci√≥n para mostrarte en el mapa.", [{ texto: "OK" }]);
            } else {
                crearModalPersonalizado("Ubicaci√≥n", "Esperando se√±al de GPS para mostrar tu ubicaci√≥n...", [{ texto: "OK" }]);
            }
        }

        /**
         * Alterna el estado del sonido (activado/desactivado) y actualiza el icono.
         */
        function toggleSonido() {
            sonidoActivado = !sonidoActivado;
            if (sonidoActivado) {
                iconSoundOn.style.display = 'inline-block';
                iconSoundOff.style.display = 'none';
            } else {
                iconSoundOn.style.display = 'none';
                iconSoundOff.style.display = 'inline-block';
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel(); // Cancela cualquier habla si se desactiva el sonido
                }
            }
            crearModalPersonalizado("Sonido", `Sonido ${sonidoActivado ? 'activado' : 'desactivado'}.`, [{ texto: "OK" }]);
        }
        
        // ==================================================================== */
        //                             INICIALIZACI√ìN                           */
        /* ==================================================================== */

        // Evento que se dispara cuando el DOM est√° completamente cargado
        document.addEventListener('DOMContentLoaded', async () => {
            // Inicializa el chatbot de n8n
            createChat({
                webhookUrl: 'https://n8n.efficienza.es/webhook/8173e5e9-1b3c-445f-9beb-d0f5360d7ba4/chat',
                webhookConfig: {
                    method: 'POST',
                    headers: {}
                },
                target: '#n8n-chat',
                mode: 'window',
                chatInputKey: 'chatInput',
                chatSessionKey: 'sessionId',
                metadata: {},
                showWelcomeScreen: false,
                defaultLanguage: 'es',
                initialMessages: [
                    '¬°Hola! Soy tu Guarda parque Virtual. Escribe tu mensaje en la barra de abajo.'
                ],
                i18n: {
                    es: {
                        title: 'Guarda parque Virtual',
                        subtitle: "Inicia una conversaci√≥n. Estamos aqu√≠ para ayudarte.",
                        footer: '',
                        getStarted: 'Nueva Conversaci√≥n',
                        inputPlaceholder: 'Escribe tu mensaje..',
                    },
                },
            });

            // Asigna listeners a los botones de selecci√≥n de edad
            document.querySelectorAll('#botones-edad button').forEach(button => {
                button.addEventListener('click', function () {
                    seleccionarEdad(this.dataset.edad, this);
                });
            });

            // Asigna listeners a los botones de control de la trivia
            document.getElementById('boton-comenzar-instrucciones').addEventListener('click', cerrarVentanaInstrucciones);
            document.getElementById('boton-reiniciar').addEventListener('click', reiniciarTrivia);
            document.getElementById('boton-mostrar-ubicacion').addEventListener('click', accionMostrarUbicacion);
            document.getElementById('boton-cerrar-final').addEventListener('click', cerrarVentanaFinal);
            botonToggleSonido.addEventListener('click', toggleSonido);

            // Muestra la ventana de bienvenida al cargar la p√°gina
            if (ventanaBienvenida) {
                ventanaBienvenida.classList.add("mostrar");
                globalOverlay.style.display = "block"; // Muestra el overlay

                // Reproduce el texto de bienvenida si a√∫n no se ha le√≠do (considerando pol√≠ticas de autoplay)
                if (!bienvenidaLeida) {
                    const tituloBienvenida = document.getElementById("titulo-bienvenida").textContent;
                    const parrafoBienvenida = document.querySelector("#ventana-bienvenida p").textContent;
                    reproducirTexto(tituloBienvenida + " " + parrafoBienvenida);
                    bienvenidaLeida = true;
                }
            } else {
                console.error('Error: Element with ID "ventana-bienvenida" not found.');
            }
        });
    </script>

</body>

</html>














