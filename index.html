<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Trivia Francisco Tau</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="manifest" href="manifest.json">

    <!-- Enlace al CSS del chatbot de n8n -->
    <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />

    <style>
        /* ==================================================================== */
        /* VARIABLES CSS GLOBALES                      */
        /* ==================================================================== */
        :root {
            --color-primario-verde: #4CAF50;
            --color-primario-verde-claro: #66bb6a;
            --color-primario-verde-oscuro: #388E3C;
            --color-secundario-azul: #2196f3;
            --color-secundario-azul-claro: #42a5f5;
            --color-secundario-azul-oscuro: #1976D2;
            --color-error-rojo: #e53935;
            --color-error-rojo-claro: #ef5350;
            --color-texto-oscuro: #333;
            --color-texto-blanco: #fff;
            --color-fondo-overlay: rgba(255, 255, 255, 0.85);

            --radio-borde-general: 8px;
            --radio-borde-modal: 12px;
            --radio-borde-modal-grande: 15px;

            --padding-boton: 12px 25px;
            --padding-modal: 30px;
            --padding-modal-grande: 35px 30px;

            --sombra-elemento: 0 4px 10px rgba(0, 0, 0, 0.15), 0 2px 5px rgba(0, 0, 0, 0.1);
            --sombra-elemento-hover: 0 6px 12px rgba(0, 0, 0, 0.2);
            --sombra-modal: 0 15px 40px rgba(0, 0, 0, 0.2), 0 6px 20px rgba(0, 0, 0, 0.15);
            --sombra-modal-hover: 0 8px 20px rgba(0, 0, 0, 0.25);

            --fuente-principal: Arial, sans-serif;
            --tamano-fuente-normal: 16px;
            --tamano-fuente-boton: 17px;
            --tamano-fuente-titulo-modal: 1.8em;
        }

        /* ==================================================================== */
        /* ESTILOS GENERALES                         */
        /* ==================================================================== */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: var(--fuente-principal);
            font-size: var(--tamano-fuente-normal);
            background-image: url('fondo.jpg'); /* Asegúrate de que 'fondo.jpg' exista en la misma carpeta */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            /* Previene el zoom accidental y mejora la interacción táctil */
            touch-action: pan-x pan-y;
            /* Deshabilita la selección de texto en la interfaz */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* Evita el scroll del body cuando el overlay está activo */
            overflow: auto; /* Valor por defecto */
        }

        body.no-scroll {
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100%;
            touch-action: manipulation; /* Permite interacciones de mapa como el zoom y arrastre */
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }

        /* ==================================================================== */
        /* ESTILOS DE MODALES                      */
        /* ==================================================================== */
        .modal-base {
            position: fixed; /* Cambiado a fixed para asegurar que no se desplace con el scroll */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: var(--padding-modal);
            border-radius: var(--radio-borde-modal);
            z-index: 1000;
            width: 90vw;
            max-width: 450px;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: var(--sombra-modal);
            display: none; /* Oculto por defecto */
            animation: fadeIn 0.5s ease-out; /* Animación de aparición */

            /* Fondo con imagen y overlay para legibilidad */
            background: linear-gradient(var(--color-fondo-overlay), var(--color-fondo-overlay)), url('fondoventanas.jpg'); /* Asegúrate de que 'fondoventanas.jpg' exista */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .modal-base.mostrar {
            display: block; /* Muestra el modal */
        }

        .modal-base h2 {
            font-size: var(--tamano-fuente-titulo-modal);
            color: var(--color-texto-oscuro);
            margin-bottom: 20px;
            font-weight: bold;
            text-shadow: 0 0 8px var(--color-texto-blanco);
        }

        .modal-base p {
            color: var(--color-texto-oscuro);
            text-shadow: 0 0 8px var(--color-texto-blanco);
            font-weight: bold;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        /* Estilos específicos para la ventana de felicitación de respuesta */
        #ventana-felicitacion {
            /* Asegúrate de que herede o tenga las propiedades de modal-base */
            /* En este caso, ya tiene su propio estilo que duplica modal-base,
               pero se asegura 'position: fixed' para que no se desplace. */
            position: fixed; /* Asegura que no se desplace */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: var(--padding-modal-grande);
            border-radius: var(--radio-borde-modal-grande);
            box-shadow: var(--sombra-modal);
            z-index: 10006; /* Debe ser más alto que el overlay (999) */
            text-align: center;
            max-width: 500px;
            width: 90vw;
            color: var(--color-texto-oscuro);
            display: none;
            animation: fadeIn 0.5s ease-out;
        }


        #ventana-felicitacion.mostrar {
            display: block;
        }

        #ventana-felicitacion h3 {
            font-size: 2em;
            color: var(--color-primario-verde-oscuro);
            margin-bottom: 20px;
        }

        #ventana-felicitacion img {
            max-width: 100%;
            height: auto;
            border-radius: var(--radio-borde-general);
            margin-bottom: 20px;
            box-shadow: var(--sombra-elemento);
        }

        #ventana-felicitacion p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 20px;
            text-shadow: none;
            font-weight: normal;
        }

        #ventana-felicitacion button {
            background: linear-gradient(135deg, var(--color-secundario-azul-claro) 0%, var(--color-secundario-azul) 100%);
        }

        #ventana-felicitacion button:hover {
            background: linear-gradient(135deg, var(--color-secundario-azul) 0%, var(--color-secundario-azul-oscuro) 100%);
        }

        /* Estilos para el overlay global que bloquea la interacción de fondo */
        #global-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Fondo oscuro semi-transparente */
            z-index: 999; /* Debajo de los modales, por encima del mapa */
            display: none; /* Oculto por defecto */
        }

        /* ==================================================================== */
        /* ESTILOS DE BOTONES                      */
        /* ==================================================================== */
        button, .button-style {
            margin: 10px 5px;
            padding: var(--padding-boton);
            font-size: var(--tamano-fuente-boton);
            border-radius: var(--radio-borde-general);
            border: 1px solid rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, var(--color-primario-verde-claro) 0%, var(--color-primario-verde) 100%);
            color: var(--color-texto-blanco);
            cursor: pointer;
            box-shadow: var(--sombra-elemento);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, opacity 0.2s ease;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-decoration: none;
            display: inline-block;
            outline: none;
            min-height: 44px; /* Tamaño mínimo para una fácil interacción táctil */
            min-width: 44px;  /* Tamaño mínimo para una fácil interacción táctil */
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        button:hover, .button-style:hover {
            background: linear-gradient(135deg, var(--color-primario-verde) 0%, var(--color-primario-verde-oscuro) 100%);
            transform: translateY(-2px);
            box-shadow: var(--sombra-elemento-hover);
        }

        /* Estilos para estados de foco y activo (navegación por teclado/feedback de click) */
        button:focus-visible, button:focus, .button-style:focus-visible, .button-style:focus {
            transform: translateY(0);
            border: 3px solid var(--color-secundario-azul-claro);
            box-shadow: 0 0 0 2px var(--color-secundario-azul-claro),
                        0 3px 8px rgba(0, 0, 0, 0.25);
        }

        button:active, .button-style:active {
            transform: scale(0.95);
            opacity: 0.8;
            box-shadow: var(--sombra-elemento);
        }

        /* Estilo para los botones de selección de edad */
        .age-selection-button {
            background: linear-gradient(135deg, var(--color-secundario-azul-claro) 0%, var(--color-secundario-azul) 100%) !important;
            border: 3px solid var(--color-secundario-azul-claro) !important;
            box-shadow: var(--sombra-elemento) !important;
        }

        .age-selection-button.seleccionado {
            border-color: var(--color-primario-verde-oscuro) !important;
            box-shadow: 0 0 0 4px var(--color-primario-verde-claro), var(--sombra-elemento-hover) !important;
            transform: scale(1.02);
            background: linear-gradient(135deg, var(--color-primario-verde) 0%, var(--color-primario-verde-oscuro) 100%) !important;
        }

        /* Estilo para botones deshabilitados */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #ccc !important;
            box-shadow: none !important;
            transform: none !important;
            border-color: #aaa !important;
        }

        /* Botones fijos en la esquina superior derecha */
        #botones-fijos {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10008; /* Se ajustó el z-index para que esté por encima de los modales */
            display: flex;
            flex-direction: column;
            gap: 5px;
            display: none; /* Oculto por defecto, se muestra con JS */
        }

        #botones-fijos button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
        }

        #botones-fijos button svg {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            fill: var(--color-texto-blanco);
        }

        /* Texto de los botones fijos oculto en pantallas pequeñas, visible en grandes */
        #botones-fijos button span {
            display: none;
        }

        /* Contenedor de opciones de pregunta (botones de respuesta) */
        #opciones {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        #opciones button {
            padding: 15px; /* Aumentado para mejor ajuste de texto */
            font-size: 1.1em;
            cursor: pointer;
            border: none;
            border-radius: var(--radio-borde-general);
            background-color: var(--color-secundario-azul-claro);
            color: var(--color-texto-blanco);
            box-shadow: var(--sombra-elemento);
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.1s ease;
            font-weight: bold;
            text-align: center;
            white-space: normal; /* Permite que el texto se ajuste en varias líneas */
            overflow-wrap: break-word; /* Permite que palabras muy largas se rompan */
            word-break: break-word; /* Para mayor compatibilidad con navegadores antiguos */
            min-height: 60px; /* Aumentado para dar más espacio vertical al texto */
            line-height: 1.4;
        }

        #opciones button:hover {
            background-color: var(--color-secundario-azul);
            box-shadow: var(--sombra-elemento-hover);
        }

        #opciones button:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        /* Botones de confirmación/negación en modales personalizados */
        .custom-js-modal .boton-confirmacion {
            background: linear-gradient(135deg, var(--color-primario-verde-claro) 0%, var(--color-primario-verde) 100%);
        }

        .custom-js-modal .boton-confirmacion:hover {
            background: linear-gradient(135deg, var(--color-primario-verde) 0%, var(--color-primario-verde-oscuro) 100%);
        }

        .custom-js-modal .boton-negacion {
            background: linear-gradient(135deg, var(--color-error-rojo-claro) 0%, var(--color-error-rojo) 100%);
        }

        .custom-js-modal .boton-negacion:hover {
            background: linear-gradient(135deg, var(--color-error-rojo) 0%, #d32f2f 100%);
        }

        /* ==================================================================== */
        /* PANEL DE PROGRESO                          */
        /* ==================================================================== */
        #panel-progreso {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: calc(100% - 20px);
            max-width: 350px;
            background: var(--color-fondo-overlay);
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: var(--radio-borde-general);
            padding: 10px;
            z-index: 999;
            box-shadow: var(--sombra-elemento);
            font-size: 14px;
            color: var(--color-texto-oscuro);
            display: none; /* Oculto por defecto, se muestra con JS */
        }

        #barra-progreso {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: var(--radio-borde-general);
            overflow: hidden;
            margin-bottom: 5px;
        }

        #progreso-porcentaje {
            height: 100%;
            width: 0%;
            background-color: var(--color-primario-verde);
            transition: width 0.5s ease;
        }

        /* ==================================================================== */
        /* MODAL DE FELICITACIÓN FINAL (Nuevo)        */
        /* ==================================================================== */
        #ventana-felicitacion-final {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: var(--padding-modal-grande);
            border-radius: var(--radio-borde-modal-grande);
            box-shadow: var(--sombra-modal);
            z-index: 10006;
            text-align: center;
            max-width: 500px;
            width: 90vw;
            color: var(--color-texto-oscuro);
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        #ventana-felicitacion-final.mostrar {
            display: block;
        }

        #ventana-felicitacion-final h3 {
            font-size: 2em;
            color: var(--color-primario-verde-oscuro);
            margin-bottom: 20px;
        }

        #ventana-felicitacion-final img {
            max-width: 100%;
            height: auto;
            border-radius: var(--radio-borde-general);
            margin-bottom: 20px;
            box-shadow: var(--sombra-elemento);
        }

        #ventana-felicitacion-final p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 20px;
            text-shadow: none;
            font-weight: normal;
        }
        /* ELIMINADO: No hay botón "Volver a jugar" aquí */

        /* ==================================================================== */
        /* EXPLICACIÓN DE RESPUESTA                   */
        /* ==================================================================== */
        #explicacion-respuesta {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(240, 240, 240, 0.9);
            border-radius: var(--radio-borde-general);
            text-align: left;
            font-size: 0.95em;
            color: var(--color-texto-oscuro);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        #explicacion-respuesta.mostrar {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        /* ==================================================================== */
        /* MODAL CUSTOM JS                          */
        /* ==================================================================== */
        .custom-js-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--color-texto-blanco);
            padding: var(--padding-modal);
            border-radius: var(--radio-borde-modal);
            box-shadow: var(--sombra-modal);
            z-index: 10005;
            text-align: center;
            max-width: 380px;
            width: 85vw;
            color: var(--color-texto-oscuro);
        }

        .custom-js-modal h3 {
            font-size: 1.5em;
            color: var(--color-texto-oscuro);
            margin-bottom: 15px;
            font-weight: bold;
        }

        .custom-js-modal p {
            font-size: 1.1em;
            margin-bottom: 25px;
            line-height: 1.5;
            text-shadow: none;
            font-weight: normal;
        }

        .custom-js-modal .modal-botones button {
            margin: 8px;
            padding: 10px 20px;
        }

        /* ==================================================================== */
        /* ANIMACIONES                            */
        /* ==================================================================== */
        @keyframes fadeIn {
            0% { opacity: 0; transform: translate(-50%, -55%); }
            100% { opacity: 1; transform: translate(-50%, -50%); }
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* NUEVA ANIMACIÓN para el botón de reiniciar */
        @keyframes highlightPulse {
            0% { transform: scale(1); box-shadow: var(--sombra-elemento); }
            50% { transform: scale(1.03); box-shadow: 0 0 0 4px var(--color-primario-verde-claro), 0 4px 15px rgba(0, 0, 0, 0.3); }
            100% { transform: scale(1); box-shadow: var(--sombra-elemento); }
        }

        /* Clase para resaltar el botón de reiniciar */
        #botones-fijos .highlight-restart-button {
            animation: highlightPulse 2s infinite ease-in-out;
            border: 3px solid var(--color-primario-verde-oscuro); /* Un borde más notorio */
            /* Asegura que estas propiedades se mantengan sobre los estilos base del botón */
            background: linear-gradient(135deg, var(--color-primario-verde-claro) 0%, var(--color-primario-verde) 100%);
            color: var(--color-texto-blanco);
        }

        /* ==================================================================== */
        /* ICONO DE UBICACIÓN LEAFLET                 */
        /* ==================================================================== */
        .leaflet-div-icon {
            background: none;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px !important;
            height: 30px !important;
            transform-origin: bottom center;
        }

        .leaflet-div-icon svg {
            width: 100%;
            height: 100%;
            display: block;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.4));
            animation: pulse 1.5s infinite ease-in-out;
        }

        /* ==================================================================== */
        /* MEDIA QUERIES (RESPONSIVE)                */
        /* ==================================================================== */
        @media (max-width: 600px) {
            .modal-base, .custom-js-modal, #ventana-felicitacion, #ventana-felicitacion-final {
                width: 95vw;
                max-width: 95vw;
            }

            .modal-base h2 { font-size: 1.5em; }
            .custom-js-modal h3 { font-size: 1.3em; }
            .custom-js-modal p { font-size: 1em; }
            #ventana-felicitacion h3, #ventana-felicitacion-final h3 { font-size: 1.5em; }
            #panel-progreso { font-size: 13px; }

            #botones-fijos {
                top: 10px;
                right: 10px;
                flex-direction: column;
                gap: 6px;
                align-items: flex-end;
            }

            #botones-fijos button {
                margin-bottom: 0;
                padding: 8px 12px;
                font-size: 14px;
            }

            #botones-fijos button span {
                display: inline; /* Muestra el texto en pantallas pequeñas */
            }
        }

        /* Media query para pantallas más grandes para mostrar texto junto a los iconos */
        @media (min-width: 601px) {
            #botones-fijos button span {
                display: inline;
            }
        }

        /* ==================================================================== */
        /* ESTILOS CHATBOT N8N                       */
        /* ==================================================================== */
        #n8n-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10007;
            width: 60px;
            height: 60px;
        }

        /* Estilos para el botón flotante real que crea n8n (clases comunes) */
        #n8n-chat .n8n-chat-bubble,
        #n8n-chat .n8n-chat-launcher {
            background-color: #25D366 !important; /* Color de WhatsApp */
            color: white !important;
            border-radius: 50% !important;
            width: 60px !important;
            height: 60px !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            transition: transform 0.2s ease, box-shadow 0.2s ease !important;
            padding: 0 !important;
        }

        #n8n-chat .n8n-chat-bubble:hover,
        #n8n-chat .n8n-chat-launcher:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3) !important;
        }

        #n8n-chat .n8n-chat-bubble:active,
        #n8n-chat .n8n-chat-launcher:active {
            transform: scale(0.95) !important;
        }
    </style>
</head>

<body>

    <div id="map"></div>
    <div id="global-overlay"></div> <!-- Overlay para bloquear interacción de fondo -->

    <!-- Ventana de bienvenida y selección de edad -->
    <div id="ventana-bienvenida" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="titulo-bienvenida">
        <h2 id="titulo-bienvenida">¡Bienvenido a la trivia de la "Reserva Natural Francisco Tau"!</h2>
        <p>¿En qué rango de edad te encontrás?</p>
        <div id="botones-edad">
            <button data-edad="menor6" class="age-selection-button">Menor a 6 años</button>
            <button data-edad="6a12" class="age-selection-button">Entre 6 y 12 años</button>
            <button data-edad="mayor12" class="age-selection-button">Mayor a 12 años</button>
        </div>
    </div>

    <!-- Ventana de instrucciones -->
    <div id="ventana-instrucciones" class="modal-base" role="dialog" aria-modal="true"
        aria-labelledby="titulo-instrucciones">
        <h2 id="titulo-instrucciones">¡Bienvenido a la trivia de la "Reserva Natural Francisco Tau"!</h2>
        <p>En esta trivia aprenderemos diferentes aspectos naturales, culturales y sociales de nuestra reserva natural.</p>
        <p>Para poder realizar la experiencia de la forma más óptima debemos realizar dos cosas:</p>
        <p>En primer lugar, activar la ubicación y en segundo, activar el sonido.</p>
        <p>¡Esperamos que disfrutes este viaje por la reserva!</p>
        <button id="boton-comenzar-instrucciones">¡Comencemos!</button>
    </div>

    <!-- Ventana de pregunta -->
    <div id="pregunta" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="texto-pregunta">
        <p id="texto-pregunta"></p>
        <div id="opciones"></div>
        <div id="explicacion-respuesta"></div>
    </div>

    <!-- Ventana de felicitación por respuesta correcta -->
    <div id="ventana-felicitacion" role="dialog" aria-modal="true" aria-labelledby="titulo-felicitacion">
        <h3 id="titulo-felicitacion">¡Respuesta Correcta!</h3>
        <img id="felicitacion-imagen" src="algarrobo.jpg" alt="Imagen del lugar"> <!-- Placeholder, se carga dinámicamente -->
        <p id="felicitacion-explicacion"></p>
        <button id="boton-continuar-felicitacion">Continuar</button>
    </div>

    <!-- Botones fijos en la interfaz principal del mapa -->
    <div id="botones-fijos">
        <button id="boton-reiniciar" aria-label="Reiniciar Trivia">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M12 4V1l-4 4 4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z" />
            </svg>
            <span>Reiniciar</span>
        </button>
        <button id="boton-mostrar-ubicacion" aria-label="Mostrar mi ubicación">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
            </svg>
            <span>Mi ubicación</span>
        </button>
        <button id="boton-toggle-sonido" aria-label="Activar/Desactivar Sonido">
            <svg id="icon-sound-on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
            </svg>
            <svg id="icon-sound-off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display:none;">
                <path
                    d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .9-.23 1.74-.63 2.5L20.5 17c.92-1.23 1.5-2.77 1.5-4.5 0-4.01-2.99-7.11-7-8.77v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71zM4.27 3L3 4.27l9 9V19c0 1.38-1.12 2.5-2.5 2.5S6 20.38 6 19v-1H2v1c0 2.21 1.79 4 4 4s4-1.79 4-4V7.27L1.27 0 0 1.27l3 3zm7.53 10.73L7.27 9H3v6h3.73l4.5 4.5c.66.33 1.41.5 2.22.5 2.05 0 3.8-.96 4.99-2.4l-2.72-2.72z" />
            </svg>
            <span>Sonido</span>
        </button>
    </div>

    <!-- Panel de progreso de la trivia -->
    <div id="panel-progreso">
        <div id="barra-progreso">
            <div id="progreso-porcentaje"></div>
        </div>
        <div id="progreso-texto">0 / 0 preguntas respondidas - Correctas: 0</div>
    </div>

    <!-- Ventana de felicitaciones final (Reemplaza la antigua ventana final) -->
    <div id="ventana-felicitacion-final" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="titulo-felicitacion-final">
        <h3 id="titulo-felicitacion-final">¡Felicidades!</h3>
        <p id="mensaje-felicitacion-final"></p>
        <p>Tu puntaje final es: <span id="puntaje-final"></span></p>
        <!-- BOTÓN ELIMINADO: <button id="boton-reiniciar-final">Volver a jugar</button> -->
    </div>

    <!-- Elementos de audio -->
    <audio id="sonido-correcto" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"
        preload="auto"></audio>
    <audio id="sonido-incorrecto" src="https://actions.google.com/sounds/v1/cartoon/boing.ogg"
        preload="auto"></audio>
    <audio id="alarmaSonido" preload="auto">
        <source src="alarma.mp3" type="audio/mpeg"> <!-- Asegúrate de que 'alarma.mp3' exista en la misma carpeta -->
        Tu navegador no soporta el elemento de audio.
    </audio>

    <!-- Contenedor para el chatbot de n8n -->
    <div id="n8n-chat"></div>

    <!-- Scripts externos -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script type="module">
        import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

        // ==================================================================== */
        //                         VARIABLES GLOBALES Y DATOS                   */
        /* ==================================================================== */
        const preguntasData = {
            "menor6": [
                {
                    "coords": [-34.72326,-58.39772],
                    "texto": "“ Tengo tronco fuerte y vainas dulces; doy mucha sombra en el parque. ¿Quién soy?”",
                    "opciones": ["Eucalipto", "Pino", "Algarrobo blanco"],
                    "correcta": 2,
                    "explicacion": "¡Este algarrobo vive en el Parque Tau desde hace más de 400 años! Es un “abuelo” del bosque que da sombra fresca y alimento a muchos animalitos.",
                    "fotoUrl": "algarrobo.jpg"
                },
                {
                    "coords": [-34.72326,-58.39772],
                    "texto": "“Toc-toc, pico el barro y hago mi casita redonda. ¿Quién canta así?”",
                    "opciones": ["Gorrión", "Hornero", "Jilguero"],
                    "correcta": 1,
                    "explicacion": "El hornero es un pajarito constructor: amasa barro como plastilina y levanta un nido redondo que parece un hornito de pan.",
                    "fotoUrl": "hornero.jpg"
                },
                {
                    "coords": [-34.72326,-58.39772],
                    "texto": "“Me abrochas antes de subir al gomón para que flotes seguro. ¿Qué soy?”",
                    "opciones": ["Casco", "Salvavidas", "Remo"],
                    "correcta": 1,
                    "explicacion": "La Fundación tiene ¡cien chalecos! Se cierran con clic-clic y te abrazan para que navegues protegido mientras disfrutas del río.",
                    "fotoUrl": "chaleco.jpg"
                },
                {
                    "coords": [-34.72326,-58.39772],
                    "texto": "“Serpenteo con agua fresca junto al bosque del parque. ¿Cómo me llamo?”",
                    "opciones": ["Río Segundo", "Río Primero", "Río Ctalamochita"],
                    "correcta": 2,
                    "explicacion": "Su nombre indígena significa “lugar de muchos árboles”. Con sus curvas suaves forma playitas donde peces, plantas y personas se refrescan.",
                    "fotoUrl": "rioct.jpg"
                },
                {
                    "coords": [-34.72326,-58.39772],
                    "texto": "“Tomo sol quieto, tengo escamas y una lengua larga. ¿Quién soy?”",
                    "opciones": ["Serpiente", "Tortuga", "Lagarto overo"],
                    "correcta": 2,
                    "explicacion": "Este lagarto moteado adora broncearse en los claros del parque. Ayuda a mantener el equilibrio porque se come insectos y pequeños bichitos.",
                    "fotoUrl": "lagarto.jpg"
                },
                {
                    "coords": [-34.72326,-58.39772],
                    "texto": "“Cuelgo de los árboles como una flor que vive del aire. ¿Cómo me llaman?”",
                    "opciones": ["Orquídea", "Clavel del aire", "Rosa"],
                    "correcta": 1,
                    "explicacion": "No necesita tierra: bebe la humedad del viento y adorna las ramas con sus hojitas plateadas, ¡un colgante natural del bosque!",
                    "fotoUrl": "clavel.jpg"
                },
                {
                    "coords": [-34.72326,-58.39772],
                    "texto": "“Cuido plantas y animales y ayudo a los visitantes. ¿Quién soy?”",
                    "opciones": ["Científico", "Rurista", "Guardaparque"],
                    "correcta": 2,
                    "explicacion": "La guardaparque del Tau es la super-heroína verde: vigila senderos, da consejos y protege cada rincón del bosque todos los días.",
                    "fotoUrl": "guarda.png"
                },
                {
                    "coords": [-34.72326,-58.39772],
                    "texto": "“Si tiras basura aquí, ensucias a peces y patos. ¿Qué lugar es?”",
                    "opciones": ["El río", "El lago", "La calle"],
                    "correcta": 0,
                    "explicacion": "Usar los tachos y llevarte tus residuos mantiene el agua clarita y feliz; así el río sigue sano para nadar y remar.",
                    "fotoUrl": "rio.jpg"
                },
                {
                    "coords": [-34.72326,-58.39772],
                    "texto": "“Reciclando papel le salvamos la vida a este gran amigo verde. ¿Quién es?”",
                    "opciones": ["Pasto", "Flor", "Árbol"],
                    "correcta": 2,
                    "explicacion": "Los árboles dan sombra, aire puro y casita a los pájaros. En el parque crecen talas, chañares y un histórico algarrobo blanco que son verdaderos tesoros.",
                    "fotoUrl": "arbol.jpg"
                },
                {
                    "coords": [-34.72326,-58.39772],
                    "texto": "“Llevo gorrita roja y pechito blanco; mi canto suena fuerte. ¿Qué pájaro soy?”",
                    "opciones": ["Colibrí", "Cardenal común", "Benteveo"],
                    "correcta": 1,
                    "explicacion": "Con su “sombrerito” rojo brillante, el cardenal es una de las aves más vistosas del parque y se deja ver entre las ramas cantando con energía.",
                    "fotoUrl": "cardenal.jpg"
                }
            ],
            "6a12": [
                {
                    "coords": [-34.72326,-58.39727],
                    "texto": "¿Cuál es la especie de árbol nativo más antigua del Parque Francisco Tau, considerada un monumento natural viviente?",
                    "opciones": ["Algarrobo blanco", "Pino", "Eucalipto"],
                    "correcta": 0,
                    "explicacion": "Es un árbol nativo típico de la región chaqueña y pampeana, muy resistente a la sequía. En el Parque Francisco Tau, el algarrobo blanco aporta sombra y alimento a la fauna local con sus vainas dulces. Además, su madera es dura y se utiliza tradicionalmente para carpintería y artesanía. Es una especie clave para mantener el equilibrio ecológico del área.",
                    "fotoUrl": "algarrobo.jpg"
                },
                {
                    "coords": [-34.72326,-58.39727],
                    "texto": "¿Qué río atraviesa el Parque Francisco Tau y forma parte importante de su paisaje natural?",
                    "opciones": ["Río Segundo", "Río Primero", "Río Ctalamochita"],
                    "correcta": 2,
                    "explicacion": "El Río Ctalamochita, también llamado Río Tercero, atraviesa el Parque Francisco Tau y es fundamental para su ecosistema. Sus aguas forman balnearios naturales como El Diquecito y Paso de la Arena, y brindan hábitat a aves acuáticas, peces y mamíferos como el coipo. Además de su valor natural y recreativo, funciona como un corredor biológico, conectando distintos ambientes y favoreciendo la biodiversidad del parque.",
                    "fotoUrl": "rio.jpg"
                },
                {
                    "coords": [-34.72326,-58.39727],
                    "texto": "¿A qué bioma pertenece el monte nativo que protege el Parque Francisco Tau?",
                    "opciones": ["Chaco Húmedo", "Espinal", "Selva de Yungas"],
                    "correcta": 1,
                    "explicacion": "El Parque Francisco Tau conserva un relicto del bioma del Espinal, un tipo de bosque nativo de la llanura cordobesa. Se caracteriza por especies resistentes a la sequía como el algarrobo blanco, el tala, el chañar y el espinillo. Este ecosistema, hoy muy reducido por la expansión agrícola, es único en un centro urbano en Córdoba. Su preservación es fundamental para conservar la biodiversidad autóctona, estudiar el ambiente original de la región y mantener un pulmón verde para la ciudad.",
                    "fotoUrl": "espinal.jpg"
                },
                {
                    "coords": [-34.72326,-58.39727],
                    "texto": "¿Cuántas especies de aves, aproximadamente, han sido identificadas en el Parque Francisco Tau?",
                    "opciones": ["100", "135", "125"],
                    "correcta": 2,
                    "explicacion": "El Parque Francisco Tau alberga una gran diversidad de aves, con al menos 125 especies registradas, lo que lo convierte en un sitio ideal para la observación de aves. Se encuentran especies comunes y vistosas como el hornero, el benteveo, el cardenal común y el chingolo, así como aves acuáticas como el biguá, la gallareta y el martín pescador chico. También se observan aves rapaces como el carancho y la lechucita de las vizcacheras.\n\t\t\t\t\tLa variedad de hábitats del parque (bosque, ribera, pastizal) favorece esta riqueza avifaunística, que es clave para el equilibrio ecológico y un gran recurso para la educación ambiental.",
                    "fotoUrl": "ave.jpg"
                },
                {
                    "coords": [-34.72326,-58.39727],
                    "texto": "¿Qué roedor semiacuático, parecido a una nutria, habita en las orillas del Río Ctalamochita dentro del parque?",
                    "opciones": ["Comadreja overa", "Coipo", "Cuis"],
                    "correcta": 1,
                    "explicacion": "El coipo, también llamado nutria criolla, es un mamífero roedor semiacuático que vive en zonas cercanas al agua, como las orillas del Río Ctalamochita, dentro del Parque Francisco Tau. Tiene un cuerpo robusto, pelaje denso e impermeable, y una cola larga y redondeada. Sus patas trasmeras palmeadas le permiten nadar con gran agilidad. Se alimenta principalmente de vegetación acuática y raíces, y suele construir madrigueras en barrancas o entre la vegetación ribereña. Es una especie nativa de América del Sur y cumple un rol ecológico importante en el ecosistema acuático, ayudando a controlar el crecimiento de plantas en lagunas y ríos. Su presencia en el parque indica una buena calidad ambiental en los ambientes ribereños y la existencia de refugio adecuado para fauna nativa.",
                    "fotoUrl": "coipo.jpg"
                }
            ],
            "mayor12": [
                {
                    "coords": [-32.62763, -62.70419],
                    "texto": "¿Qué especie arbórea autóctona, propia del Espinal y con un ejemplar de más de cuatro siglos en el parque, representa un testimonio ecológico e histórico de la región?",
                    "opciones": ["Algarrobo blanco", "Pino", "Eucalipto"],
                    "correcta": 0,
                    "explicacion": "Es un árbol nativo típico de la región chaqueña y pampeana, muy resistente a la sequía. En el Parque Francisco Tau, el algarrobo blanco aporta sombra y alimento a la fauna local con sus vainas dulces. Además, su madera es dura y se utiliza tradicionalmente para carpintería y artesanía. Es una especie clave para mantener el equilibrio ecológico del área.",
                    "fotoUrl": "algarrobo.jpg"
                },
                {
                    "coords": [-32.62742,-62.70511],
                    "texto": "¿Cuál es el curso fluvial que recorre el parque, funcionando como corredor biológico y aportando ambientes acuáticos y ribereños?",
                    "opciones": ["Río Primero", "Río Ctalamochita", "Río Segundo"],
                    "correcta": 1,
                    "explicacion": "El Río Ctalamochita, también llamado Río Tercero, atraviesa el Parque Francisco Tau y es fundamental para su ecosistema. Sus aguas forman balnearios naturales como El Diquecito y Paso de la Arena, y brindan hábitat a aves acuáticas, peces y mamíferos como el coipo. Además de su valor natural y recreativo, funciona como un corredor biológico, conectando distintos ambientes y favoreciendo la biodiversidad del parque.",
                    "fotoUrl": "rio.jpg"
                },
                {
                    "coords": [-32.62655, -62.70584],
                    "texto": "¿Cuál es el nombre de la ecorregión fitogeográfica representada por el relicto conservado en el Parque Francisco Tau?",
                    "opciones": ["Selva de Yungas", "Chaco Húmedo", "Espinal"],
                    "correcta": 0,
                    "explicacion": "El Parque Francisco Tau conserva un relicto del bioma del Espinal, un tipo de bosque nativo de la llanura cordobesa. Se caracteriza por especies resistentes a la sequía como el algarrobo blanco, el tala, el chañar y el espinillo. Este ecosistema, hoy muy reducido por la expansión agrícola, es único en un centro urbano en Córdoba. Su preservación es fundamental para conservar la biodiversidad autóctona, estudiar el ambiente original de la región y mantener un pulmón verde para la ciudad.",
                    "fotoUrl": "espinal.jpg"
                },
                {
                    "coords": [-32.62550, -62.70573],
                    "texto": "Según relevamientos recientes, ¿cuántas especies avifaunísticas habitan actualmente el Parque Francisco Tau?",
                    "opciones": ["125", "135", "115"],
                    "correcta": 0,
                    "explicacion": "El Parque Francisco Tau alberga una gran diversidad de aves, con al menos 125 especies registradas, lo que lo convierte en un sitio ideal para la observación de aves. Se encuentran especies comunes y vistosas como el hornero, el benteveo, el cardenal común y el chingolo, así como aves acuáticas como el biguá, la gallareta y el martín pescador chico. También se observan aves rapaces como el carancho y la lechucita de las vizcacheras.\n\t\t\t\t\tLa variedad de hábitats del parque (bosque, ribera, pastizal) favorece esta riqueza avifaunística, que es clave para el equilibrio ecológico y un gran recurso para la educación ambiental.",
                    "fotoUrl": "ave.jpg"
                },
                {
                    "coords": [-32.62451, -62.70495],
                    "texto": "¿Cuál es el mamífero nativo de hábitos ribereños, identificado como Myocastor coypus, registrado en el Parque Francisco Tau?",
                    "opciones": ["Comadreja overa", "Cuis", "Coipo"],
                    "correcta": 2,
                    "explicacion": "El coipo (Myocastor coypus) es un roedor semiacuático nativo, clave en los ecosistemas ribereños del parque, contribuyendo al control de la vegetación acuática.",
                    "fotoUrl": "coipo.jpg"
                }
            ]
        };

        // Variables de estado de la aplicación
        let edadSeleccionada = null;
        let progreso = {
            actual: 0,
            preguntasCorrectas: 0, // Cuenta las preguntas correctas (aunque ya no es la métrica principal de puntaje)
            puntajeTotal: 0, // NUEVO: Total de puntos acumulados
            intentos: {} // Guarda el número de intentos por pregunta
        };
        let mapa;
        let marcadorUbicacion;
        let ubicacionWatchId = null;
        const ACTIVATION_RADIUS = 10; // Radio en metros para activar una pregunta
        let preguntaMarkers = []; // Almacena los marcadores de preguntas en el mapa
        let currentQuestionRadiusCircle = null; // Círculo que muestra el radio de activación de la pregunta actual
        let sonidoActivado = true;
        let botonEdadSeleccionado = null; // Referencia al botón de edad actualmente seleccionado
        let bienvenidaLeida = false; // Bandera para controlar si la bienvenida de voz ya se reprodujo

        // Referencias a elementos del DOM
        const ventanaBienvenida = document.getElementById("ventana-bienvenida");
        const ventanaInstrucciones = document.getElementById("ventana-instrucciones");
        const ventanaPregunta = document.getElementById("pregunta");
        const ventanaFelicitacion = document.getElementById("ventana-felicitacion");
        const ventanaFelicitacionFinal = document.getElementById("ventana-felicitacion-final");
        const panelProgreso = document.getElementById("panel-progreso");
        const botonesFijos = document.getElementById("botones-fijos");
        const botonReiniciar = document.getElementById("boton-reiniciar"); // Obtener referencia al botón Reiniciar
        const botonMostrarUbicacion = document.getElementById("boton-mostrar-ubicacion"); // Obtener referencia
        const botonToggleSonido = document.getElementById("boton-toggle-sonido"); // Obtener referencia
        const sonidoCorrecto = document.getElementById("sonido-correcto");
        const sonidoIncorrecto = document.getElementById("sonido-incorrecto");
        const iconSoundOn = document.getElementById("icon-sound-on");
        const iconSoundOff = document.getElementById("icon-sound-off");
        const globalOverlay = document.getElementById("global-overlay");
        const opcionesDiv = document.getElementById("opciones"); // Referencia global para limpiar opciones

        // Audio para la alarma (inicializado de forma perezosa)
        let alarmaAudio;

        // ==================================================================== */
        //                             FUNCIONES DE UTILIDAD                    */
        /* ==================================================================== */

        /**
         * Añade o quita la clase 'no-scroll' al body para controlar el scroll.
         * @param {boolean} disable - Si es true, añade 'no-scroll'; si es false, la quita.
         */
        function toggleBodyScroll(disable) {
            if (disable) {
                document.body.classList.add('no-scroll');
            } else {
                document.body.classList.remove('no-scroll');
            }
        }

        /**
         * Muestra un modal y el overlay, y deshabilita el scroll del body.
         * @param {HTMLElement} modalElement - El elemento modal a mostrar.
         */
        function mostrarModal(modalElement) {
            modalElement.classList.add("mostrar");
            globalOverlay.style.display = "block";
            toggleBodyScroll(true); // Deshabilita el scroll del body
        }

        /**
         * Oculta un modal. El control del globalOverlay y el scroll del body
         * se gestiona centralmente en `resetApplicationState` o cuando no hay
         * otros modales visibles.
         * @param {HTMLElement} modalElement - El elemento modal a ocultar.
         */
        function ocultarModal(modalElement) {
            modalElement.classList.remove("mostrar");
        }

        /**
         * Reproduce un elemento de audio si el sonido está activado.
         * @param {HTMLAudioElement} audio - El elemento de audio a reproducir.
         */
        function reproducirSonido(audio) {
            if (sonidoActivado) {
                audio.currentTime = 0; // Reinicia el audio al principio
                audio.play().catch(e => console.error(`Error al reproducir ${audio.id}:`, e));
                console.log(`Reproduciendo sonido: ${audio.id}`); // Debugging
            } else {
                console.log(`Sonido ${audio.id} no reproducido: Sonido desactivado.`); // Debugging
            }
        }

        /**
         * Reproduce el sonido de alarma. Se inicializa el elemento de audio si aún no lo está.
         */
        function reproducirAlarma() {
            if (!alarmaAudio) {
                alarmaAudio = document.getElementById('alarmaSonido');
            }
            if (sonidoActivado && alarmaAudio && alarmaAudio.readyState >= 2) { // readyState >=2 significa que los datos están disponibles
                alarmaAudio.currentTime = 0;
                alarmaAudio.play().catch(e => console.error("Error al reproducir la alarma:", e));
                console.log("Intentando reproducir alarma.mp3"); // Debugging
            } else {
                console.warn("Alarma no reproducida: sonido deshabilitado o audio no cargado.", { sonidoActivado, readyState: alarmaAudio ? alarmaAudio.readyState : 'N/A' }); // Debugging
            }
        }

        /**
         * Genera un feedback háptico (vibración) si el dispositivo lo soporta.
         * @param {number|number[]} pattern - Patrón de vibración en milisegundos.
         */
        function feedbackHaptico(pattern = 50) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        /**
         * Reproduce un texto usando la API de síntesis de voz del navegador.
         * @param {string} text - El texto a reproducir.
         */
        function reproducirTexto(text) {
            if ('speechSynthesis' in window && sonidoActivado) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES'; // Configura el idioma a español
                utterance.volume = 1;
                utterance.rate = 1;
                utterance.pitch = 1;
                window.speechSynthesis.cancel(); // Cancela cualquier habla en curso
                window.speechSynthesis.speak(utterance);
                console.log(`Reproduciendo texto: "${text.substring(0, Math.min(text.length, 50))}..."`); // Debugging
            } else if (!('speechSynthesis' in window)) {
                console.warn("La API de síntesis de voz no está soportada en este navegador.");
            } else if (!sonidoActivado) {
                console.log("Texto no reproducido: Sonido desactivado."); // Debugging
            }
        }

        /**
         * Crea y muestra un modal personalizado con título, mensaje y botones.
         * Este modal no afecta el scroll del body, se encarga de sí mismo.
         * @param {string} titulo - Título del modal.
         * @param {string} mensaje - Contenido HTML del mensaje.
         * @param {Array<Object>} botonesConfig - Array de objetos {texto: string, clase: string, callback: function}.
         */
        function crearModalPersonalizado(titulo, mensaje, botonesConfig) {
            // Elimina cualquier modal personalizado existente para evitar duplicados
            const modalExistente = document.querySelector('.custom-js-modal');
            if (modalExistente) {
                document.body.removeChild(modalExistente);
            }

            const modal = document.createElement('div');
            modal.className = 'custom-js-modal';
            modal.setAttribute('role', 'alertdialog');
            modal.setAttribute('aria-modal', 'true');

            const modalTitulo = document.createElement('h3');
            modalTitulo.textContent = titulo;
            modal.appendChild(modalTitulo);
            // Asegura un ID único para el aria-labelledby
            const tituloId = 'custom-modal-titulo-' + Date.now();
            modalTitulo.id = tituloId;
            modal.setAttribute('aria-labelledby', tituloId);

            const modalMensaje = document.createElement('p');
            modalMensaje.innerHTML = mensaje;
            modal.appendChild(modalMensaje);

            const botonesDiv = document.createElement('div');
            botonesDiv.className = 'modal-botones';

            botonesConfig.forEach(btnConfig => {
                const button = document.createElement("button");
                button.textContent = btnConfig.texto;
                if (btnConfig.clase) {
                    button.classList.add(...btnConfig.clase.split(' '));
                }
                button.addEventListener('click', () => {
                    if (btnConfig.callback) {
                        btnConfig.callback();
                    }
                    document.body.removeChild(modal); // Cierra el modal al hacer click
                });
                botonesDiv.appendChild(button);
            });

            modal.appendChild(botonesDiv);
            document.body.appendChild(modal);
            // Enfoca el primer botón para accesibilidad
            if (botonesDiv.firstChild && typeof botonesDiv.firstChild.focus === 'function') {
                botonesDiv.firstChild.focus();
            }
        }

        /**
         * Obtiene el array de preguntas para la edad seleccionada.
         * @returns {Array} Array de objetos de preguntas.
         */
        function obtenerPreguntas() {
            return preguntasData[edadSeleccionada] || [];
        }

        // ==================================================================== */
        //                       FUNCIONES DE LÓGICA DE LA TRIVIA               */
        /* ==================================================================== */

        /**
         * Maneja la selección de un rango de edad.
         * @param {string} rango - El rango de edad seleccionado ('menor6', '6a12', 'mayor12').
         * @param {HTMLElement} botonElement - El botón HTML que fue clickeado.
         */
        function seleccionarEdad(rango, botonElement) {
            // Quita la clase 'seleccionado' del botón previamente activo
            if (botonEdadSeleccionado) {
                botonEdadSeleccionado.classList.remove('seleccionado');
            }

            // Añade la clase 'seleccionado' al botón clickeado y guarda su referencia
            botonElement.classList.add('seleccionado');
            botonEdadSeleccionado = botonElement;

            edadSeleccionada = rango;

            // Inicia la aplicación una vez que se ha seleccionado la edad
            iniciarAplicacionPorEdad();
        }

        /**
         * Inicia el flujo principal de la aplicación después de la selección de edad.
         * Oculta la ventana de bienvenida, reproduce alarma y texto de instrucciones.
         */
        function iniciarAplicacionPorEdad() {
            console.log("iniciarAplicacionPorEdad: Edad seleccionada:", edadSeleccionada);
            if (edadSeleccionada) {
                ocultarModal(ventanaBienvenida); // Usa la nueva función para ocultar y manejar scroll
                reproducirAlarma(); // Reproduce la alarma al iniciar la aplicación

                iniciarMapa(); // Inicializa el mapa

                mostrarModal(ventanaInstrucciones); // Usa la nueva función para mostrar y manejar scroll

                // Reproduce el texto de las instrucciones
                const tituloInstrucciones = document.getElementById("titulo-instrucciones").textContent;
                const parrafosInstrucciones = Array.from(document.querySelectorAll("#ventana-instrucciones p")).map(p => p.textContent).join(" ");
                reproducirTexto(tituloInstrucciones + " " + parrafosInstrucciones);

                // Enfoca el botón de comenzar para accesibilidad
                document.getElementById("boton-comenzar-instrucciones").focus();

            } else {
                crearModalPersonalizado(
                    "Error de Ingreso",
                    "Por favor, selecciona un rango de edad para comenzar.",
                    [{ texto: "Entendido", clase: "boton-negacion" }]
                );
            }
        }

        /**
         * Cierra la ventana de instrucciones y comienza el seguimiento de la ubicación.
         */
        function cerrarVentanaInstrucciones() {
            ocultarModal(ventanaInstrucciones); // Usa la nueva función para ocultar y manejar scroll
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // Cancela cualquier habla en curso (ej. si el usuario hace clic rápido)
            }
            // Inicia el seguimiento de la ubicación si aún no está activo
            if (!ubicacionWatchId) {
                iniciarSeguimientoUbicacion();
            }
            // Oculta el overlay global después de cerrar las instrucciones
            // Esto es crucial si la ventana de instrucciones es la última modal abierta
            globalOverlay.style.display = "none";
            toggleBodyScroll(false); // Habilita el scroll del body
        }

        /**
         * Inicializa el mapa Leaflet y añade los marcadores de preguntas.
         */
        function iniciarMapa() {
            console.log("iniciarMapa: Inicializando mapa...");
            const preguntas = obtenerPreguntas();
            if (preguntas.length === 0) {
                crearModalPersonalizado("Error", "No hay preguntas para el rango de edad seleccionado.", [{
                    texto: "Cerrar"
                }]);
                return;
            }

            // Si ya existe una instancia de mapa, destrúyela antes de crear una nueva
            if (mapa) {
                mapa.remove();
                console.log("Mapa existente removido.");
            }

            // Inicializa el mapa centrado en la primera pregunta
            mapa = L.map('map').setView(preguntas[0].coords, 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(mapa);
            console.log("Nuevo mapa inicializado y centrado.");

            // Elimina marcadores anteriores y limpia el array
            preguntaMarkers.forEach(marker => marker.remove());
            preguntaMarkers = []; // Reinicia el array
            console.log("Marcadores de preguntas anteriores eliminados.");

            // Crea un marcador para cada pregunta y lo guarda en el array
            preguntas.forEach((p, index) => {
                const marker = L.marker(p.coords, {
                    opacity: 0.5, // Marcadores iniciales semitransparentes
                    interactive: false // No interactivos hasta que se activen
                });
                p.marker = marker; // Asocia el marcador al objeto de pregunta
                preguntaMarkers.push(marker);
            });
            console.log("Nuevos marcadores de preguntas creados.");

            actualizarPanelProgreso(); // Actualiza el progreso inicial
            botonesFijos.style.display = "flex"; // Muestra los botones fijos
            panelProgreso.style.display = "block"; // Muestra el panel de progreso
            console.log("Panel de progreso y botones fijos mostrados.");
        }

        /**
         * Actualiza la visibilidad del marcador de la pregunta actual y su círculo de radio.
         */
        function actualizarVisibilidadMarcadorActual() {
            console.log("actualizarVisibilidadMarcadorActual: Actualizando visibilidad del marcador...");
            if (progreso.actual < obtenerPreguntas().length) {
                const preguntaActual = obtenerPreguntas()[progreso.actual];
                // Si el marcador de la pregunta actual no está en el mapa, lo añade y le da opacidad total
                if (preguntaActual.marker && mapa && !mapa.hasLayer(preguntaActual.marker)) {
                    preguntaActual.marker.setOpacity(1).addTo(mapa);
                }
                // Remueve el círculo de radio anterior si existe
                if (currentQuestionRadiusCircle && mapa && mapa.hasLayer(currentQuestionRadiusCircle)) {
                    mapa.removeLayer(currentQuestionRadiusCircle);
                }
                // Dibuja un nuevo círculo de radio alrededor de la pregunta actual
                currentQuestionRadiusCircle = L.circle(L.latLng(preguntaActual.coords), {
                    color: 'blue',
                    fillColor: '#0000ff',
                    fillOpacity: 0.2,
                    radius: ACTIVATION_RADIUS
                }).addTo(mapa);
                console.log("Nuevo círculo de radio dibujado.");
            } else if (currentQuestionRadiusCircle && mapa) { // Asegúrate de que el mapa exista antes de intentar remover la capa
                // Si no hay más preguntas, remueve el círculo
                mapa.removeLayer(currentQuestionRadiusCircle);
                currentQuestionRadiusCircle = null;
                console.log("Todas las preguntas completadas, círculo de radio removido.");
            }
        }

        /**
         * Muestra la ventana de felicitación después de una respuesta correcta.
         * @param {Object} pregunta - Objeto de la pregunta respondida correctamente.
         */
        function mostrarFelicitacionCorrecta(pregunta) {
            console.log("Entrando a mostrarFelicitacionCorrecta para la pregunta:", pregunta);

            // Calcular puntos ganados
            const preguntaId = `pregunta_${progreso.actual}`; // ID para acceder a los intentos de esta pregunta
            const incorrectAttempts = progreso.intentos[preguntaId] || 0; // Número de intentos incorrectos antes de esta respuesta

            let pointsEarned = 0;
            if (incorrectAttempts === 0) {
                pointsEarned = 3; // Correcto en el primer intento
            } else if (incorrectAttempts === 1) {
                pointsEarned = 2; // Correcto en el segundo intento
            } else { // incorrectAttempts >= 2
                pointsEarned = 1; // Correcto en el tercer intento o posterior
            }
            progreso.puntajeTotal += pointsEarned; // Sumar puntos al total
            console.log(`Pregunta ${preguntaId} respondida correctamente. Intentos incorrectos antes: ${incorrectAttempts}. Puntos ganados: ${pointsEarned}. Puntaje total actual: ${progreso.puntajeTotal}`);
            // Fin del cálculo de puntos

            // 1. Ocultar la ventana de pregunta inmediatamente
            ocultarModal(ventanaPregunta);
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // Cancela cualquier habla en curso (la de la pregunta)
            }

            const felicitacionImagen = document.getElementById("felicitacion-imagen");
            // Añade un manejador de error para la imagen y un fallback
            felicitacionImagen.onerror = () => {
                console.error("Error al cargar la imagen:", pregunta.fotoUrl);
                felicitacionImagen.src = "https://placehold.co/150x100/CCCCCC/000000?text=Imagen+no+cargada"; // Imagen de fallback
            };
            felicitacionImagen.src = pregunta.fotoUrl || "https://placehold.co/150x100/CCCCCC/000000?text=Imagen+no+disponible"; // Fallback si fotoUrl falta
            felicitacionImagen.alt = `Imagen relacionada con la pregunta: ${pregunta.texto || 'sin texto'}`; // Texto alternativo fallback

            document.getElementById("felicitacion-explicacion").textContent = pregunta.explicacion || 'No hay explicación disponible.'; // Texto de explicación fallback

            mostrarModal(ventanaFelicitacion); // Usa la nueva función para mostrar y manejar scroll

            reproducirSonido(sonidoCorrecto); // Sonido de respuesta correcta
            feedbackHaptico(100); // Vibración
            reproducirTexto(pregunta.explicacion || 'Respuesta correcta.'); // Lee la explicación, con fallback

            // Asegura que el botón sea visible y enfocable
            const botonContinuar = document.getElementById("boton-continuar-felicitacion");
            botonContinuar.style.display = 'inline-block'; // Asegura que no esté oculto por alguna regla anterior
            botonContinuar.focus(); // Enfoca el botón de continuar
            console.log("Intento de enfocar el botón:", botonContinuar);

            // Maneja el listener del botón "Continuar" para evitar múltiples bindings
            const oldListener = botonContinuar._currentListener;
            if (oldListener) {
                botonContinuar.removeEventListener('click', oldListener);
                console.log("Eliminado listener anterior del botón Continuar.");
            }

            const newListener = () => {
                console.log("Botón Continuar clickeado.");
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel(); // Cancela el habla si sigue reproduciendo
                }
                // Al ocultar la ventana de felicitación, también ocultar el globalOverlay y habilitar el scroll
                ocultarModal(ventanaFelicitacion);
                globalOverlay.style.display = "none";
                toggleBodyScroll(false);

                if (pregunta.marker && mapa && mapa.hasLayer(pregunta.marker)) { // Verifica si el marcador existe antes de acceder a sus propiedades
                    pregunta.marker.setOpacity(0.4); // Baja la opacidad del marcador de la pregunta respondida
                    pregunta.marker.options.interactive = false;
                }

                if (currentQuestionRadiusCircle && mapa) { // Asegúrate de que el mapa exista antes de intentar remover la capa
                    mapa.removeLayer(currentQuestionRadiusCircle); // Remueve el círculo de radio
                    currentQuestionRadiusCircle = null;
                }

                progreso.actual++; // Avanza a la siguiente pregunta
                actualizarPanelProgreso();
                actualizarVisibilidadMarcadorActual();

                if (progreso.actual >= obtenerPreguntas().length) {
                    console.log("Todas las preguntas respondidas, mostrando felicitación final.");
                    mostrarFelicitacionFinal(); // Si no hay más preguntas, muestra la nueva ventana final de felicitación
                }
                // Ya no necesitamos ocultar ventanaPregunta aquí, se hizo al inicio de mostrarFelicitacionCorrecta
            };
            botonContinuar.addEventListener('click', newListener);
            botonContinuar._currentListener = newListener; // Guarda la referencia al listener actual
            console.log("Nuevo listener adjuntado al botón Continuar.");
        }

        /**
         * Muestra una pregunta específica en el modal de pregunta.
         * @param {number} index - Índice de la pregunta a mostrar.
         */
        function mostrarPregunta(index) {
            console.log("mostrarPregunta: Mostrando pregunta índice:", index);
            // Evita mostrar la misma pregunta si ya está activa o si no es la pregunta actual
            if (index !== progreso.actual || ventanaPregunta.classList.contains('mostrar')) {
                return;
            }

            const p = obtenerPreguntas()[index];
            const preguntaId = `pregunta_${index}`;
            // Inicializa intentos si es la primera vez que se muestra esta pregunta.
            // Los intentos se incrementan SOLO cuando la respuesta es INCORRECTA.
            if (progreso.intentos[preguntaId] === undefined) {
                progreso.intentos[preguntaId] = 0;
            }

            document.getElementById("texto-pregunta").textContent = p.texto;
            // Nuevo: Reproduce el texto de la pregunta
            reproducirTexto(p.texto);

            opcionesDiv.innerHTML = ""; // Limpia opciones anteriores

            const fragment = document.createDocumentFragment(); // Usa un fragmento para mejor rendimiento

            // Crea los botones de opción para la pregunta
            p.opciones.forEach((opcion, i) => {
                const btn = document.createElement("button");
                btn.textContent = opcion;
                btn.addEventListener('click', () => {
                    if (i === p.correcta) {
                        // Respuesta correcta
                        reproducirSonido(sonidoCorrecto);
                        feedbackHaptico(100);
                        progreso.preguntasCorrectas++; // Incrementa contador de preguntas correctas

                        mostrarFelicitacionCorrecta(p); // Muestra felicitación y avanza
                    } else {
                        // Respuesta incorrecta
                        reproducirSonido(sonidoIncorrecto);
                        feedbackHaptico([200, 100, 200]);
                        progreso.intentos[preguntaId]++; // Incrementa intentos para esta pregunta
                        crearModalPersonalizado(
                            "Respuesta Incorrecta",
                            "¡Ups! Esa no es la respuesta. Intentá de nuevo.",
                            [{ texto: "Entendido", clase: "boton-negacion" }]
                        );
                    }
                });
                fragment.appendChild(btn);
            });
            opcionesDiv.appendChild(fragment);
            mostrarModal(ventanaPregunta); // Usa la nueva función para mostrar y manejar scroll
            if (opcionesDiv.firstChild && typeof opcionesDiv.firstChild.focus === 'function') {
                opcionesDiv.firstChild.focus(); // Enfoca la primera opción para accesibilidad
            }
        }

        /**
         * Inicia el seguimiento continuo de la ubicación del usuario y verifica la proximidad a las preguntas.
         */
        function iniciarSeguimientoUbicacion() {
            console.log("iniciarSeguimientoUbicacion: Iniciando seguimiento de ubicación...");
            if (!navigator.geolocation) {
                crearModalPersonalizado("Error de Geolocalización", "La geolocalización no está soportada por tu navegador.", [{
                    texto: "Cerrar"
                }]);
                return;
            }

            // Si ya hay un seguimiento, simplemente centra el mapa si hay un marcador
            if (ubicacionWatchId !== null) {
                if (marcadorUbicacion && mapa) mapa.setView(marcadorUbicacion.getLatLng(), 17); // Añadir verificación de mapa
                console.log("Seguimiento de ubicación ya activo, centrando mapa.");
                return;
            }

            ubicacionWatchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const userLocation = L.latLng(pos.coords.latitude, pos.coords.longitude);
                    // Actualiza o crea el marcador de la ubicación del usuario
                    if (marcadorUbicacion) {
                        marcadorUbicacion.setLatLng(userLocation);
                    } else {
                        marcadorUbicacion = L.marker(userLocation, {
                            icon: L.divIcon({
                                className: 'leaflet-div-icon',
                                html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#E53935"><path d="M12 2c-4.418 0-8 3.582-8 8 0 7 8 12 8 12s8-5 8-12c0-3.87-3.13-7-7-7zm0 11c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3z"/></svg>',
                                iconSize: [30, 30],
                                iconAnchor: [15, 30]
                            })
                        }).addTo(mapa).bindPopup("¡Estás aquí!");
                        mapa.setView(userLocation, 17); // Centra el mapa en la ubicación inicial
                    }
                    console.log("Ubicación actualizada:", userLocation);

                    // Verifica la proximidad a la pregunta actual
                    if (progreso.actual < obtenerPreguntas().length) {
                        const preguntaActual = obtenerPreguntas()[progreso.actual];
                        const preguntaLocation = L.latLng(preguntaActual.coords);
                        const distance = userLocation.distanceTo(preguntaLocation);
                        console.log(`Distancia a la pregunta actual (${progreso.actual}): ${distance.toFixed(2)}m`);

                        // Asegura que el marcador de la pregunta actual esté visible
                        if (preguntaActual.marker && mapa && !mapa.hasLayer(preguntaActual.marker)) {
                            preguntaActual.marker.setOpacity(1).addTo(mapa);
                        }
                        actualizarVisibilidadMarcadorActual();

                        // La pregunta se considera "activa" si su ventana está visible
                        const preguntaYaActiva = ventanaPregunta.classList.contains('mostrar');
                        const felicitacionActiva = ventanaFelicitacion.classList.contains('mostrar');
                        const felicitacionFinalActiva = ventanaFelicitacionFinal.classList.contains('mostrar');

                        // Si el usuario está dentro del radio de activación y la pregunta no está activa ni la ventana de felicitación, muestra la pregunta
                        if (distance <= ACTIVATION_RADIUS && !preguntaYaActiva && !felicitacionActiva && !felicitacionFinalActiva) {
                            console.log(`Dentro del radio de activación para la pregunta ${progreso.actual}. Mostrando pregunta.`);
                            reproducirAlarma(); // Alarma al activar la pregunta
                            // Deshabilita la interactividad del marcador de pregunta para evitar múltiples activaciones
                            if (preguntaActual.marker.options.interactive) {
                                preguntaActual.marker.closeTooltip();
                                preguntaActual.marker.options.interactive = false;
                            }
                            if (mapa) mapa.setView(preguntaLocation, 17); // Añadir verificación de mapa
                            mostrarPregunta(progreso.actual); // Muestra el modal de la pregunta
                        } else if (distance > ACTIVATION_RADIUS) {
                            // Si el usuario se aleja, asegura que el marcador no sea interactivo
                            if (preguntaActual.marker.options.interactive) {
                                preguntaActual.marker.options.interactive = false;
                                preguntaActual.marker.closeTooltip();
                            }
                            // Ocultar la ventana de pregunta si el usuario se aleja y está visible
                            if (preguntaYaActiva) {
                                console.log("Usuario se alejó, ocultando ventana de pregunta.");
                                ocultarModal(ventanaPregunta);
                                globalOverlay.style.display = "none";
                                toggleBodyScroll(false);
                                if ('speechSynthesis' in window) {
                                    window.speechSynthesis.cancel();
                                }
                            }
                        }
                    }
                },
                (err) => {
                    console.error(`ERROR(${err.code}): ${err.message}`);
                    crearModalPersonalizado(
                        "Error de Geolocalización",
                        `No se pudo obtener tu ubicación: ${err.message}. Verifica los permisos.`,
                        [{ texto: "Cerrar" }]
                    );
                    // Detiene el seguimiento si hay un error persistente
                    if (ubicacionWatchId !== null) {
                        navigator.geolocation.clearWatch(ubicacionWatchId);
                        ubicacionWatchId = null;
                        console.log("Seguimiento de ubicación detenido debido a error.");
                    }
                }, {
                    enableHighAccuracy: true, // Solicita la máxima precisión
                    timeout: 10000,          // Tiempo máximo para obtener la ubicación (10 segundos)
                    maximumAge: 0            // No usa caché, siempre intenta obtener una ubicación nueva
                }
            );
            actualizarVisibilidadMarcadorActual(); // Asegura la visibilidad del marcador al inicio del seguimiento
        }

        /**
         * Actualiza el panel de progreso en la interfaz.
         */
        function actualizarPanelProgreso() {
            const totalPreguntas = obtenerPreguntas().length;
            const porcentajeRespondidas = totalPreguntas > 0 ? Math.round((progreso.actual / totalPreguntas) * 100) : 0;
            document.getElementById("progreso-porcentaje").style.width = porcentajeRespondidas + "%";
            document.getElementById("progreso-texto").textContent =
                `${progreso.actual} / ${totalPreguntas} preguntas respondidas - Correctas: ${progreso.preguntasCorrectas}`;
            console.log(`Progreso actualizado: ${progreso.actual}/${totalPreguntas} (${porcentajeRespondidas}%) - Correctas: ${progreso.preguntasCorrectas}`);
        }

        /**
         * Reinicia la trivia, restableciendo todas las variables de estado y la interfaz de usuario.
         * Pide confirmación al usuario antes de reiniciar.
         */
        function reiniciarTrivia() {
            console.log("reiniciarTrivia: Solicitando confirmación de reinicio.");
            crearModalPersonalizado(
                "Reiniciar Trivia",
                "¿Estás seguro que querés reiniciar tu progreso? Se perderá todo.",
                [
                    { texto: "Sí, reiniciar", clase: "boton-negacion", callback: resetApplicationState },
                    { texto: "No, continuar", clase: "boton-confirmacion" }
                ]
            );
        }

        /**
         * Restablece completamente el estado de la aplicación a su inicio.
         */
        function resetApplicationState() {
            console.log("resetApplicationState: Reiniciando estado de la aplicación...");

            // 1. Resetear variables de estado
            edadSeleccionada = null;
            progreso = {
                actual: 0,
                preguntasCorrectas: 0,
                puntajeTotal: 0, // Reiniciar el puntaje total
                intentos: {}
            };
            bienvenidaLeida = false; // Permite que el texto de bienvenida se reproduzca de nuevo

            // 2. Detener seguimiento de ubicación si está activo
            if (ubicacionWatchId !== null) {
                navigator.geolocation.clearWatch(ubicacionWatchId);
                ubicacionWatchId = null;
                console.log("Seguimiento de ubicación detenido.");
            }

            // 3. Eliminar marcadores de preguntas y círculo de radio del mapa *antes* de remover el mapa.
            // Es crucial verificar si el mapa existe y si la capa está en él antes de intentar removerla.
            preguntaMarkers.forEach(marker => {
                if (mapa && mapa.hasLayer(marker)) {
                    mapa.removeLayer(marker);
                }
            });
            preguntaMarkers = []; // Vacía el array para futuras inicializaciones
            console.log("Marcadores de preguntas removidos del mapa y array vaciado.");

            if (currentQuestionRadiusCircle && mapa && mapa.hasLayer(currentQuestionRadiusCircle)) {
                mapa.removeLayer(currentQuestionRadiusCircle);
                currentQuestionRadiusCircle = null;
                console.log("Círculo de radio de pregunta removido del mapa.");
            } else {
                currentQuestionRadiusCircle = null; // Asegurarse de que la referencia se limpie incluso si no está en el mapa
            }

            // 4. Eliminar mapa existente si hay
            if (mapa) {
                mapa.remove();
                mapa = null;
                console.log("Mapa removido y restablecido.");
            }
            marcadorUbicacion = null; // Reiniciar marcador de ubicación

            // 5. Ocultar todos los modales activos
            // Llamar a ocultarModal para cada uno solo remueve la clase 'mostrar'.
            ocultarModal(ventanaBienvenida);
            ocultarModal(ventanaInstrucciones);
            ocultarModal(ventanaPregunta);
            opcionesDiv.innerHTML = ""; // Limpiar explícitamente las opciones de la pregunta
            ocultarModal(ventanaFelicitacion);
            ocultarModal(ventanaFelicitacionFinal);

            // El globalOverlay y el scroll del body se gestionan aquí de forma centralizada
            globalOverlay.style.display = "none";
            toggleBodyScroll(false);
            console.log("Todos los modales y overlay ocultos.");

            // 6. Ocultar paneles y botones fijos
            panelProgreso.style.display = "none";
            botonesFijos.style.display = "flex"; // Se asegura que el contenedor de botones fijos esté visible para reiniciar.
            console.log("Panel de progreso oculto y botones fijos restablecidos.");

            // 7. Reiniciar estado de sonido y sus iconos
            sonidoActivado = true;
            iconSoundOn.style.display = 'inline-block';
            iconSoundOff.style.display = 'none';
            console.log("Estado de sonido restablecido.");

            // 8. Resetear botón de edad seleccionado
            if (botonEdadSeleccionado) {
                botonEdadSeleccionado.classList.remove('seleccionado');
                botonEdadSeleccionado = null;
                console.log("Botón de edad seleccionado restablecido.");
            }

            // 9. Quitar el resaltado del botón de reiniciar y habilitar todos los botones fijos
            if (botonReiniciar) {
                botonReiniciar.classList.remove('highlight-restart-button');
                botonReiniciar.disabled = false; // Asegurar que no esté deshabilitado
                botonReiniciar.style.opacity = '1'; // Restaurar opacidad
            }
            if (botonMostrarUbicacion) { // Asegúrate de que el elemento exista
                botonMostrarUbicacion.disabled = false;
                botonMostrarUbicacion.style.opacity = '1'; // Restaurar opacidad
            }
            if (botonToggleSonido) { // Asegúrate de que el elemento exista
                botonToggleSonido.disabled = false;
                botonToggleSonido.style.opacity = '1'; // Restaurar opacidad
            }
            console.log("Resaltado del botón de reiniciar removido y todos los botones fijos habilitados.");

            // 10. Cancelar cualquier reproducción de voz actual
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                console.log("Síntesis de voz cancelada.");
            }

            // 11. Volver a mostrar la ventana de bienvenida para iniciar el flujo
            mostrarModal(ventanaBienvenida);
            // Reproducir el texto de bienvenida nuevamente
            const tituloBienvenida = document.getElementById("titulo-bienvenida").textContent;
            const parrafoBienvenida = document.querySelector("#ventana-bienvenida p").textContent;
            reproducirTexto(tituloBienvenida + " " + parrafoBienvenida);
            console.log("Ventana de bienvenida mostrada. Aplicación reiniciada completamente.");
        }


        /**
         * Muestra la nueva ventana de felicitaciones final al completar la trivia,
         * con un mensaje personalizado basado en el porcentaje de respuestas correctas.
         */
        function mostrarFelicitacionFinal() {
            console.log("mostrarFelicitacionFinal: Mostrando ventana de felicitación final.");
            const totalPreguntas = obtenerPreguntas().length;
            const maxPuntajePosible = totalPreguntas * 3; // 3 puntos por pregunta si todas son correctas al primer intento
            const porcentajeCorrectas = totalPreguntas > 0 ? (progreso.preguntasCorrectas / totalPreguntas) * 100 : 0;
            let mensajeParaNino = "";

            if (porcentajeCorrectas < 25) {
                mensajeParaNino = "¡Uhm... parece que aún hay mucho por aprender! No te preocupes, ¡sigue explorando el parque y lo lograrás!";
            } else if (porcentajeCorrectas >= 25 && porcentajeCorrectas <= 50) {
                mensajeParaNino = "¡Lo estás haciendo muy bien! Con un poco más de práctica, ¡serás un experto del parque!";
            } else if (porcentajeCorrectas > 50 && porcentajeCorrectas <= 75) {
                mensajeParaNino = "¡Fantástico! ¡Conoces muy bien el parque! Eres un verdadero guardián de la naturaleza.";
            } else { // Mayor a 75%
                mensajeParaNino = "¡Eres un super experto del Parque Francisco Tau! ¡Felicitaciones por tu gran conocimiento!";
            }

            document.getElementById("mensaje-felicitacion-final").textContent = mensajeParaNino;
            // Actualización para mostrar el puntaje total sobre el máximo posible
            document.getElementById("puntaje-final").textContent = `${progreso.puntajeTotal} de ${maxPuntajePosible} puntos.`;

            mostrarModal(ventanaFelicitacionFinal); // Usa la nueva función para mostrar y manejar scroll

            reproducirTexto(`¡Felicidades! ${mensajeParaNino} Tu puntaje final es ${progreso.puntajeTotal} de ${maxPuntajePosible} puntos.`);
            // Ya no enfocamos el botón dentro del modal, porque fue eliminado.
            // En su lugar, resaltamos el botón de reiniciar de la interfaz principal.
            if (botonReiniciar) { // Asegúrate de que el elemento exista antes de intentar modificarlo
                botonReiniciar.classList.add('highlight-restart-button');
                botonReiniciar.disabled = false; // Asegurarse que el botón esté habilitado para ser clickeable
                botonReiniciar.focus(); // Enfoca el botón de reiniciar para accesibilidad
                console.log("Botón de reiniciar resaltado y enfocado.");
            }

            // Deshabilitar y atenuar los otros botones fijos
            if (botonMostrarUbicacion) {
                botonMostrarUbicacion.disabled = true;
                botonMostrarUbicacion.style.opacity = '0.3'; // Atenuar visualmente
            }
            if (botonToggleSonido) {
                botonToggleSonido.disabled = true;
                botonToggleSonido.style.opacity = '0.3'; // Atenuar visualmente
            }
            console.log("Botones de ubicación y sonido deshabilitados y atenuados.");


            // Detiene el seguimiento de ubicación y limpia el círculo de radio al finalizar
            if (ubicacionWatchId !== null) {
                navigator.geolocation.clearWatch(ubicacionWatchId);
                ubicacionWatchId = null;
                console.log("Seguimiento de ubicación detenido al finalizar la trivia.");
            }
            if (currentQuestionRadiusCircle && mapa) { // Asegúrate de que el mapa exista antes de intentar remover la capa
                mapa.removeLayer(currentQuestionRadiusCircle);
                currentQuestionRadiusCircle = null;
                console.log("Círculo de radio de pregunta removido al finalizar la trivia.");
            }
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // Cancela cualquier habla en curso
            }
        }

        /**
         * Muestra la ubicación actual del usuario en el mapa o informa sobre el estado del GPS.
         */
        function accionMostrarUbicacion() {
            console.log("accionMostrarUbicacion: Intentando mostrar ubicación.");
            // Solo ejecuta si el botón no está deshabilitado
            if (this.disabled) {
                console.log("Botón de ubicación deshabilitado.");
                return;
            }

            if (marcadorUbicacion && mapa && mapa.hasLayer(marcadorUbicacion)) { // Añadir verificación de mapa
                mapa.setView(marcadorUbicacion.getLatLng(), 17); // Centra el mapa en la ubicación del usuario
                marcadorUbicacion.openPopup(); // Abre el popup del marcador
                console.log("Ubicación del usuario mostrada en el mapa.");
            } else if (!ubicacionWatchId) {
                // Si el seguimiento no está activo, intenta iniciarlo
                iniciarSeguimientoUbicacion();
                crearModalPersonalizado("Ubicación", "Iniciando seguimiento de ubicación para mostrarte en el mapa.", [{ texto: "OK" }]);
                console.log("Solicitando iniciar seguimiento de ubicación.");
            } else {
                // Si el seguimiento ya está activo pero no hay marcador, es que aún no se ha obtenido la posición
                crearModalPersonalizado("Ubicación", "Esperando señal de GPS para mostrar tu ubicación...", [{ texto: "OK" }]);
                console.log("Seguimiento de ubicación activo, esperando señal de GPS.");
            }
        }

        /**
         * Alterna el estado del sonido (activado/desactivado) y actualiza el icono.
         */
        function toggleSonido() {
            // Solo ejecuta si el botón no está deshabilitado
            if (this.disabled) {
                console.log("Botón de sonido deshabilitado.");
                return;
            }

            sonidoActivado = !sonidoActivado;
            if (sonidoActivado) {
                iconSoundOn.style.display = 'inline-block';
                iconSoundOff.style.display = 'none';
                console.log("Sonido activado.");
            } else {
                iconSoundOn.style.display = 'none';
                iconSoundOff.style.display = 'inline-block';
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel(); // Cancela cualquier habla si se desactiva el sonido
                }
                console.log("Sonido desactivado.");
            }
            crearModalPersonalizado("Sonido", `Sonido ${sonidoActivado ? 'activado' : 'desactivado'}.`, [{ texto: "OK" }]);
        }

        // ==================================================================== */
        //                             INICIALIZACIÓN                           */
        /* ==================================================================== */

        // Evento que se dispara cuando el DOM está completamente cargado
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOMContentLoaded: DOM completamente cargado.");
            // Inicializa el chatbot de n8n
            createChat({
                webhookUrl: 'https://n8n.efficienza.es/webhook/8173e5e9-1b3c-445f-9beb-d0f5360d7ba4/chat',
                webhookConfig: {
                    method: 'POST',
                    headers: {}
                },
                target: '#n8n-chat',
                mode: 'window',
                chatInputKey: 'chatInput',
                chatSessionKey: 'sessionId',
                metadata: {},
                showWelcomeScreen: false,
                defaultLanguage: 'es',
                initialMessages: [
                    '¡Hola! Soy tu Guarda parque Virtual. Escribe tu mensaje en la barra de abajo.'
                ],
                i18n: {
                    es: {
                        title: 'Guarda parque Virtual',
                        subtitle: "Inicia una conversación. Estamos aquí para ayudarte.",
                        footer: '',
                        inputPlaceholder: 'Escribe tu mensaje..',
                    },
                },
            });
            console.log("Chatbot n8n inicializado.");

            // Asigna listeners a los botones de selección de edad
            document.querySelectorAll('#botones-edad button').forEach(button => {
                button.addEventListener('click', function () {
                    seleccionarEdad(this.dataset.edad, this);
                });
            });
            console.log("Listeners de botones de edad asignados.");

            // Asigna listeners a los botones de control de la trivia
            document.getElementById('boton-comenzar-instrucciones').addEventListener('click', cerrarVentanaInstrucciones);
            document.getElementById('boton-reiniciar').addEventListener('click', reiniciarTrivia);
            // Referencias a los botones para agregar el listener
            document.getElementById('boton-mostrar-ubicacion').addEventListener('click', accionMostrarUbicacion);
            document.getElementById('boton-toggle-sonido').addEventListener('click', toggleSonido);
            console.log("Listeners de botones de control de trivia asignados.");

            // Muestra la ventana de bienvenida al cargar la página
            if (ventanaBienvenida) {
                mostrarModal(ventanaBienvenida); // Usa la nueva función para mostrar y manejar scroll
                console.log("Ventana de bienvenida mostrada al cargar la página.");

                // Reproduce el texto de bienvenida si aún no se ha leído (considerando políticas de autoplay)
                if (!bienvenidaLeida) {
                    const tituloBienvenida = document.getElementById("titulo-bienvenida").textContent;
                    const parrafoBienvenida = document.querySelector("#ventana-bienvenida p").textContent;
                    reproducirTexto(tituloBienvenida + " " + parrafoBienvenida);
                    bienvenidaLeida = true;
                    console.log("Texto de bienvenida reproducido.");
                }
            } else {
                console.error('Error: Element with ID "ventana-bienvenida" not found.');
            }
        });
    </script>

</body>

</html>




























