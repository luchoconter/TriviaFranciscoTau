<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Trivia Francisco Tau</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="manifest" href="manifest.json"> <!-- AÑADIDO: Enlace al manifest.json -->
    
    <!-- NUEVO: CSS para el chatbot de n8n -->
    <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />

    <style>
        /* Global CSS Variables */
        :root {
            --color-primario-verde: #4CAF50;
            --color-primario-verde-claro: #66bb6a;
            --color-primario-verde-oscuro: #388E3C;
            --color-secundario-azul: #2196f3;
            --color-secundario-azul-claro: #42a5f5;
            --color-secundario-azul-oscuro: #1976D2;
            --color-error-rojo: #e53935;
            --color-error-rojo-claro: #ef5350;
            --color-texto-oscuro: #333;
            --color-texto-blanco: #fff;
            --color-fondo-overlay: rgba(255, 255, 255, 0.85);
            /* Slightly increased opacity for better contrast */

            --radio-borde-general: 8px;
            --radio-borde-modal: 12px;
            --radio-borde-modal-grande: 15px;

            --padding-boton: 12px 25px;
            --padding-modal: 30px;
            --padding-modal-grande: 35px 30px;

            --sombra-elemento: 0 4px 10px rgba(0, 0, 0, 0.15), 0 2px 5px rgba(0, 0, 0, 0.1);
            --sombra-elemento-hover: 0 6px 12px rgba(0, 0, 0, 0.2);
            --sombra-modal: 0 15px 40px rgba(0, 0, 0, 0.2), 0 6px 20px rgba(0, 0, 0, 0.15);
            --sombra-modal-hover: 0 8px 20px rgba(0, 0, 0, 0.25);

            --fuente-principal: Arial, sans-serif;
            --tamano-fuente-normal: 16px;
            --tamano-fuente-boton: 17px;
            --tamano-fuente-titulo-modal: 1.8em;
            /* Adjusted for h2 in modals */
        }

        /* General styles for the page body */
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: var(--fuente-principal);
            font-size: var(--tamano-fuente-normal);
            background-image: url('fondo.jpg');
            /* Placeholder for background image - assuming it's in the root */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            /* Disable zoom on non-map elements */
            touch-action: pan-x pan-y;
            /* Allows scrolling but prevents pinch-zoom on the body */
            -webkit-user-select: none;
            /* Safari */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* IE 10+ */
            user-select: none;
            /* Standard */
        }

        #map {
            height: 100vh;
            width: 100%;
            /* Allow all touch actions including zoom on the map */
            touch-action: manipulation;
            -webkit-user-select: auto;
            /* Allow selection inside map if needed */
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }

        /* Base styles for all modal windows */
        .modal-base {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: var(--padding-modal);
            border-radius: var(--radio-borde-modal);
            z-index: 1000;
            width: 90vw;
            max-width: 450px;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.1);
            /* Subtle border */
            box-shadow: var(--sombra-modal);
            display: none;
            /* Hidden by default */
            animation: fadeIn 0.5s ease-out;

            /* Background with image and overlay for readability */
            background: linear-gradient(var(--color-fondo-overlay), var(--color-fondo-overlay)), url('fondoventanas.jpg');
            /* Placeholder for window background image - assuming it's in the root */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            /* Ensure modals also prevent zoom */
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .modal-base.mostrar {
            display: block;
        }

        .modal-base h2 {
            font-size: var(--tamano-fuente-titulo-modal);
            color: var(--color-texto-oscuro);
            margin-bottom: 20px;
            font-weight: bold;
            text-shadow: 0 0 8px var(--color-texto-blanco);
        }

        .modal-base p {
            color: var(--color-texto-oscuro);
            text-shadow: 0 0 8px var(--color-texto-blanco);
            font-weight: bold;
            /* Maintained from original style */
            margin-bottom: 15px;
            line-height: 1.6;
        }

        /* Styles for general buttons */
        button,
        .button-style {
            /* .button-style for elements that are not buttons but should look like one */
            margin: 10px 5px;
            /* Margin adjustment */
            padding: var(--padding-boton);
            font-size: var(--tamano-fuente-boton);
            border-radius: var(--radio-borde-general);
            border: 1px solid rgba(0, 0, 0, 0.2);
            /* More subtle border */
            background: linear-gradient(135deg, var(--color-primario-verde-claro) 0%, var(--color-primario-verde) 100%);
            color: var(--color-texto-blanco);
            cursor: pointer;
            box-shadow: var(--sombra-elemento);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, opacity 0.2s ease;
            /* Added opacity transition */
            font-weight: 600;
            letter-spacing: 0.5px;
            text-decoration: none;
            /* For .button-style if it's an <a> */
            display: inline-block;
            /* For .button-style if it's an <a> */
            outline: none;
            /* Remove default outline */
            min-height: 44px;
            /* Minimum touch target size */
            min-width: 44px;
            /* Minimum touch target size */
            box-sizing: border-box;
            /* Include padding and border in the element's total width and height */
            /* Prevent zoom on buttons */
            touch-action: manipulation;
            /* Allows tap, double-tap, pan, but not pinch-zoom */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        button:hover,
        .button-style:hover {
            background: linear-gradient(135deg, var(--color-primario-verde) 0%, var(--color-primario-verde-oscuro) 100%);
            transform: translateY(-2px);
            box-shadow: var(--sombra-elemento-hover);
        }

        /* Styles for focus and active states (keyboard navigation/click feedback) */
        button:focus-visible,
        button:focus,
        .button-style:focus-visible,
        .button-style:focus {
            transform: translateY(0);
            border: 3px solid var(--color-secundario-azul-claro);
            /* Thicker blue border */
            box-shadow: 0 0 0 2px var(--color-secundario-azul-claro),
                /* Blue outline effect (slightly smaller to complement border) */
                0 3px 8px rgba(0, 0, 0, 0.25);
            /* Original shadow */
        }

        button:active,
        .button-style:active {
            transform: scale(0.95);
            /* Slightly shrink on click */
            opacity: 0.8;
            /* Fade a bit */
            box-shadow: var(--sombra-elemento);
            /* Reset shadow to normal on active */
        }


        /* Style for buttons that should always have the blue border */
        .age-selection-button {
            /* New class for age selection buttons */
            border: 3px solid var(--color-secundario-azul-claro) !important;
            /* Force blue border */
            box-shadow: 0 0 0 2px var(--color-secundario-azul-claro),
                /* Blue outline effect */
                var(--sombra-elemento) !important;
            /* Keep original shadow */
        }

        /* Fixed buttons */
        #botones-fijos {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 999;
            /* Adjusted z-index to be behind modals */
            display: flex;
            /* Use flexbox for layout */
            flex-direction: column;
            /* Stack vertically */
            gap: 5px;
            /* Space between buttons */
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #botones-fijos button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
        }

        #botones-fijos button svg {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            fill: var(--color-texto-blanco);
        }

        #botones-fijos button span {
            display: none;
        }

        /* Progress panel */
        #panel-progreso {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: calc(100% - 20px);
            max-width: 350px;
            background: var(--color-fondo-overlay);
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: var(--radio-borde-general);
            padding: 10px;
            z-index: 999;
            box-shadow: var(--sombra-elemento);
            font-size: 14px;
            color: var(--color-texto-oscuro);
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #barra-progreso {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: var(--radio-borde-general);
            overflow: hidden;
            margin-bottom: 5px;
        }

        #progreso-porcentaje {
            height: 100%;
            width: 0%;
            background-color: var(--color-primario-verde);
            transition: width 0.5s ease;
        }

        /* Specific Final Window */
        #ventana-final {
            max-width: 480px;
            padding: var(--padding-modal-grande);
            border-radius: var(--radio-borde-modal-grande);
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            z-index: 10001;
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #ventana-final h2 {
            color: var(--color-primario-verde-oscuro);
        }

        #ventana-final button {
            background: linear-gradient(135deg, var(--color-secundario-azul-claro) 0%, var(--color-secundario-azul) 100%);
        }

        #ventana-final button:hover {
            background: linear-gradient(135deg, var(--color-secundario-azul) 0%, var(--color-secundario-azul-oscuro) 100%);
        }

        /* Styles for the custom modal created by JS */
        .custom-js-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--color-texto-blanco);
            padding: var(--padding-modal);
            border-radius: var(--radio-borde-modal);
            box-shadow: var(--sombra-modal);
            z-index: 10005;
            text-align: center;
            max-width: 380px;
            width: 85vw;
            color: var(--color-texto-oscuro);
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .custom-js-modal h3 {
            font-size: 1.5em;
            color: var(--color-texto-oscuro);
            margin-bottom: 15px;
            font-weight: bold;
        }

        .custom-js-modal p {
            font-size: 1.1em;
            margin-bottom: 25px;
            line-height: 1.5;
            text-shadow: none;
            font-weight: normal;
        }

        .custom-js-modal .modal-botones button {
            margin: 8px;
            padding: 10px 20px;
        }

        /* Specific confirmation/error buttons for JS modal */
        .custom-js-modal .boton-confirmacion {
            background: linear-gradient(135deg, var(--color-primario-verde-claro) 0%, var(--color-primario-verde) 100%);
        }

        .custom-js-modal .boton-confirmacion:hover {
            background: linear-gradient(135deg, var(--color-primario-verde) 0%, var(--color-primario-verde-oscuro) 100%);
        }

        .custom-js-modal .boton-negacion {
            background: linear-gradient(135deg, var(--color-error-rojo-claro) 0%, var(--color-error-rojo) 100%);
        }

        .custom-js-modal .boton-negacion:hover {
            background: linear-gradient(135deg, var(--color-error-rojo) 0%, #d32f2f 100%);
        }

        /* Style for the explanation text after answering a question */
        #explicacion-respuesta {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(240, 240, 240, 0.9);
            border-radius: var(--radio-borde-general);
            text-align: left;
            font-size: 0.95em;
            color: var(--color-texto-oscuro);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            display: none;
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #explicacion-respuesta.mostrar {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        /* Styles for the correct answer celebration modal */
        #ventana-felicitacion {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: var(--padding-modal-grande);
            border-radius: var(--radio-borde-modal-grande);
            box-shadow: var(--sombra-modal);
            z-index: 10006;
            text-align: center;
            max-width: 500px;
            width: 90vw;
            color: var(--color-texto-oscuro);
            display: none;
            animation: fadeIn 0.5s ease-out;
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #ventana-felicitacion.mostrar {
            display: block;
        }

        #ventana-felicitacion h3 {
            font-size: 2em;
            color: var(--color-primario-verde-oscuro);
            margin-bottom: 20px;
        }

        #ventana-felicitacion img {
            max-width: 100%;
            height: auto;
            border-radius: var(--radio-borde-general);
            margin-bottom: 20px;
            box-shadow: var(--sombra-elemento);
        }

        #ventana-felicitacion p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 20px;
            text-shadow: none;
            font-weight: normal;
        }

        #ventana-felicitacion button {
            background: linear-gradient(135deg, var(--color-secundario-azul-claro) 0%, var(--color-secundario-azul) 100%);
        }

        #ventana-felicitacion button:hover {
            background: linear-gradient(135deg, var(--color-secundario-azul) 0%, var(--color-secundario-azul-oscuro) 100%);
        }

        #opciones {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        #opciones button {
            padding: 15px;
            font-size: 1.1em;
            cursor: pointer;
            border: none;
            border-radius: var(--radio-borde-general);
            background-color: var(--color-secundario-azul-claro);
            color: var(--color-texto-blanco);
            box-shadow: var(--sombra-elemento);
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.1s ease;
            font-weight: bold;
            text-align: center;
            white-space: normal;
            min-height: 44px;
            line-height: 1.4;
        }

        #opciones button:hover {
            background-color: var(--color-secundario-azul);
            box-shadow: var(--sombra-elemento-hover);
        }

        #opciones button:active {
            transform: scale(0.95);
            opacity: 0.8;
        }


        /* Animaciones */
        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: translate(-50%, -55%);
            }

            100% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        @keyframes aparecerVentana {
            0% {
                opacity: 0;
                transform: translate(-50%, -60%);
            }

            100% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* Custom Leaflet DivIcon for user location */
        .leaflet-div-icon {
            background: none;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px !important;
            height: 30px !important;
            transform-origin: bottom center;
        }

        .leaflet-div-icon svg {
            width: 100%;
            height: 100%;
            display: block;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.4));
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Media queries for responsive design */
        @media (max-width: 600px) {

            .modal-base,
            #ventana-final,
            .custom-js-modal,
            #ventana-felicitacion {
                width: 95vw;
                max-width: 95vw;
            }

            .modal-base h2 {
                font-size: 1.5em;
            }

            .custom-js-modal h3 {
                font-size: 1.3em;
            }

            .custom-js-modal p {
                font-size: 1em;
            }

            #ventana-felicitacion h3 {
                font-size: 1.5em;
            }

            #panel-progreso {
                font-size: 13px;
            }

            #botones-fijos {
                top: 10px;
                right: 10px;
                display: flex;
                flex-direction: column;
                gap: 6px;
                align-items: flex-end;
            }

            #botones-fijos button {
                margin-bottom: 0;
                padding: 8px 12px;
                font-size: 14px;
            }

            #botones-fijos button span {
                display: inline;
            }
        }

        /* Media query for larger screens to show text next to icons */
        @media (min-width: 601px) {
            #botones-fijos button span {
                display: inline;
            }
        }

        /* Estilos para el contenedor del chatbot de n8n para asegurar visibilidad */
        #n8n-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10007; /* Asegura que esté por encima de todos los demás elementos */
            width: 60px; /* Para dar un tamaño mínimo al contenedor donde estará el botón */
            height: 60px;
        }

        /* Estilos para el botón flotante real que crea n8n (clases comunes) */
        #n8n-chat .n8n-chat-bubble,
        #n8n-chat .n8n-chat-launcher {
            background-color: #25D366 !important; /* Color similar al WhatsApp */
            color: white !important;
            border-radius: 50% !important;
            width: 60px !important;
            height: 60px !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            transition: transform 0.2s ease, box-shadow 0.2s ease !important;
            padding: 0 !important; /* Asegurarse que no haya padding interno inesperado */
        }

        #n8n-chat .n8n-chat-bubble:hover,
        #n8n-chat .n8n-chat-launcher:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3) !important;
        }

        #n8n-chat .n8n-chat-bubble:active,
        #n8n-chat .n8n-chat-launcher:active {
            transform: scale(0.95) !important;
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <div id="ventana-bienvenida" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="titulo-bienvenida">
        <h2 id="titulo-bienvenida">¡Bienvenido a la trivia de la "Reserva Natural Francisco Tau"!</h2>
        <p>¿En qué rango de edad te encontrás?</p>
        <div id="botones-edad">
            <button data-edad="menor10" class="age-selection-button">Menor a 10 años</button>
            <button data-edad="10a15" class="age-selection-button">Entre 10 y 15 años</button>
            <button data-edad="mayor15" class="age-selection-button">Mayor a 15 años</button>
        </div>
    </div>

    <div id="ventana-instrucciones" class="modal-base" role="dialog" aria-modal="true"
        aria-labelledby="titulo-instrucciones">
        <h2 id="titulo-instrucciones">¡Bienvenido a la trivia de la "Reserva Natural Francisco Tau"!</h2>
        <p>En esta trivia aprenderemos diferentes aspectos naturales, culturales y sociales de nuestra reserva natural.</p>
        <p>Para poder realizar la experiencia de la forma más óptima debemos realizar dos cosas:</p>
        <p>En primer lugar, activar la ubicación y en segundo, activar el sonido.</p>
        <p>¡Esperamos que disfrutes este viaje por la reserva!</p>
        <button id="boton-comenzar-instrucciones">¡Comencemos!</button>
    </div>

    <div id="pregunta" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="texto-pregunta">
        <p id="texto-pregunta"></p>
        <div id="opciones"></div>
        <div id="explicacion-respuesta"></div>
    </div>

    <div id="ventana-felicitacion" role="dialog" aria-modal="true" aria-labelledby="titulo-felicitacion">
        <h3 id="titulo-felicitacion">¡Respuesta Correcta!</h3>
        <img id="felicitacion-imagen" src="algarrobo.jpg" alt="Imagen del lugar">
        <p id="felicitacion-explicacion"></p>
        <button id="boton-continuar-felicitacion">Continuar</button>
    </div>

    <div id="botones-fijos" style="display: none;">
        <button id="boton-reiniciar" aria-label="Reiniciar Trivia">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M12 4V1l-4 4 4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z" />
            </svg>
            <span>Reiniciar</span>
        </button>
        <button id="boton-mostrar-ubicacion" aria-label="Mostrar mi ubicación">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
            </svg>
            <span>Mi ubicación</span>
        </button>
        <button id="boton-toggle-sonido" aria-label="Activar/Desactivar Sonido">
            <svg id="icon-sound-on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
            </svg>
            <svg id="icon-sound-off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display:none;">
                <path
                    d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .9-.23 1.74-.63 2.5L20.5 17c.92-1.23 1.5-2.77 1.5-4.5 0-4.01-2.99-7.11-7-8.77v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71zM4.27 3L3 4.27l9 9V19c0 1.38-1.12 2.5-2.5 2.5S6 20.38 6 19v-1H2v1c0 2.21 1.79 4 4 4s4-1.79 4-4V7.27L1.27 0 0 1.27l3 3zm7.53 10.73L7.27 9H3v6h3.73l4.5 4.5c.66.33 1.41.5 2.22.5 2.05 0 3.8-.96 4.99-2.4l-2.72-2.72z" />
            </svg>
            <span>Sonido</span>
        </button>
    </div>

    <div id="panel-progreso" style="display: none;">
        <div id="barra-progreso">
            <div id="progreso-porcentaje"></div>
        </div>
        <div id="progreso-texto">0 / 0 preguntas respondidas - Puntaje: 0 / 0</div>
    </div>

    <div id="ventana-final" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="titulo-final">
        <h2 id="titulo-final">🎉 ¡Felicitaciones!</h2>
        <p>Has finalizado la trivia del <strong>Parque Natural Francisco Tau</strong>.</p>
        <p id="mensaje-final"></p>
        <p>Tu puntaje final es: <span id="puntaje-final"></span></p>
        <button id="boton-cerrar-final">Cerrar</button>
    </div>

    <audio id="sonido-correcto" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"
        preload="auto"></audio>
    <audio id="sonido-incorrecto" src="https://actions.google.com/sounds/v1/cartoon/boing.ogg"
        preload="auto"></audio>
    <audio id="alarmaSonido" preload="auto">
        <source src="alarma.mp3" type="audio/mpeg">
        Tu navegador no sopporta el elemento de audio.
    </audio>

    <!-- Contenedor donde se renderizará el chatbot de n8n -->
    <div id="n8n-chat"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script type="module">
        import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

        // --- Global Variables and Configuration ---
        const preguntasData = {
            "menor10": [
                {
                    "coords": [-34.61017, -58.36833], // Coordenadas de ejemplo, ajustar según necesidad real
                    "texto": "“ Tengo tronco fuerte y vainas dulces; doy mucha sombra en el parque. ¿Quién soy?”",
                    "opciones": ["Eucalipto", "Pino", "Algarrobo blanco"],
                    "correcta": 2,
                    "explicacion": "¡Este algarrobo vive en el Parque Tau desde hace más de 400 años! Es un “abuelo” del bosque que da sombra fresca y alimento a muchos animalitos.",
                    "fotoUrl": "algarrobo.jpg"
                },
                {
                    "coords": [-34.61018, -58.36851], // Coordenadas de ejemplo
                    "texto": "“Toc-toc, pico el barro y hago mi casita redonda. ¿Quién canta así?”",
                    "opciones": ["Gorrión", "Hornero", "Jilguero"],
                    "correcta": 1,
                    "explicacion": "El hornero es un pajarito constructor: amasa barro como plastilina y levanta un nido redondo que parece un hornito de pan.",
                    "fotoUrl": "hornero.jpg"
                },
                {
                    "coords": [-34.61026, -58.36866], // Coordenadas de ejemplo
                    "texto": "“Me abrochas antes de subir al gomón para que flotes seguro. ¿Qué soy?”",
                    "opciones": ["Casco", "Salvavidas", "Remo"],
                    "correcta": 1,
                    "explicacion": "La Fundación tiene ¡cien chalecos! Se cierran con clic-clic y te abrazan para que navegues protegido mientras disfrutas del río.",
                    "fotoUrl": "chaleco.jpg"
                },
                {
                    "coords": [-34.61042, -58.36870], // Coordenadas de ejemplo
                    "texto": "“Serpenteo con agua fresca junto al bosque del parque. ¿Cómo me llamo?”",
                    "opciones": ["Río Segundo", "Río Primero", "Río Ctalamochita"],
                    "correcta": 0,
                    "explicacion": "Su nombre indígena significa “lugar de muchos árboles”. Con sus curvas suaves forma playitas donde peces, plantas y personas se refrescan.",
                    "fotoUrl": "rioct.jpg"
                },
                {
                    "coords": [-34.61063, -58.36858], // Coordenadas de ejemplo
                    "texto": "“Tomo sol quieto, tengo escamas y una lengua larga. ¿Quién soy?”",
                    "opciones": ["Serpiente", "Tortuga", "Lagarto overo"],
                    "correcta": 2,
                    "explicacion": "Este lagarto moteado adora broncearse en los claros del parque. Ayuda a mantener el equilibrio porque se come insectos y pequeños bichitos.",
                    "fotoUrl": "lagarto.jpg"
                },
                {
                    "coords": [-34.61082, -58.36855], // Coordenadas de ejemplo para las nuevas preguntas
                    "texto": "“Cuelgo de los árboles como una flor que vive del aire. ¿Cómo me llaman?”",
                    "opciones": ["Orquídea", "Clavel del aire", "Rosa"],
                    "correcta": 1,
                    "explicacion": "No necesita tierra: bebe la humedad del viento y adorna las ramas con sus hojitas plateadas, ¡un colgante natural del bosque!",
                    "fotoUrl": "clavel.jpg"
                },
                {
                    "coords": [-34.61100, -58.36843], // Coordenadas de ejemplo
                    "texto": "“Cuido plantas y animales y ayudo a los visitantes. ¿Quién soy?”",
                    "opciones": ["Científico", "Turista", "Guardaparque"],
                    "correcta": 2,
                    "explicacion": "La guardaparque del Tau es la super-heroína verde: vigila senderos, da consejos y protege cada rincón del bosque todos los días.",
                    "fotoUrl": "guarda.png"
                },
                {
                    "coords": [-34.61097, -58.36814], // Coordenadas de ejemplo
                    "texto": "“Si tiras basura aquí, ensucias a peces y patos. ¿Qué lugar es?”",
                    "opciones": ["El río", "El lago", "La calle"],
                    "correcta": 0,
                    "explicacion": "Usar los tachos y llevarte tus residuos mantiene el agua clarita y feliz; así el río sigue sano para nadar y remar.",
                    "fotoUrl": "rio.jpg"
                },
                {
                    "coords": [-34.61095, -58.36787], // Coordenadas de ejemplo
                    "texto": "“Reciclando papel le salvamos la vida a este gran amigo verde. ¿Quién es?”",
                    "opciones": ["Pasto", "Flor", "Árbol"],
                    "correcta": 2,
                    "explicacion": "Los árboles dan sombra, aire puro y casita a los pájaros. En el parque crecen talas, chañares y un histórico algarrobo blanco que son verdaderos tesoros.",
                    "fotoUrl": "arbol.jpg"
                },
                {
                    "coords": [-34.61091,-58.36750], // Coordenadas de ejemplo
                    "texto": "“Llevo gorrita roja y pechito blanco; mi canto suena fuerte. ¿Qué pájaro soy?”",
                    "opciones": ["Colibrí", "Cardenal común", "Benteveo"],
                    "correcta": 1,
                    "explicacion": "Con su “sombrerito” rojo brillante, el cardenal es una de las aves más vistosas del parque y se deja ver entre las ramas cantando con energía.",
                    "fotoUrl": "cardenal.jpg"
                }
            ],
            "10a15": [
                {
                    "coords": [-32.62763, -62.70419],
                    "texto": "¿Cuál es la especie de árbol nativo más antigua del Parque Francisco Tau, considerada un monumento natural viviente?",
                    "opciones": ["Algarrobo blanco", "Pino", "Eucalipto"],
                    "correcta": 0,
                    "explicacion": "Es un árbol nativo típico de la región chaqueña y pampeana, muy resistente a la sequía. En el Parque Francisco Tau, el algarrobo blanco aporta sombra y alimento a la fauna local con sus vainas dulces. Además, su madera es dura y se utiliza tradicionalmente para carpintería y artesanía. Es una especie clave para mantener el equilibrio ecológico del área.",
                    "fotoUrl": "algarrobo.jpg"
                },
                {
                    "coords": [-32.62742, -62.70511],
                    "texto": "¿Qué río atraviesa el Parque Francisco Tau y forma parte importante de su paisaje natural?",
                    "opciones": ["Río Segundo", "Río Primero", "Río Ctalamochita"],
                    "correcta": 2,
                    "explicacion": "El Río Ctalamochita, también llamado Río Tercero, atraviesa el Parque Francisco Tau y es fundamental para su ecosistema. Sus aguas forman balnearios naturales como El Diquecito y Paso de la Arena, y brindan hábitat a aves acuáticas, peces y mamíferos como el coipo. Además de su valor natural y recreativo, funciona como un corredor biológico, conectando distintos ambientes y favoreciendo la biodiversidad del parque.",
                    "fotoUrl": "rio.jpg"
                },
                {
                    "coords": [-32.62655, -62.70584],
                    "texto": "¿A qué bioma pertenece el monte nativo que protege el Parque Francisco Tau?",
                    "opciones": ["Chaco Húmedo", "Espinal", "Selva de Yungas"],
                    "correcta": 1,
                    "explicacion": "El Parque Francisco Tau conserva un relicto del bioma del Espinal, un tipo de bosque nativo de la llanura cordobesa. Se caracteriza por especies resistentes a la sequía como el algarrobo blanco, el tala, el chañar y el espinillo. Este ecosistema, hoy muy reducido por la expansión agrícola, es único en un centro urbano en Córdoba. Su preservación es fundamental para conservar la biodiversidad autóctona, estudiar el ambiente original de la región y mantener un pulmón verde para la ciudad.",
                    "fotoUrl": "espinal.jpg"
                },
                {
                    "coords": [-32.62550, -62.70573],
                    "texto": "¿Cuántas especies de aves, aproximadamente, han sido identificadas en el Parque Francisco Tau?",
                    "opciones": ["100", "135", "125"],
                    "correcta": 2,
                    "explicacion": "El Parque Francisco Tau alberga una gran diversidad de aves, con al menos 125 especies registradas, lo que lo convierte en un sitio ideal para la observación de aves. Se encuentran 					especies comunes y vistosas como el hornero, el benteveo, el cardenal común y el chingolo, así como aves acuáticas como el biguá, la gallareta y el martín pescador chico. También se 					observan aves rapaces como el carancho y la lechucita de las vizcacheras.\n\t\t\t\t\tLa variedad de hábitats del parque (bosque, ribera, pastizal) favorece esta riqueza avifaunística, que es clave para el equilibrio ecológico y un gran recurso para la educación 					ambiental.",
                    "fotoUrl": "ave.jpg"
                },
                {
                    "coords": [-32.62451, -62.70495],
                    "texto": "¿Qué roedor semiacuático, parecido a una nutria, habita en las orillas del Río Ctalamochita dentro del parque?",
                    "opciones": ["Comadreja overa", "Coipo", "Cuis"],
                    "correcta": 1,
                    "explicacion": "El coipo, también llamado nutria criolla, es un mamífero roedor semiacuático que vive en zonas cercanas al agua, como las orillas del Río Ctalamochita, dentro del Parque Francisco Tau. 					Tiene un cuerpo robusto, pelaje denso e impermeable, y una cola larga y redondeada. Sus patas traseras palmeadas le permiten nadar con gran agilidad. Se alimenta principalmente de vegetación 						acuática y raíces, y suele construir madrigueras en barrancas o entre la vegetación ribereña. Es una especie nativa de América del Sur y cumple un rol ecológico importante en el ecosistema 						acuático, ayudando a controlar el crecimiento de plantas en lagunas y ríos. Su presencia en el parque indica una buena calidad ambiental en los ambientes ribereños y la existencia de refugio 						adecuado para fauna nativa.",
                    "fotoUrl": "coipo.jpg"
                }
            ],
            "mayor15": [
                {
                    "coords": [-32.62763, -62.70419],
                    "texto": "¿Qué especie arbórea autóctona, propia del Espinal y con un ejemplar de más de cuatro siglos en el parque, representa un testimonio ecológico e histórico de la región?",
                    "opciones": ["Algarrobo blanco", "Pino", "Eucalipto"],
                    "correcta": 0,
                    "explicacion": "Es un árbol nativo típico de la región chaqueña y pampeana, muy resistente a la sequía. En el Parque Francisco Tau, el algarrobo blanco aporta sombra y alimento a la fauna local con sus vainas dulces. Además, su madera es dura y se utiliza tradicionalmente para carpintería y artesanía. Es una especie clave para mantener el equilibrio ecológico del área.",
                    "fotoUrl": "algarrobo.jpg"
                },
                {
                    "coords": [-32.62742,-62.70511],
                    "texto": "¿Cuál es el curso fluvial que recorre el parque, funcionando como corredor biológico y aportando ambientes acuáticos y ribereños?",
                    "opciones": ["Río Primero", "Río Ctalamochita", "Río Segundo"],
                    "correcta": 1,
                    "explicacion": "El Río Ctalamochita, también llamado Río Tercero, atraviesa el Parque Francisco Tau y es fundamental para su ecosistema. Sus aguas forman balnearios naturales como El Diquecito y Paso de la Arena, y brindan hábitat a aves acuáticas, peces y mamíferos como el coipo. Además de su valor natural y recreativo, funciona como un corredor biológico, conectando distintos ambientes y favoreciendo la biodiversidad del parque.",
                    "fotoUrl": "rio.jpg"
                },
                {
                    "coords": [-32.62655, -62.70584],
                    "texto": "¿Cuál es el nombre de la ecorregión fitogeográfica representada por el relicto conservado en el Parque Francisco Tau?",
                    "opciones": ["Selva de Yungas", "Chaco Húmedo", "Espinal"],
                    "correcta": 0,
                    "explicacion": "El Parque Francisco Tau conserva un relicto del bioma del Espinal, un tipo de bosque nativo de la llanura cordobesa. Se caracteriza por especies resistentes a la sequía como el algarrobo blanco, el tala, el chañar y el espinillo. Este ecosistema, hoy muy reducido por la expansión agrícola, es único en un centro urbano en Córdoba. Su preservación es fundamental para conservar la biodiversidad autóctona, estudiar el ambiente original de la región y mantener un pulmón verde para la ciudad.",
                    "fotoUrl": "espinal.jpg"
                },
                {
                    "coords": [-32.62550, -62.70573],
                    "texto": "Según relevamientos recientes, ¿cuántas especies avifaunísticas habitan actualmente el Parque Francisco Tau?",
                    "opciones": ["125", "135", "115"],
                    "correcta": 0,
                    "explicacion": "El Parque Francisco Tau alberga una gran diversidad de aves, con al menos 125 especies registradas, lo que lo convierte en un sitio ideal para la observación de aves. Se encuentran 					especies comunes y vistosas como el hornero, el benteveo, el cardenal común y el chingolo, así como aves acuáticas como el biguá, la gallareta y el martín pescador chico. También se 					observan aves rapaces como el carancho y la lechucita de las vizcacheras.\n\t\t\t\t\tLa variedad de hábitats del parque (bosque, ribera, pastizal) favorece esta riqueza avifaunística, que es clave para el equilibrio ecológico y un gran recurso para la educación 					ambiental.",
                    "fotoUrl": "ave.jpg"
                },
                {
                    "coords": [-32.62451, -62.70495],
                    "texto": "¿Cuál es el mamífero nativo de hábitos ribereños, identificado como Myocastor coypus, registrado en el Parque Francisco Tau?",
                    "opciones": ["Comadreja overa", "Cuis", "Coipo"],
                    "correcta": 2,
                    "explicacion": "El coipo (Myocastor coypus) es un roedor semiacuático nativo, clave en los ecosistemas ribereños del parque, contribuyendo al control de la vegetación acuática.",
                    "fotoUrl": "coipo.jpg"
                }
            ]
        };

        let edadSeleccionada = null;
        let progreso = {
            actual: 0,
            puntaje: 0,
            intentos: {}
        };
        let mapa;
        let marcadorUbicacion;
        let ubicacionWatchId = null;
        const ACTIVATION_RADIUS = 10;
        const preguntaMarkers = [];
        let currentQuestionRadiusCircle = null;
        let sonidoActivado = true;
        let supportsWebP = false;

        const computedStyles = getComputedStyle(document.documentElement);
        const colorErrorRojo = computedStyles.getPropertyValue('--color-error-rojo').trim();

        const ventanaBienvenida = document.getElementById("ventana-bienvenida");
        const ventanaInstrucciones = document.getElementById("ventana-instrucciones");
        const ventanaPregunta = document.getElementById("pregunta");
        const ventanaFinal = document.getElementById("ventana-final");
        const ventanaFelicitacion = document.getElementById("ventana-felicitacion");
        const panelProgreso = document.getElementById("panel-progreso");
        const botonesFijos = document.getElementById("botones-fijos");
        const sonidoCorrecto = document.getElementById("sonido-correcto");
        const sonidoIncorrecto = document.getElementById("sonido-incorrecto");
        const botonToggleSonido = document.getElementById("boton-toggle-sonido");
        const iconSoundOn = document.getElementById("icon-sound-on");
        const iconSoundOff = document.getElementById("icon-sound-off");

        function checkWebPSupport() {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function () {
                    resolve(img.width > 0 && img.height > 0);
                };
                img.onerror = function () {
                    resolve(false);
                };
                img.src = 'data:image/webp;base64,UklGRhoAAABXRUJQVlA4TA0AAAAvAAAAEAcQERGIiP4HAA==';
            });
        }

        function loadImage(imgElement) {
            // Se asigna directamente la fotoUrl al src de la imagen
            // No se usan data-src o data-srcset, y no se realiza conversión a WebP aquí.
        }

        function reproducirSonido(audio) {
            if (sonidoActivado) {
                audio.currentTime = 0;
                audio.play();
            }
        }

        let alarmaAudio;
        function reproducirAlarma() {
            if (!alarmaAudio) {
                alarmaAudio = document.getElementById('alarmaSonido');
            }
            if (sonidoActivado && alarmaAudio && alarmaAudio.readyState >= 2) {
                alarmaAudio.currentTime = 0;
                alarmaAudio.play().catch(e => console.error("Error al reproducir la alarma:", e));
            } else {
                console.warn("Alarma no reproducida: sonido deshabilitado o audio no cargado.", { sonidoActivado, readyState: alarmaAudio ? alarmaAudio.readyState : 'N/A' });
            }
        }

        function feedbackHaptico(pattern = 50) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        function reproducirTexto(text) {
            if ('speechSynthesis' in window && sonidoActivado) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                utterance.volume = 1;
                utterance.rate = 1;
                utterance.pitch = 1;
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utterance);
            } else if (!('speechSynthesis' in window)) {
                console.warn("La API de síntesis de voz no está soportada en este navegador.");
            }
        }

        function crearModalPersonalizado(titulo, mensaje, botonesConfig) {
            const modalExistente = document.querySelector('.custom-js-modal');
            if (modalExistente) {
                document.body.removeChild(modalExistente);
            }

            const modal = document.createElement('div');
            modal.className = 'custom-js-modal';
            modal.setAttribute('role', 'alertdialog');
            modal.setAttribute('aria-modal', 'true');

            const modalTitulo = document.createElement('h3');
            modalTitulo.textContent = titulo;
            modal.appendChild(modalTitulo);
            const tituloId = 'custom-modal-titulo-' + Date.now();
            modalTitulo.id = tituloId;
            modal.setAttribute('aria-labelledby', tituloId);

            const modalMensaje = document.createElement('p');
            modalMensaje.innerHTML = mensaje;
            modal.appendChild(modalMensaje);

            const botonesDiv = document.createElement('div');
            botonesDiv.className = 'modal-botones';

            botonesConfig.forEach(btnConfig => {
                const button = document.createElement("button");
                button.textContent = btnConfig.texto;
                if (btnConfig.clase) {
                    button.classList.add(...btnConfig.clase.split(' '));
                }
                button.addEventListener('click', () => {
                    if (btnConfig.callback) {
                        btnConfig.callback();
                    }
                    document.body.removeChild(modal);
                });
                botonesDiv.appendChild(button);
            });

            modal.appendChild(botonesDiv);
            document.body.appendChild(modal);
            if (botonesDiv.firstChild && typeof botonesDiv.firstChild.focus === 'function') {
                botonesDiv.firstChild.focus();
            }
        }

        function obtenerPreguntas() {
            return preguntasData[edadSeleccionada] || [];
        }

        function seleccionarEdad(rango) {
            edadSeleccionada = rango;
            ventanaBienvenida.classList.remove("mostrar");
            iniciarMapa();
            ventanaInstrucciones.classList.add("mostrar");
            document.getElementById("boton-comenzar-instrucciones").focus();

            const tituloBienvenida = document.getElementById("titulo-bienvenida").textContent;
            const parrafoBienvenida = document.querySelector("#ventana-bienvenida p").textContent;
            reproducirTexto(tituloBienvenida + " " + parrafoBienvenida);

            const textoInstrucciones = document.getElementById("titulo-instrucciones").textContent + " " +
                Array.from(document.querySelectorAll("#ventana-instrucciones p")).map(p => p.textContent).join(" ");
            reproducirTexto(textoInstrucciones);
        }

        function cerrarVentanaInstrucciones() {
            ventanaInstrucciones.classList.remove("mostrar");
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
            if (!ubicacionWatchId) {
                iniciarSeguimientoUbicacion();
            }
        }

        function iniciarMapa() {
            const primerasPreguntas = obtenerPreguntas();
            if (primerasPreguntas.length === 0) {
                crearModalPersonalizado("Error", "No hay preguntas para el rango de edad seleccionado.", [{
                    texto: "Cerrar"
                }]);
                return;
            }
            mapa = L.map('map').setView(primerasPreguntas[0].coords, 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(mapa);

            preguntaMarkers.forEach(marker => marker.remove());
            preguntaMarkers.length = 0;

            primerasPreguntas.forEach((p, index) => {
                const marker = L.marker(p.coords, {
                    opacity: 0.5,
                    interactive: false
                });
                p.marker = marker;
                preguntaMarkers.push(marker);
            });

            actualizarPanelProgreso();
            botonesFijos.style.display = "flex";
            panelProgreso.style.display = "block";
        }

        function actualizarVisibilidadMarcadorActual() {
            if (progreso.actual < obtenerPreguntas().length) {
                const preguntaActual = obtenerPreguntas()[progreso.actual];
                if (preguntaActual.marker && !mapa.hasLayer(preguntaActual.marker)) {
                    preguntaActual.marker.setOpacity(1).addTo(mapa);
                }
                if (currentQuestionRadiusCircle) {
                    mapa.removeLayer(currentQuestionRadiusCircle);
                }
                currentQuestionRadiusCircle = L.circle(L.latLng(preguntaActual.coords), {
                    color: 'blue',
                    fillColor: '#0000ff',
                    fillOpacity: 0.2,
                    radius: ACTIVATION_RADIUS
                }).addTo(mapa);
            } else if (currentQuestionRadiusCircle) {
                mapa.removeLayer(currentQuestionRadiusCircle);
                currentQuestionRadiusCircle = null;
            }
        }

        function mostrarFelicitacionCorrecta(pregunta) {
            const felicitacionImagen = document.getElementById("felicitacion-imagen");
            felicitacionImagen.src = pregunta.fotoUrl;
            felicitacionImagen.removeAttribute('data-src');
            felicitacionImagen.removeAttribute('data-srcset');
            felicitacionImagen.removeAttribute('sizes');
            felicitacionImagen.alt = `Imagen relacionada con la pregunta: ${pregunta.texto}`;

            document.getElementById("felicitacion-explicacion").textContent = pregunta.explicacion;

            ventanaFelicitacion.classList.add("mostrar");

            if (sonidoActivado) {
                sonidoCorrecto.currentTime = 0;
                sonidoCorrecto.play();
            }
            feedbackHaptico(100);

            reproducirTexto(pregunta.explicacion);

            document.getElementById("boton-continuar-felicitacion").focus();

            const botonContinuar = document.getElementById("boton-continuar-felicitacion");
            const oldListener = botonContinuar._currentListener;
            if (oldListener) {
                botonContinuar.removeEventListener('click', oldListener);
            }

            const newListener = () => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                }
                ventanaFelicitacion.classList.remove("mostrar");

                pregunta.marker.setOpacity(0.4);
                pregunta.marker.options.interactive = false;

                if (currentQuestionRadiusCircle) {
                    mapa.removeLayer(currentQuestionRadiusCircle);
                    currentQuestionRadiusCircle = null;
                }

                progreso.actual++;
                actualizarPanelProgreso();
                actualizarVisibilidadMarcadorActual();

                if (progreso.actual >= obtenerPreguntas().length) {
                    mostrarVentanaFinal();
                }
                ventanaPregunta.classList.remove("mostrar");
            };
            botonContinuar.addEventListener('click', newListener);
            botonContinuar._currentListener = newListener;
        }

        function mostrarPregunta(index) {
            if (index !== progreso.actual || ventanaPregunta.classList.contains('mostrar')) {
                return;
            }

            const p = obtenerPreguntas()[index];
            const preguntaId = `pregunta_${index}`;
            progreso.intentos[preguntaId] = progreso.intentos[preguntaId] || 0;

            document.getElementById("texto-pregunta").textContent = p.texto;
            const opcionesDiv = document.getElementById("opciones");
            opcionesDiv.innerHTML = "";

            const fragment = document.createDocumentFragment();

            p.opciones.forEach((opcion, i) => {
                const btn = document.createElement("button");
                btn.textContent = opcion;
                btn.addEventListener('click', () => {
                    if (i === p.correcta) {
                        reproducirSonido(sonidoCorrecto);
                        feedbackHaptico(100);
                        const puntosGanados = Math.max(0, 3 - progreso.intentos[preguntaId]);
                        progreso.puntaje += puntosGanados;
                        mostrarFelicitacionCorrecta(p);
                    } else {
                        reproducirSonido(sonidoIncorrecto);
                        feedbackHaptico([200, 100, 200]);
                        progreso.intentos[preguntaId]++;
                        crearModalPersonalizado(
                            "Respuesta Incorrecta",
                            "¡Ups! Esa no es la respuesta. Intentá de nuevo.",
                            [{
                                texto: "Entendido",
                                clase: "boton-negacion"
                            }]
                        );
                    }
                });
                fragment.appendChild(btn);
            });
            opcionesDiv.appendChild(fragment);
            ventanaPregunta.classList.add("mostrar");
            if (opcionesDiv.firstChild && typeof opcionesDiv.firstChild.focus === 'function') {
                opcionesDiv.firstChild.focus();
            }
        }

        function iniciarSeguimientoUbicacion() {
            if (!navigator.geolocation) {
                crearModalPersonalizado("Error de Geolocalización", "La geolocalización no está soportada por tu navegador.", [{
                    texto: "Cerrar"
                }]);
                return;
            }

            if (ubicacionWatchId !== null) {
                if (marcadorUbicacion) mapa.setView(marcadorUbicacion.getLatLng(), 17);
                return;
            }

            ubicacionWatchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const userLocation = L.latLng(pos.coords.latitude, pos.coords.longitude);
                    if (marcadorUbicacion) {
                        marcadorUbicacion.setLatLng(userLocation);
                    } else {
                        marcadorUbicacion = L.marker(userLocation, {
                            icon: L.divIcon({
                                className: 'leaflet-div-icon',
                                html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#E53935"><path d="M12 2c-4.418 0-8 3.582-8 8 0 7 8 12 8 12s8-5 8-12c0-3.87-3.13-7-7-7zm0 11c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3z"/></svg>',
                                iconSize: [30, 30],
                                iconAnchor: [15, 30]
                            })
                        }).addTo(mapa).bindPopup("¡Estás aquí!");
                        mapa.setView(userLocation, 17);
                    }

                    if (progreso.actual < obtenerPreguntas().length) {
                        const preguntaActual = obtenerPreguntas()[progreso.actual];
                        const preguntaId = `pregunta_${progreso.actual}`;
                        const preguntaLocation = L.latLng(preguntaActual.coords);
                        const distance = userLocation.distanceTo(preguntaLocation);

                        if (preguntaActual.marker && !mapa.hasLayer(preguntaActual.marker)) {
                            preguntaActual.marker.setOpacity(1).addTo(mapa);
                        }
                        actualizarVisibilidadMarcadorActual();

                        const preguntaYaActivada = (progreso.intentos[preguntaId] !== undefined);

                        if (distance <= ACTIVATION_RADIUS && !ventanaPregunta.classList.contains('mostrar') && !preguntaYaActivada && !ventanaFelicitacion.classList.contains('mostrar')) {
                            reproducirAlarma();
                            progreso.intentos[preguntaId] = 0;
                            if (preguntaActual.marker.options.interactive) {
                                preguntaActual.marker.closeTooltip();
                                preguntaActual.marker.options.interactive = false;
                            }
                            mapa.setView(preguntaLocation, 17);
                            mostrarPregunta(progreso.actual);
                            crearModalPersonalizado("¡Pregunta Activa!", "Estás en el lugar de la próxima pregunta. ¡Responde!", [{
                                texto: "OK"
                            }]);
                        } else if (distance > ACTIVATION_RADIUS) {
                            if (preguntaActual.marker.options.interactive) {
                                preguntaActual.marker.options.interactive = false;
                                preguntaActual.marker.closeTooltip();
                            }
                        }
                    }
                },
                (err) => {
                    console.error(`ERROR(${err.code}): ${err.message}`);
                    crearModalPersonalizado(
                        "Error de Geolocalización",
                        `No se pudo obtener tu ubicación: ${err.message}. Verifica los permisos.`,
                        [{
                            texto: "Cerrar"
                        }]
                    );
                    if (ubicacionWatchId !== null) {
                        navigator.geolocation.clearWatch(ubicacionWatchId);
                        ubicacionWatchId = null;
                    }
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
            actualizarVisibilidadMarcadorActual();
        }

        function actualizarPanelProgreso() {
            const totalPreguntas = obtenerPreguntas().length;
            const porcentaje = totalPreguntas > 0 ? Math.round((progreso.actual / totalPreguntas) * 100) : 0;
            document.getElementById("progreso-porcentaje").style.width = porcentaje + "%";
            document.getElementById("progreso-texto").textContent =
                `${progreso.actual} / ${totalPreguntas} preguntas respondidas - Puntaje: ${progreso.puntaje} / ${totalPreguntas * 3}`;
        }

        function reiniciarTrivia() {
            crearModalPersonalizado(
                "Reiniciar Trivia",
                "¿Estás seguro que querés reiniciar tu progreso? Se perderá todo.",
                [{
                    texto: "Sí, reiniciar",
                    clase: "boton-negacion",
                    callback: () => location.reload()
                },
                {
                    texto: "No, continuar",
                    clase: "boton-confirmacion"
                }
                ]
            );
        }

        function mostrarVentanaFinal() {
            const totalPreguntas = obtenerPreguntas().length;
            document.getElementById("puntaje-final").textContent = `${progreso.puntaje} / ${totalPreguntas * 3}`;
            const porcentajeScore = totalPreguntas > 0 ? progreso.puntaje / (totalPreguntas * 3) : 0;
            let mensaje = "";
            if (porcentajeScore < 0.4) mensaje = "Debes estudiar más de la fauna y flora de nuestro parque. ¡Vuelve a intentarlo!";
            else if (porcentajeScore <= 0.6) mensaje = "Tienes conocimientos básicos de nuestra flora y fauna. ¡Puedes esforzarte un poco más!";
            else if (porcentajeScore <= 0.89) mensaje = "Tienes muy buenos conocimientos del parque. ¡Un poco más de estudio y lo aprenderás todo!";
            else mensaje = "¡Eres un experto conocedor del Parque Francisco Tau!";

            document.getElementById("mensaje-final").textContent = mensaje;
            ventanaFinal.classList.add("mostrar");
            document.getElementById("boton-cerrar-final").focus();

            if (ubicacionWatchId !== null) {
                navigator.geolocation.clearWatch(ubicacionWatchId);
                ubicacionWatchId = null;
            }
            if (currentQuestionRadiusCircle) {
                mapa.removeLayer(currentQuestionRadiusCircle);
                currentQuestionRadiusCircle = null;
            }
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
        }

        function cerrarVentanaFinal() {
            ventanaFinal.classList.remove("mostrar");
        }

        function accionMostrarUbicacion() {
            if (marcadorUbicacion && mapa.hasLayer(marcadorUbicacion)) {
                mapa.setView(marcadorUbicacion.getLatLng(), 17);
                marcadorUbicacion.openPopup();
            } else if (!ubicacionWatchId) {
                iniciarSeguimientoUbicacion();
                crearModalPersonalizado("Ubicación", "Iniciando seguimiento de ubicación para mostrarte en el mapa.", [{
                    texto: "OK"
                }]);
            } else {
                crearModalPersonalizado("Ubicación", "Esperando señal de GPS para mostrar tu ubicación...", [{
                    texto: "OK"
                }]);
            }
        }

        function toggleSonido() {
            sonidoActivado = !sonidoActivado;
            if (sonidoActivado) {
                iconSoundOn.style.display = 'inline-block';
                iconSoundOff.style.display = 'none';
            } else {
                iconSoundOn.style.display = 'none';
                iconSoundOff.style.display = 'inline-block';
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                }
            }
            crearModalPersonalizado("Sonido", `Sonido ${sonidoActivado ? 'activado' : 'desactivado'}.`, [{
                texto: "OK"
            }]);
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            supportsWebP = await checkWebPSupport();
            
            // Inicializar el chatbot de n8n
            createChat({
                webhookUrl: 'https://n8n.efficienza.es/webhook/8173e5e9-1b3c-445f-9beb-d0f5360d7ba4/chat',
                webhookConfig: {
                    method: 'POST',
                    headers: {}
                },
                target: '#n8n-chat',
                mode: 'window',
                chatInputKey: 'chatInput', // El campo esperado por el backend para el mensaje del usuario
                chatSessionKey: 'sessionId', // El campo esperado por el backend para el ID de sesión
                metadata: {},
                showWelcomeScreen: false,
                defaultLanguage: 'es',
                initialMessages: [
                    '¡Hola! Soy tu Guarda parque Virtual. Escribe tu mensaje en la barra de abajo.'
                ],
                i18n: {
                    es: {
                        title: 'Guarda parque Virtual',
                        subtitle: "Inicia una conversación. Estamos aquí para ayudarte.",
                        footer: '',
                        getStarted: 'Nueva Conversación',
                        inputPlaceholder: 'Escribe tu mensaje..',
                    },
                },
            });

            document.querySelectorAll('#botones-edad button').forEach(button => {
                button.addEventListener('click', function () {
                    seleccionarEdad(this.dataset.edad);
                });
            });

            document.getElementById('boton-comenzar-instrucciones').addEventListener('click', cerrarVentanaInstrucciones);
            document.getElementById('boton-reiniciar').addEventListener('click', reiniciarTrivia);
            document.getElementById('boton-mostrar-ubicacion').addEventListener('click', accionMostrarUbicacion);
            document.getElementById('boton-cerrar-final').addEventListener('click', cerrarVentanaFinal);
            botonToggleSonido.addEventListener('click', toggleSonido);

            // Show welcome window on load (no audio playback here directly)
            if (ventanaBienvenida) {
                ventanaBienvenida.classList.add("mostrar");
                // The audio for this welcome message will now be triggered by selecting an age.
            } else {
                console.error('Error: Element with ID "ventana-bienvenida" not found.');
            }

            // Focus the first age button
            const primerBotonEdad = document.querySelector('#botones-edad button');
            if (primerBotonEdad) {
                primerBotonEdad.focus();
            }
        });
    </script>

</body>

</html>












